<!DOCTYPE html>
<html lang="bn">

<head>
    <!-- AGGRESSIVE CLIENT-SIDE SECURITY LAYER -->
    <script>
        (function () {
            'use strict';

            // --- Input Blocking ---
            // Block right-click, F12, Ctrl+U, Ctrl+S, Ctrl+P, Ctrl+F
            const blockEvents = (e) => {
                if (e.keyCode === 123 || // F12
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
                    (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
                    (e.ctrlKey && e.keyCode === 83) || // Ctrl+S
                    (e.ctrlKey && e.keyCode === 80) || // Ctrl+P
                    (e.ctrlKey && e.keyCode === 70) || // Ctrl+F
                    (e.ctrlKey && e.keyCode === 67)) { // Ctrl+C
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            };

            document.addEventListener('contextmenu', e => { e.preventDefault(); }, { capture: true });
            document.addEventListener('keydown', blockEvents, { capture: true });

            // --- Asset Protection ---
            // Disable text selection and image drag-and-drop via CSS
            const style = document.createElement('style');
            style.innerHTML = `
                * {
                    -webkit-user-select: none !important;
                    -moz-user-select: none !important;
                    -ms-user-select: none !important;
                    user-select: none !important;
                    -webkit-touch-callout: none !important;
                }
                img {
                    -webkit-user-drag: none !important;
                    -khtml-user-drag: none !important;
                    -moz-user-drag: none !important;
                    -o-user-drag: none !important;
                    user-drag: none !important;
                    pointer-events: none !important;
                }
                a, button, input, textarea, select {
                    pointer-events: auto !important;
                }
            `;
            document.head.appendChild(style);

            // Set draggable attribute to false for all images
            const disableImageDrag = () => {
                document.querySelectorAll('img').forEach(img => {
                    img.setAttribute('draggable', 'false');
                });
            };
            // Run on DOM load and observe for new images
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', disableImageDrag);
            } else {
                disableImageDrag();
            }
            const observer = new MutationObserver(disableImageDrag);
            observer.observe(document.body, { childList: true, subtree: true });


            // --- Console Clearing & Warning ---
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            const originalInfo = console.info;
            const originalTable = console.table;

            const clearAndWarn = () => {
                console.clear();
                console.log('%c', 'font-size:1px;');
                console.warn('%c⚠️ SECURITY WARNING ⚠️', 'color: red; font-size: 40px; font-weight: bold; -webkit-text-stroke: 1px black;');
                console.warn('%cThis is a private computer system. Unauthorized access is strictly prohibited.', 'color: orange; font-size: 16px; font-weight: bold;');
                console.warn('%cAll activities on this site are being monitored and recorded.', 'color: orange; font-size: 16px; font-weight: bold;');
                console.warn('%cAny attempt to copy, reproduce, or reverse-engineer the content or source code will be prosecuted to the fullest extent of the law.', 'color: red; font-size: 14px;');
            };

            clearAndWarn();

            // Override console methods to show warning periodically
            setInterval(clearAndWarn, 5000);

            // --- DevTools Trap ---
            // This will cause an infinite loop in the console, freezing the browser tab if DevTools are opened.
            setInterval(() => {
                (function () {
                    var dummy = /./;
                    dummy.toString = function () {
                        clearAndWarn();
                        return 'SECURITY VIOLATION: DevTools access is blocked.';
                    };
                    console.log(dummy);
                })();
                debugger;
            }, 200);

        })();
    </script>
    <!-- END OF SECURITY LAYER -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSC Study Tracker - Professional Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e293b;
            --accent: #38bdf8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
        }

        html {
            background-color: #f1f5f9;
        }

        html.dark {
            background-color: #0f172a;
        }

        body.dark {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        body.dark .sub-box,
        body.dark .mini-box {
            color: #ffffff;
        }

        body.dark #paper-perc-text,
        body.dark #global-perc-text,
        body.dark .subject-btn,
        body.dark .leader-row div[style*="color:var(--primary)"] {
            color: #ffffff !important;
        }

        body.dark .summary-item h5 {
            color: #ffffff !important;
        }

        #profile-modal-title {
            color: var(--primary);
        }

        body.dark #profile-modal-title {
            color: #ffffff !important;
        }

        #timer-subject-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--primary);
            transition: 0.3s;
        }

        body.dark #timer-subject-name {
            color: #ffffff !important;
        }

        @media (max-width: 600px) {
            #timer-subject-name {
                font-size: 1.5rem;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hind Siliguri', 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            transition: 0.2s;
            line-height: 1.6;
            overflow-x: hidden;
        }

        #page-loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 999999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.6s ease, visibility 0.6s;
        }

        .loader {
            --c: no-repeat linear-gradient(#ef4444 0 0);
            background:
                var(--c), var(--c), var(--c),
                var(--c), var(--c), var(--c),
                var(--c), var(--c), var(--c);
            background-size: 16px 16px;
            animation:
                l32-1 1s infinite,
                l32-2 1s infinite;
            margin: 0 auto;
            display: block;
        }

        @keyframes l32-1 {

            0%,
            100% {
                width: 45px;
                height: 45px
            }

            35%,
            65% {
                width: 65px;
                height: 65px
            }
        }

        @keyframes l32-2 {

            0%,
            40% {
                background-position: 0 0, 0 50%, 0 100%, 50% 100%, 100% 100%, 100% 50%, 100% 0, 50% 0, 50% 50%
            }

            60%,
            100% {
                background-position: 0 50%, 0 100%, 50% 100%, 100% 100%, 100% 50%, 100% 0, 50% 0, 0 0, 50% 50%
            }
        }

        #app {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #app.visible {
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 15px;
            width: 100%;
        }

        .auth-screen {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .auth-card h2 {
            margin-bottom: 25px;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .input-group {
            text-align: left;
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            outline: none;
            background: var(--card-bg);
            color: var(--text-main);
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 10px;
            transition: 0.1s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 100%;
            padding: 12px;
            margin-top: 10px;
        }



        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .summary-modal-content {
            max-width: 800px !important;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
            padding: 50px 20px 20px 20px;
        }

        @keyframes slideIn {
            0% {
                transform: translateY(-50px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .modal h2 {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .modal input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            background: var(--bg);
            color: var(--text-main);
        }

        .modal button {
            padding: 12px;
            background-color: #2563eb;
            color: white;
            border-radius: 6px;
            width: 100%;
            margin-top: 15px;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-profile img {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            object-fit: cover;
        }

        .header-profile h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        @media (max-width: 600px) {
            .header-profile h2 {
                font-size: 0.9rem;
            }

            .header-profile img {
                width: 32px;
                height: 32px;
            }

            header {
                padding: 12px 15px;
            }
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .menu-trigger,
        .notif-trigger {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 20px;
            width: 45px;
            height: 45px;
        }

        .menu-trigger:hover,
        .notif-trigger:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-btns {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .notif-trigger {
            position: relative;
        }

        .notif-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--primary);
            display: none;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            border-radius: 12px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dropdown-content button {
            color: var(--text-main);
            padding: 12px 16px;
            width: 100%;
            border-radius: 0;
            background: transparent;
            justify-content: flex-start;
            font-size: 14px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dropdown-content button:last-child {
            border-bottom: none;
        }

        .dropdown-content button:hover {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .dropdown-content .logout-item:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .show {
            display: block !important;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: row;
                gap: 15px;
                text-align: left;
            }
        }

        @media (min-width: 901px) {
            #leaderboard-list {
                max-height: 550px;
                overflow-y: auto;
                padding-right: 8px;
            }

            #leaderboard-list::-webkit-scrollbar {
                width: 5px;
            }

            #leaderboard-list::-webkit-scrollbar-track {
                background: transparent;
            }

            #leaderboard-list::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 10px;
            }
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
        }

        .subject-btn {
            background: var(--bg);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2.5px solid var(--primary);
            transition: 0.1s;
            position: relative;
            overflow: hidden;
            font-size: 14px;
        }

        .profile-boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .profile-card {
            background: var(--bg);
            padding: 20px 10px;
            border-radius: 15px;
            border: 2.5px solid var(--primary);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .profile-card img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .profile-card h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
        }

        .study-subject-container {
            margin-top: 20px;
            padding: 20px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: 15px;
            border: 1px dashed var(--primary);
        }

        .admin-action-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #3b82f6;
            overflow: hidden;
            width: 180px;
            /* Balanced square width */
            height: 180px;
            /* Balanced square height */
            flex-shrink: 0;
        }

        .admin-action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.2) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 0;
        }

        .admin-action-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
            border-color: #2563eb;
        }

        .admin-action-card:hover::before {
            opacity: 1;
        }

        .admin-action-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .admin-action-card:hover .admin-action-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .admin-action-text {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
            position: relative;
            z-index: 1;
            line-height: 1.4;
        }

        .admin-action-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            /* Red color for 'New' badge */
            color: white;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.4);
            z-index: 1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .study-subject-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
        }

        .study-sub-box {
            padding: 15px 10px;
            border-radius: 12px;
            background: var(--card-bg);
            border: 3px solid var(--primary);
            color: var(--primary);
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            transition: 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            width: calc(50% - 12px);
            min-width: 130px;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        @media (min-width: 768px) {
            .study-sub-box {
                width: calc(23.5% - 12px);
            }
        }

        .study-sub-box:hover {
            background: var(--primary);
            color: #fff;
            transform: translateY(-3px) translateZ(0);
        }

        body.dark .study-sub-box {
            color: #ffffff;
            background: var(--secondary);
            border-color: var(--primary);
        }

        body.dark .study-sub-box:hover {
            background: var(--primary);
        }

        .subject-btn:hover {
            background: var(--card-bg);
            transform: scale(1.02) translateZ(0);
        }

        .subject-btn.active {
            background: var(--primary);
            color: white !important;
        }

        .prog-mini-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: var(--accent);
            transition: 0.1s;
        }

        .syllabus-area {
            margin-top: 20px;
        }

        .paper-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 16px;
            background: var(--card-bg);
            border: 2.5px solid var(--primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-main);
            transition: background 0.05s, color 0.05s, transform 0.05s;
            font-weight: 700;
            touch-action: manipulation;
            user-select: none;
        }

        .tab.active {
            background: var(--primary) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            transform: scale(0.98);
        }

        ul.chapter-list {
            list-style: none;
            margin-top: 15px;
        }

        ul.chapter-list li {
            background: var(--bg);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sub-check-group {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .sub-box {
            width: 30px;
            height: 30px;
            border: 2.5px solid var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.05s;
            user-select: none;
            background: var(--card-bg);
            color: var(--primary);
            line-height: 0;
            padding-top: 3px;
        }

        .sub-box.checked {
            background: var(--primary);
            color: white;
        }

        .main-ch-check {
            transform: scale(1.2);
            accent-color: var(--success);
            cursor: pointer;
        }

        .summary-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--primary);
            cursor: pointer;
            position: relative;
            width: 100%;
        }

        .summary-item h5 {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--danger);
            z-index: 10;
        }

        .chapter-detail-box {
            margin-top: 12px;
            padding: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 8px;
        }

        body.dark .chapter-detail-box {
            background: rgba(0, 0, 0, 0.2);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            gap: 10px;
        }

        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .ch-name-small {
            font-size: 12px;
            font-weight: 500;
            flex: 1;
            line-height: 1.3;
        }

        .mini-check-group {
            display: flex;
            gap: 3px;
        }

        .mini-box {
            width: 22px;
            height: 22px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            background: var(--card-bg);
            color: var(--primary);
            line-height: 0;
            padding-top: 2px;
        }

        .mini-box.active {
            background: var(--primary);
            color: white;
        }

        @media (max-width: 650px) {
            .subjects-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .summary-modal-content {
                padding: 45px 15px 15px 15px;
            }

            .ch-name-small {
                font-size: 11px;
            }

            .mini-box {
                width: 19px;
                height: 19px;
                font-size: 8px;
            }

            .tab {
                padding: 10px 12px;
                font-size: 12px;
                flex: 1;
                text-align: center;
            }
        }

        .leader-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: 0.1s;
        }

        .leader-row:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .leader-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leader-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .online {
            background: var(--success);
            box-shadow: 0 0 5px var(--success);
        }

        .offline {
            background: var(--text-muted);
        }

        .global-progress {
            margin-bottom: 20px;
        }

        .progress-container {
            background: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: 0.2s;
        }

        .banned-screen {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .search-container {
            position: relative;
            flex: 1;
            margin-left: 15px;
        }

        .search-container input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border-radius: 10px;
            border: 1.5px solid var(--primary);
            background: var(--bg);
            color: var(--text-main);
            font-size: 13px;
            outline: none;
            transition: 0.2s;
        }

        .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 14px;
        }

        .search-container input:focus {
            box-shadow: 0 0 8px rgba(37, 99, 235, 0.2);
        }

        .admin-action-btns {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .admin-action-btns button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
        }

        .btn-ban {
            background: var(--warning);
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .approval-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: left;
        }

        .approval-info h4 {
            font-size: 14px;
            margin: 0;
        }

        .approval-info p {
            font-size: 11px;
            color: var(--text-muted);
        }

        .approval-btns {
            display: flex;
            gap: 5px;
        }

        .btn-approve-small {
            background: var(--success);
            color: white;
            padding: 6px 12px;
            font-size: 11px;
        }

        .btn-del-small {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            font-size: 11px;
        }

        #study-timer-view {
            text-align: center;
            padding: 30px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: auto;
        }

        .timer-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin-bottom: 25px;
        }

        @media (max-width: 400px) {
            .timer-circle-container {
                width: 240px;
                height: 240px;
            }

            .timer-center {
                width: 190px !important;
                height: 190px !important;
            }

            .timer-center h1 {
                font-size: 28px !important;
            }
        }

        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-bg {
            fill: none;
            stroke: var(--bg);
            stroke-width: 10;
        }

        .timer-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 848;
            stroke-dashoffset: 848;
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
        }

        .timer-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            background: var(--card-bg);
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 5px solid var(--primary);
            transition: 0.3s;
            backface-visibility: hidden;
        }

        .timer-center:hover {
            transform: translate(-50%, -50%) scale(1.03) translateZ(0);
        }

        .timer-center h1 {
            font-size: 38px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .timer-center span {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            color: var(--text-muted);
        }

        .timer-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }

        .alarm-input-group {
            display: flex;
            background: var(--bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1.5px solid var(--primary);
        }

        .alarm-input-group input {
            flex: 1;
            border: none;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background: transparent;
            color: var(--text-main);
            outline: none;
        }

        .alarm-input-group span {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            font-size: 12px;
            font-weight: bold;
        }

        @keyframes blink-danger {

            0%,
            100% {
                background-color: var(--card-bg);
                border-color: var(--primary);
            }

            50% {
                background-color: #fecaca;
                border-color: var(--danger);
            }
        }

        .danger-mode .timer-center {
            animation: blink-danger 0.5s infinite;
        }

        .danger-mode .timer-progress {
            stroke: var(--danger) !important;
        }

        .danger-overlay {
            position: fixed;
            inset: 0;
            background: rgba(239, 68, 68, 0.4);
            z-index: 99999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 800;
            font-size: 4rem;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .danger-text-blink {
            animation: opacity-blink 0.4s infinite alternate;
        }

        @keyframes opacity-blink {
            from {
                opacity: 1;
            }

            to {
                opacity: 0.3;
            }
        }

        /* New Styles for Time Filter Buttons */
        .time-filter-container {
            display: none;
            /* Hidden by default in normal mode */
            flex-direction: row;
            gap: 5px;
            margin-top: 15px;
            margin-bottom: 15px;
            background: var(--bg);
            padding: 5px;
            border-radius: 8px;
        }

        .time-filter-btn {
            flex: 1;
            font-size: 10px;
            padding: 6px 4px;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            background: transparent;
            color: var(--primary);
            text-align: center;
            white-space: nowrap;
        }

        .time-filter-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* --- NEW STYLES FOR SUMMARY MODAL --- */
        /* Teacher Panel Container for Left Alignment */
        #teacher-panel {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            /* Align content to the left */
        }

        .admin-section {
            width: 100%;
        }

        .admin-action-grid {
            display: flex;
            flex-direction: row;
            /* Horizontal on Desktop */
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            width: 100%;
            max-width: 1000px;
            margin: 20px auto 30px auto;
        }

        @media (max-width: 768px) {
            .admin-action-grid {
                flex-direction: column;
                /* Vertical on Mobile */
                align-items: center;
                gap: 15px;
            }

            .admin-action-card {
                width: 220px;
                /* Better size for mobile centered stack */
                height: 180px;
            }
        }

        .summary-mode-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .summary-mode-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        /* FIXED: Active State for Summary Buttons */
        .summary-mode-btn.active {
            background: var(--primary) !important;
            color: white !important;
        }

        /* Dark mode compatibility for non-active state (keep text visible) */
        body.dark .summary-mode-btn {
            color: var(--text-main);
            /* White text in dark mode */
            background: var(--card-bg);
            border-color: var(--primary);
        }

        .time-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--bg);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        body.dark .stat-value {
            color: var(--primary);
        }

        body.dark .stat-label {
            color: #ccc;
        }

        /* --- FIXED STYLES FOR TIME FILTERS (GRID & COLORS) --- */
        .time-filter-pills {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .time-filter-pills {
                gap: 6px;
            }
        }

        .time-pill {
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            /* Normal Mode: Blue */
            cursor: pointer;
            text-align: center;
            background: transparent;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            white-space: nowrap;
            min-width: calc(25% - 6px);
            max-width: calc(25% - 6px);
        }

        @media (max-width: 480px) {
            .time-pill {
                padding: 6px 8px;
                font-size: 10px;
                min-width: calc(50% - 3px);
                max-width: calc(50% - 3px);
            }
        }

        .time-pill.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Dark Mode Override */
        body.dark .time-pill {
            color: #ffffff;
            /* Dark Mode: White */
            border-color: var(--primary);
        }

        body.dark .time-pill.active {
            background: var(--primary);
            color: #ffffff;
        }

        /* --- FIXED STYLES FOR SUBJECT LIST (GRID & COLORS) --- */
        .subject-time-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        @media (max-width: 480px) {
            .subject-time-list {
                gap: 6px;
            }
        }

        .subject-time-item {
            background: var(--bg);
            border: 2px solid var(--primary);
            border-radius: 6px;
            padding: 12px 15px;
            display: flex;
            flex-direction: row;
            /* Horizontal layout */
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 480px) {
            .subject-time-item {
                padding: 10px 12px;
                gap: 8px;
            }
        }

        .subject-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--primary);
            /* Normal Mode: Blue */
            text-align: left;
        }

        .subject-time-val {
            font-weight: 700;
            font-size: 12px;
            color: var(--primary);
            /* Normal Mode: Blue */
            text-align: right;
        }

        @media (max-width: 480px) {
            .subject-name {
                font-size: 12px;
            }

            .subject-time-val {
                font-size: 11px;
            }
        }

        /* Dark Mode Override */
        body.dark .subject-name {
            color: #ffffff;
            /* Dark Mode: White */
        }

        body.dark .subject-time-val {
            color: #ffffff;
            /* Dark Mode: White */
        }

        .summary-time-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .summary-time-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Attendance System Styles --- */
        .att-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            background: var(--bg);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .att-date-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid var(--primary);
            outline: none;
            font-family: inherit;
            background: var(--card-bg);
            color: var(--text-main);
        }

        .att-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .att-card {
            background: var(--bg);
            border: 2px solid var(--text-muted);
            border-radius: 8px;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .att-card img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-bottom: 5px;
            object-fit: cover;
            border: 2px solid transparent;
        }

        .att-card span {
            font-size: 12px;
            font-weight: 600;
            line-height: 1.2;
        }

        /* Present State (Green) */
        .att-card.present {
            background: var(--success);
            border-color: var(--success);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(34, 197, 94, 0.3);
        }

        .att-card.present img {
            border-color: white;
        }

        /* Dark Mode Adjustments */
        body.dark .att-controls {
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark .att-card {
            border-color: #475569;
            background: #1e293b;
            color: #cbd5e1;
        }

        body.dark .att-card.present {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        /* --- NEW ADMIN PANEL DESIGN --- */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(37, 99, 235, 0.1);
        }

        .admin-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-title i {
            color: var(--primary);
            font-size: 18px;
        }

        .admin-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
            font-weight: 600;
        }

        .admin-status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .admin-section {
            margin-bottom: 15px;
        }

        .admin-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-stat-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(56, 189, 248, 0.05) 100%);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .admin-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
            border-color: rgba(37, 99, 235, 0.4);
        }

        .admin-stat-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .admin-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
        }

        .admin-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Removed legacy admin-action styles that were conflicting */

        /* Dark mode for admin panel */
        body.dark .admin-stat-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(56, 189, 248, 0.1) 100%);
            border-color: rgba(37, 99, 235, 0.3);
        }

        body.dark .admin-action-card {
            background: #1e293b;
        }

        body.dark .admin-action-count {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark .admin-stat-label {
            color: #94a3b8;
        }

        body.dark .admin-stat-value {
            color: #f1f5f9;
        }

        body.dark .admin-title {
            color: #f1f5f9;
        }

        body.dark .admin-action-text {
            color: #f1f5f9;
        }

        /* --- INACTIVITY SYSTEM STYLES (User Provided) --- */
        /* Main Container */
        .inactivity-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            /* Added padding-top to account for back button */
            padding-top: 20px;
        }

        /* Header Section */
        .inactivity-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 20px;
            margin-bottom: 25px;
            position: relative;
            /* For positioning back button if needed inside */
        }

        .inactivity-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .inactivity-header p {
            font-size: 0.95rem;
            opacity: 0.95;
        }

        @media (max-width: 600px) {
            .inactivity-header h1 {
                font-size: 1.4rem;
            }

            .inactivity-header p {
                font-size: 0.85rem;
            }
        }

        /* Stats Cards Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.total {
            border-color: var(--primary);
        }

        .stat-card.warning {
            border-color: var(--warning);
        }

        .stat-card.danger {
            border-color: var(--danger);
        }

        .stat-card.critical {
            border-color: #991b1b;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card.total .stat-icon {
            color: var(--primary);
        }

        .stat-card.warning .stat-icon {
            color: var(--warning);
        }

        .stat-card.danger .stat-icon {
            color: var(--danger);
        }

        .stat-card.critical .stat-icon {
            color: #991b1b;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Configuration Panel */
        .config-panel {
            background: var(--card-bg);
            padding: 20px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 4px solid var(--primary);
        }

        .config-panel h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .day-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .day-selector label {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .day-selector select {
            padding: 10px 15px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text-main);
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-selector select:hover {
            border-color: var(--accent);
        }

        .day-selector select:focus {
            outline: 2px solid var(--primary);
        }

        .save-config-btn {
            background: var(--success);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-config-btn:hover {
            background: #16a34a;
            transform: scale(1.02);
        }

        /* Filter Section */
        .filter-section {
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: transparent;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text-main);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
        }

        .search-box input:focus {
            outline: 2px solid var(--primary);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-bulk-reminder {
            background: var(--warning);
            color: white;
        }

        .btn-bulk-reminder:hover {
            background: #d97706;
            transform: scale(1.02);
        }

        .btn-export {
            background: var(--primary);
            color: white;
        }

        .btn-export:hover {
            background: #1d4ed8;
            transform: scale(1.02);
        }

        .btn-history {
            background: var(--secondary);
            color: white;
        }

        .btn-history:hover {
            background: #334155;
            transform: scale(1.02);
        }

        /* Students Grid */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }

        @media (max-width: 480px) {
            .students-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Student Card */
        .student-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .student-card:hover {
            transform: translateY(-3px);
        }

        .student-card.warning {
            border-color: var(--warning);
        }

        .student-card.danger {
            border-color: var(--danger);
        }

        .student-card.critical {
            border-color: #991b1b;
        }

        .student-card.warning::before {
            content: '⚠️';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
        }

        .student-card.danger::before {
            content: '🚨';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
        }

        .student-card.critical::before {
            content: '💀';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 5px;
            color: var(--text-main);
        }

        .student-email {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .student-stats {
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-muted);
            font-weight: 600;
        }

        .stat-value {
            font-weight: 700;
        }

        .warning-text {
            color: var(--warning);
        }

        .danger-text {
            color: var(--danger);
        }

        .critical-text {
            color: #991b1b;
        }

        /* Progress Bar */
        .progress-wrapper {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .student-card.warning .progress-fill {
            background: linear-gradient(90deg, var(--warning), #fbbf24);
        }

        .student-card.danger .progress-fill {
            background: linear-gradient(90deg, var(--danger), #f87171);
        }

        .student-card.critical .progress-fill {
            background: linear-gradient(90deg, #991b1b, #b91c1c);
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .card-action-btn {
            flex: 1;
            min-width: 45px;
            padding: 10px;
            border: 2px solid;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .btn-email {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-email:hover {
            background: var(--primary);
            color: white;
        }

        .btn-phone {
            border-color: var(--success);
            color: var(--success);
        }

        .btn-phone:hover {
            background: var(--success);
            color: white;
        }

        .btn-reminder {
            border-color: var(--warning);
            color: var(--warning);
        }

        .btn-reminder:hover {
            background: var(--warning);
            color: white;
        }

        .btn-ban {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-ban:hover {
            background: var(--danger);
            color: white;
        }

        /* --- PROFESSIONAL ATTENDANCE DASHBOARD STYLES --- */
        .pro-att-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 20px;
        }

        .pro-att-header {
            background: var(--primary);
            color: white;
            padding: 30px 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .pro-att-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: transparent;
            animation: none;
        }

        .pro-att-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .pro-att-header p {
            font-size: 0.95rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .pro-att-selector-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .pro-att-date-selector,
        .pro-att-class-selector {
            flex: 1;
            min-width: 200px;
        }

        .pro-att-date-selector label,
        .pro-att-class-selector label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .pro-att-date-selector input,
        .pro-att-class-selector select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text-main);
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: all 0.3s ease;
        }

        .pro-att-action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pro-att-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pro-att-btn-refresh {
            background: var(--accent);
            color: white;
        }

        .pro-att-btn-report {
            background: var(--secondary);
            color: white;
        }

        .pro-att-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .pro-att-stat-card {
            background: var(--card-bg);
            padding: 30px 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px dashed var(--primary);
            position: relative;
            overflow: hidden;
            gap: 10px;
        }

        .pro-att-stat-card:hover {
            transform: none;
        }

        .pro-att-stat-card.total {
            border-color: var(--primary);
        }

        .pro-att-stat-card.present {
            border-color: var(--success);
        }

        .pro-att-stat-card.absent {
            border-color: var(--danger);
        }

        .pro-att-stat-card.percentage {
            border-color: var(--warning);
        }

        .pro-att-stat-icon {
            font-size: 2.2rem;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            line-height: 1;
        }

        .pro-att-stat-card.total .pro-att-stat-icon {
            color: var(--primary);
        }

        .pro-att-stat-card.present .pro-att-stat-icon {
            color: var(--success);
        }

        .pro-att-stat-card.absent .pro-att-stat-icon {
            color: var(--danger);
        }

        .pro-att-stat-card.percentage .pro-att-stat-icon {
            color: var(--warning);
        }

        .pro-att-stat-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1;
        }

        /* Folders */
        .pro-att-folders-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .pro-att-folder-card {
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid transparent;
        }

        .pro-att-folder-card.present {
            border-color: var(--success);
        }

        .pro-att-folder-card.absent {
            border-color: var(--danger);
        }

        .pro-att-folder-header {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .pro-att-folder-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pro-att-folder-card.present .pro-att-folder-title {
            color: var(--success);
        }

        .pro-att-folder-card.absent .pro-att-folder-title {
            color: var(--danger);
        }

        .pro-att-folder-content {
            padding: 25px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }

        .pro-att-student-card {
            background: var(--bg);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            border: 2px solid transparent;
        }

        .pro-att-student-card:hover {
            border-color: var(--primary);
        }

        .pro-att-bottom-actions {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
        }

        /* Responsive Adjustments for Professional Attendance */
        @media (max-width: 768px) {
            .pro-att-container {
                padding: 15px;
            }

            .pro-att-header {
                padding: 25px 20px;
            }

            .pro-att-selector-section {
                flex-direction: column;
                align-items: stretch;
            }

            .pro-att-action-buttons {
                justify-content: center;
            }

            .pro-att-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .pro-att-folders-container {
                grid-template-columns: 1fr;
            }

            .pro-att-bottom-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Search Input Animation */
        .folder-search {
            padding: 5px 10px;
            border: 1px solid var(--primary);
            border-radius: 5px;
            font-size: 0.8rem;
            width: 150px;
            transition: all 0.3s ease;
        }

        .folder-search.hidden {
            width: 0;
            padding: 0;
            border: none;
            opacity: 0;
        }

        .folder-icon-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s;
        }

        .folder-icon-btn:hover {
            color: var(--primary);
        }

        /* Report Graph */
        .report-graph-bar {
            background: var(--primary);
            border-radius: 5px;
            transition: width 1s ease;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 5px;
            color: white;
            font-size: 10px;
            min-width: 30px;
        }

        /* History List Hover */
        .history-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        /* Detailed Breakdown Styles */
        .pro-att-breakdown {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid var(--primary);
            animation: slideDown 0.4s ease-out;
            overflow: hidden;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .breakdown-header h4 {
            font-size: 1.1rem;
            color: var(--text-main);
            font-weight: 700;
        }

        .breakdown-tabs {
            display: flex;
            background: var(--bg);
            padding: 5px;
            border-radius: 12px;
            gap: 5px;
        }

        .breakdown-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breakdown-tab.active {
            background: var(--card-bg);
            color: var(--primary);
        }

        .breakdown-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .breakdown-student-card {
            background: var(--bg);
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .breakdown-student-card:hover {
            transform: scale(1.02);
        }

        .breakdown-student-card img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .breakdown-student-info h5 {
            font-size: 0.95rem;
            margin-bottom: 2px;
            font-weight: 700;
        }

        .breakdown-student-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        @media (max-width: 600px) {
            .breakdown-header {
                flex-direction: column;
                align-items: stretch;
            }

            .breakdown-tabs {
                justify-content: stretch;
            }

            .breakdown-tab {
                flex: 1;
                justify-content: center;
            }
        }

        /* Percentage Breakdown Specifics */
        .percent-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .percent-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .percent-card-header {
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .percent-card.male .percent-card-header i {
            color: var(--primary);
        }

        .percent-card.female .percent-card-header i {
            color: #ec4899;
        }

        .percent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .percent-item span {
            min-width: 60px;
            font-weight: 600;
        }

        .percent-bar-bg {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .percent-bar {
            height: 100%;
            transition: width 0.5s ease;
        }

        .percent-bar.present {
            background: var(--success);
        }

        .percent-bar.absent {
            background: var(--danger);
        }

        .percent-val {
            font-weight: 800;
            color: var(--text-main);
            min-width: 40px;
            text-align: right;
        }

        @media (max-width: 768px) {
            .percent-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Lifetime Report Grid & Premium Cards */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 25px;
            padding: 10px;
            overflow: visible;
            max-height: none;
        }

        .report-hero-section {
            background: rgba(37, 99, 235, 0.08);
            border-radius: 24px;
            padding: 20px 25px;
            margin-bottom: 35px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: visible;
            border: 2px dashed var(--primary);
            width: 100%;
            min-height: 80px;
        }

        /* Professional Morphing Search Bar */
        .report-search-wrapper {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
        }

        .search-container-v2 {
            display: flex;
            align-items: center;
            background: rgba(37, 99, 235, 0.15);
            border: 1px solid var(--primary);
            border-radius: 30px;
            padding: 4px;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 42px;
            height: 42px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: none !important;
        }

        .search-container-v2.active {
            width: 280px;
            background: rgba(37, 99, 235, 0.18);
            cursor: default;
            box-shadow: none !important;
            border-style: solid;
        }

        .search-input-v2 {
            background: none;
            border: none;
            outline: none;
            color: var(--text-main);
            padding: 0;
            width: 0;
            opacity: 0;
            transition: all 0.4s ease;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
        }

        .search-container-v2.active .search-input-v2 {
            width: 100%;
            opacity: 1;
            padding: 0 15px;
        }

        .search-btn-v2 {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex-shrink: 0;
            box-shadow: none !important;
        }

        .search-container-v2.active .search-btn-v2 {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .search-btn-v2:hover {
            transform: scale(1.05);
        }

        /* Mobile Adjustments for Search */
        @media (max-width: 600px) {
            .report-search-wrapper {
                right: 15px;
            }

            .search-container-v2.active {
                width: 180px;
                /* Slimmer on mobile to avoid hitting total classes count */
            }

            .search-input-v2 {
                font-size: 0.8rem;
            }
        }

        body.dark .report-hero-section {
            background: rgba(37, 99, 235, 0.12);
        }

        .report-hero-section::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -10%;
            width: 120%;
            height: 140%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-stat-main {
            z-index: 1;
        }

        .hero-stat-main h2 {
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            opacity: 0.9;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: none;
        }

        .hero-stat-value {
            font-size: clamp(0.6rem, 3.8vw, 2.8rem);
            font-weight: 800;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(5px, 1.5vw, 15px);
            white-space: nowrap;
            width: 100%;
            padding: 0 10px;
            text-shadow: none;
        }

        .hero-stat-value .label-text {
            opacity: 0.9;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-shadow: none;
        }

        .hero-stat-value .value-text {
            color: var(--primary);
            font-weight: 900;
            background: rgba(37, 99, 235, 0.15);
            padding: 4px 12px;
            border-radius: 10px;
            border: 1px solid rgba(37, 99, 235, 0.3);
            text-shadow: none;
        }

        .hero-stat-value .mini-sub {
            font-size: 0.5em;
            opacity: 0.6;
            font-weight: 400;
            margin-left: 8px;
            font-style: auto;
        }

        .hero-icon-box {
            display: none;
        }

        .report-student-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 3px solid var(--primary);
            position: relative;
            transition: none !important;
            /* Force static */
        }

        .report-student-card:hover {
            transform: none !important;
            border-color: var(--primary) !important;
        }

        .report-student-card::after {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .report-card-top {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .report-card-top img {
            width: 70px;
            height: 70px;
            border-radius: 22px;
            object-fit: cover;
            border: 4px solid var(--bg);
        }

        .report-card-name h5 {
            font-size: 1.2rem;
            margin-bottom: 4px;
            font-weight: 800;
            color: var(--text-main);
        }

        .report-card-name p {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: 'Poppins', sans-serif;
        }

        .report-card-stats-v2 {
            display: flex;
            gap: 15px;
        }

        .stat-item-v2 {
            flex: 1;
            padding: 18px;
            border-radius: 14px;
            background: rgba(37, 99, 235, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 2px dashed var(--primary);
            transition: none !important;
        }

        body.dark .stat-item-v2 {
            background: rgba(37, 99, 235, 0.12);
        }

        .report-student-card:hover .stat-item-v2 {
            background: rgba(37, 99, 235, 0.08) !important;
            border: 2px dashed var(--primary) !important;
            transform: none !important;
        }

        body.dark .report-student-card:hover .stat-item-v2 {
            background: rgba(37, 99, 235, 0.12) !important;
        }

        .stat-item-v2 .label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-item-v2 .value {
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
        }

        .stat-item-v2.present .value {
            color: var(--success);
        }

        .stat-item-v2.absent .value {
            color: var(--danger);
        }

        .report-card-progress-v2 {
            margin-top: 5px;
        }

        .progress-header-v2 {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .progress-title-v2 {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .progress-percent-v2 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary);
        }

        .progress-track-v2 {
            height: 12px;
            background: var(--bg);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
        }

        .progress-fill-v2 {
            height: 100%;
            border-radius: 6px;
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .progress-fill-v2.present {
            background: var(--success);
        }

        .progress-fill-v2.absent {
            background: #ef4444;
            /* Vibrant solid red as requested */
            opacity: 1;
            /* Full visibility */
        }

        .growth-indicator {
            margin-top: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--success);
        }

        @media (max-width: 600px) {
            .report-hero-section {
                flex-direction: column;
                text-align: center;
                gap: 20px;
                padding: 30px 20px;
            }

            .hero-stat-value {
                justify-content: center;
            }

            .report-grid {
                grid-template-columns: 1fr;
                padding: 5px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 15px;
            color: var(--success);
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        /* Template Buttons */
        .template-section {
            margin-bottom: 20px;
            text-align: left;
        }

        .template-section h4 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .template-grid {
            display: grid;
            gap: 10px;
        }

        .template-btn {
            padding: 12px 15px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: transparent;
            color: var(--text-main);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .template-btn:hover {
            background: rgba(37, 99, 235, 0.1);
            border-color: var(--accent);
        }

        .template-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Custom Message */
        .custom-message {
            margin-bottom: 20px;
        }

        .custom-message textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text-main);
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            outline: none;
            transition: all 0.3s ease;
        }

        .custom-message textarea:focus {
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        /* Modal Actions */
        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-send {
            background: var(--success);
            color: white;
        }

        .btn-send:hover {
            background: #16a34a;
            transform: scale(1.02);
        }

        .btn-cancel {
            background: var(--text-muted);
            color: white;
        }

        .btn-cancel:hover {
            background: #475569;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 50px 20px;
        }

        .loading-state .loader {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-state p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Toast Notification - Reusing existing toast styles but adding if missing */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(600px);
            transition: transform 0.3s ease;
            z-index: 9999;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.info .toast-icon {
            color: var(--primary);
        }

        .toast-message {
            font-size: 0.9rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .inactivity-container {
                padding: 15px;
            }

            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: center;
            }

            .filter-buttons {
                justify-content: center;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }

        /* Attendance Reset Calendar Modal */
        .reset-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            padding-bottom: 5px;
        }

        .calendar-date {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
            color: var(--text-muted);
            font-family: 'Hind Siliguri', sans-serif;
        }

        .calendar-date:hover:not(.empty) {
            background: rgba(37, 99, 235, 0.1);
            color: var(--text-main);
        }

        .calendar-date.has-data {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        .calendar-date.selected {
            background: var(--danger) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            transform: scale(1.05);
            z-index: 1;
        }

        .calendar-date.today {
            border: 2px solid var(--primary);
        }

        .calendar-date.empty {
            cursor: default;
            background: transparent;
        }

        .reset-modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-reset-confirm {
            flex: 2;
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-reset-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn-reset-cancel {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 480px) {
            .reset-calendar-grid {
                gap: 5px;
                padding: 10px;
            }

            .calendar-date {
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div id="danger-overlay" class="danger-overlay">
        <div class="danger-text-blink">DANGER!</div>
        <div style="font-size: 2rem;">DANGER! DANGER!</div>
    </div>
    <div id="page-loader">
        <div class="loader"></div>
    </div>
    <div id="approvalModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close-modal" onclick="closeApprovalModal()"><i class="fas fa-times-circle"></i></span>
            <h2 style="margin-bottom: 20px;"><i class="fas fa-bell"></i> Pending request</h2>
            <div id="approval-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    <div id="adminConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; padding: 30px;">
            <i id="confirm-icon" class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h2 id="confirm-msg"
                style="font-size: 1.1rem; margin-bottom: 10px; line-height: 1.5; color: var(--text-main);"></h2>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button id="confirm-yes-btn" class="btn-primary" style="flex:1">YES</button>
                <button onclick="closeAdminConfirm()" class="btn-primary"
                    style="background:#e2e8f0; color:#475569; flex:1">NO</button>
            </div>
        </div>
    </div>
    <div id="summaryModal" class="modal">
        <div class="modal-content summary-modal-content">
            <span class="close-modal" onclick="closeSummary()"><i class="fas fa-times-circle"></i></span>
            <div id="summary-header"></div>

            <div class="summary-mode-btns">
                <button class="summary-mode-btn active" id="btn-mode-study-time"
                    onclick="switchSummaryMode('study')">Study time</button>
                <button class="summary-mode-btn" id="btn-mode-subject-time"
                    onclick="switchSummaryMode('subject')">Subject-based study time</button>
            </div>

            <div id="view-study-time" class="summary-time-container active">
                <div class="time-stats-grid">
                    <div class="stat-box">
                        <span class="stat-value" id="stat-24h">00:00:00</span>
                        <span class="stat-label">Last 24 Hours</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="stat-7d">00:00:00</span>
                        <span class="stat-label">Last 7 Days</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="stat-1m">00:00:00</span>
                        <span class="stat-label">Last 1 Month</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="stat-lifetime">00:00:00</span>
                        <span class="stat-label">Lifetime</span>
                    </div>
                </div>
            </div>

            <div id="view-subject-time" class="summary-time-container">
                <div class="time-filter-pills">
                    <div class="time-pill" onclick="filterSubjectTime('24h', this)">24 Hours</div>
                    <div class="time-pill" onclick="filterSubjectTime('7d', this)">7 Days</div>
                    <div class="time-pill" onclick="filterSubjectTime('1m', this)">1 Month</div>
                    <div class="time-pill active" onclick="filterSubjectTime('lifetime', this)">Lifetime</div>
                </div>
                <div id="subject-time-list" class="subject-time-list"></div>
            </div>
            <h4 style="font-size:15px; margin-top: 20px; margin-bottom:12px; color:var(--text-muted)"><i
                    class="fas fa-info-circle"></i> সাবজেক্টে ক্লিক করে বিস্তারিত রিপোর্ট দেখুন</h4>
            <div id="summary-body" class="summary-grid"></div>
            <div id="admin-summary-controls" class="admin-action-btns hidden">
                <button id="summary-ban-btn" class="btn-ban"><i class="fas fa-user-slash"></i> ব্যান করুন</button>
                <button id="summary-del-btn" class="btn-delete"><i class="fas fa-trash-alt"></i> ডিলিট করুন</button>
            </div>
        </div>
    </div>

    <!-- Attendance Reset Calendar Modal -->
    <div id="attendanceResetModal" class="modal">
        <div class="modal-content" style="max-width: 450px; padding: 25px;">
            <div class="modal-header"
                style="justify-content: space-between; margin-bottom: 25px; display: flex; align-items: center; width: 100%;">
                <h3
                    style="font-size: 1.1rem; color: var(--text-main); font-weight: 700; margin: 0; display: flex; align-items: center;">
                    <i class="fas fa-calendar-alt" style="color: var(--danger); margin-right: 10px;"></i>
                    ডাটা রিসেট ক্যালেন্ডার
                </h3>
                <div style="display:flex; gap:12px; align-items:center">
                    <button onclick="selectAllDates()"
                        style="background: rgba(37, 99, 235, 0.1); border: 1px solid var(--primary); color: var(--primary); padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: 700; transition: all 0.2s;">সবগুলো
                        সিলেক্ট</button>
                    <span onclick="closeResetModal()"
                        style="cursor: pointer; font-size: 1.6rem; color: var(--text-muted); line-height: 1; transition: transform 0.2s, color 0.2s; display: flex; align-items: center;"><i
                            class="fas fa-times-circle"></i></span>
                </div>
            </div>

            <div
                style="text-align: center; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 20px;">
                <button onclick="changeResetMonth(-1)"
                    style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1.2rem;"><i
                        class="fas fa-chevron-left"></i></button>
                <h4 id="calendarMonthYear" style="color: var(--text-main); font-weight: 700; min-width: 140px;">
                    ফেব্রুয়ারি ২০২৬</h4>
                <button onclick="changeResetMonth(1)"
                    style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1.2rem;"><i
                        class="fas fa-chevron-right"></i></button>
            </div>
            <p
                style="font-size: 0.8rem; color: var(--text-muted); margin-top: -10px; margin-bottom: 15px; text-align: center;">
                যে তারিখগুলোর ডাটা মুছতে চান সেগুলো সিলেক্ট করুন
            </p>

            <div class="reset-calendar-grid" id="resetCalendarGrid">
                <!-- Calendar content injected here -->
            </div>

            <div id="selectedDatesCount"
                style="text-align: center; font-size: 0.85rem; font-weight: 600; color: var(--danger); margin-bottom: 15px;">
                কোনো তারিখ সিলেক্ট করা হয়নি
            </div>

            <div class="reset-modal-footer" style="flex-wrap: wrap;">
                <button onclick="lifetimeReset()" class="btn-reset-confirm"
                    style="background: var(--warning); color: #000; flex: 1 1 100%; margin-bottom: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> সম্পূর্ণ ইতিহাস মুছে ফেলুন (০ করুন)
                </button>
                <button onclick="closeResetModal()" class="btn-reset-cancel">বন্ধ করুন</button>
                <button id="btnConfirmDelete" onclick="processBatchDelete()" class="btn-reset-confirm" disabled>
                    <i class="fas fa-trash-alt"></i> ডিলিট করুন
                </button>
            </div>
        </div>
    </div>
    <!-- Self Attendance Modal -->
    <div id="selfAttendanceModal" class="modal">
        <div class="modal-content" style="max-width: 400px; padding: 40px 30px;">
            <span class="close-modal" onclick="closeSelfAttendance()"><i class="fas fa-times-circle"></i></span>

            <div id="live-indicator"
                style="display:inline-block; padding:5px 15px; background:rgba(34, 197, 94, 0.1); color:#22c55e; border-radius:30px; font-size:12px; font-weight:700; margin-bottom:20px;">
                <i class="fas fa-circle" style="font-size:8px; margin-right:5px; vertical-align:middle;"></i> LIVE CLASS
            </div>

            <h2 style="font-size:1.4rem; margin-bottom:10px;">আজকের উপস্থিতি</h2>
            <p id="att-session-date" style="color:var(--text-muted); margin-bottom:30px; font-size:1rem;">Loading...</p>

            <button onclick="submitSelfAttendance()" class="btn-primary"
                style="background: var(--success); padding: 15px; font-size: 1.1rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);">
                <i class="fas fa-check-circle"></i> আমি উপস্থিত আছি
            </button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Developed by Md. Pial Hasan, Department of CSE, DIU, Batch-70</h2>
            <form id="loginForm">
                <input type="text" id="username" placeholder="Username" required />
                <input type="password" id="password" placeholder="Password" required />
                <button type="submit">System login</button>
            </form>
        </div>
    </div>
    <div id="logoutModal" class="modal">
        <div class="modal-content" style="max-width: 400px; padding: 30px;">
            <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: var(--danger); margin-bottom: 15px;"></i>
            <h2 style="font-size: 1.1rem; margin-bottom: 10px; line-height: 1.5; color: var(--text-main);">আপনি কি
                স্টাডি ট্র্যাকার ওয়েবসাইট থেকে লগ আউট করতে চান?</h2>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="handleLogout()" class="btn-primary"
                    style="background:var(--danger); flex:1">YES</button>
                <button onclick="closeLogoutModal()" class="btn-primary"
                    style="background:#e2e8f0; color:#475569; flex:1">NO</button>
            </div>
        </div>
    </div>
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: left; padding: 30px;">
            <span class="close-modal" onclick="closeProfileModal()"><i class="fas fa-times-circle"></i></span>
            <h2 id="profile-modal-title" style="text-align: center; margin-bottom: 25px;"><i
                    class="fas fa-user-circle"></i> My Profile</h2>
            <div style="text-align: center; margin-bottom: 25px;">
                <img id="profile-preview" src=""
                    style="width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            </div>
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="edit-name" placeholder="Enter your name">
            </div>
            <div class="input-group">
                <label>Email (Not Changeable)</label>
                <input type="text" id="edit-email" disabled
                    style="background: rgba(0,0,0,0.05); cursor: not-allowed; opacity: 0.7;">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="text" id="edit-pass" placeholder="Enter new password">
            </div>
            <div class="input-group">
                <label>Gender</label>
                <input type="text" id="edit-gender" disabled
                    style="background: rgba(0,0,0,0.05); cursor: not-allowed; opacity: 0.7;">
            </div>
            <button class="btn-primary" onclick="handleUpdateProfile()" style="margin-top: 20px;">Save Changes</button>
        </div>
    </div>
    <div id="app">
        <div id="login-page" class="auth-screen hidden">
            <div class="auth-card">
                <h2><i class="fas fa-user-graduate"></i> লগইন করুন</h2>
                <div class="input-group">
                    <label>ইমেইল অ্যাড্রেস</label>
                    <input type="email" id="login-email" placeholder="example@mail.com">
                </div>
                <div class="input-group">
                    <label>পাসওয়ার্ড</label>
                    <input type="password" id="login-pass" placeholder="••••••••">
                </div>
                <button class="btn-primary" onclick="handleLogin()">লগইন করুন</button>
                <p style="margin-top:20px; font-size: 14px;">অ্যাকাউন্ট নেই? <a href="#"
                        onclick="showPage('register-page')" style="color:var(--primary)">রেজিস্ট্রেশন করুন</a></p>
            </div>
        </div>
        <div id="register-page" class="auth-screen hidden">
            <div class="auth-card">
                <h2><i class="fas fa-edit"></i> রেজিস্ট্রেশন</h2>
                <div class="input-group">
                    <label>সম্পূর্ণ নাম</label>
                    <input type="text" id="reg-name" placeholder="আপনার নাম">
                </div>
                <div class="input-group">
                    <label>ইমেইল</label>
                    <input type="email" id="reg-email" placeholder="email@example.com">
                </div>
                <div class="input-group">
                    <label>পাসওয়ার্ড</label>
                    <input type="password" id="reg-pass" placeholder="পাসওযর্ড দিন">
                </div>
                <div class="input-group">
                    <label>লিঙ্গ (Gender)</label>
                    <select id="reg-gender">
                        <option value="male">ছেলে (Male)</option>
                        <option value="female">মেয়ে (Female)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>আপনি কে?</label>
                    <select id="reg-role">
                        <option value="student">শিক্ষার্থী (Student)</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="handleRegister()">অ্যাকাউন্ট তৈরি করুন</button>
                <button class="btn-outline" onclick="showPage('login-page')">লগইন পেজে ফিরুন</button>
            </div>
        </div>
        <div id="waiting-room-screen" class="auth-screen hidden">
            <div class="auth-card">
                <i class="fas fa-user-clock" style="font-size: 4rem; color: var(--warning); margin-bottom: 20px;"></i>
                <p style="font-size: 15px; line-height: 1.5; margin-bottom: 20px; color: var(--text-main);">You are
                    requested to note that administrative approval is required to visit website. Kindly inbox MD Pial
                    Hasan Sir to request approval.</p>
                <h1 style="color: var(--warning); font-size: 3rem; margin-bottom: 25px; font-weight: 800;">Pending</h1>
                <button class="btn-primary" onclick="handleLogout()"
                    style="max-width: 150px; margin: 0 auto;">লগআউট</button>
            </div>
        </div>
        <div id="dashboard-page" class="hidden">
            <header>
                <div class="header-profile" id="header-user-info">
                    <i class="fas fa-book-open" style="font-size:1.5rem; cursor:pointer;"
                        onclick="toggleStudyMode()"></i>
                    <div id="welcome-text" style="display:flex; align-items:center; gap:10px;"></div>
                </div>
                <div class="nav-btns">
                    <button id="notif-btn" onclick="openApprovalModal()" class="notif-trigger hidden">
                        <i class="fas fa-bell"></i>
                        <span id="notif-dot" class="notif-badge"></span>
                    </button>
                    <div class="dropdown">
                        <button onclick="toggleMenu()" class="menu-trigger"><i class="fas fa-ellipsis-v"></i></button>
                        <div id="dropdown-menu" class="dropdown-content">
                            <button onclick="showPage('activity-monitor-page'); loadActivityMonitor();"><i
                                    class="fas fa-microscope"></i> Study DNA</button>
                            <button onclick="toggleStudyMode()"><i class="fas fa-graduation-cap"></i> স্টাডি
                                মোড</button>
                            <button id="btn-student-attendance" onclick="checkAttendanceSession()"><i
                                    class="fas fa-user-check"></i> অ্যাটেন্ডেন্স
                                দিন</button>
                            <button onclick="openProfileModal()"><i class="fas fa-user-circle"></i> My Profile</button>
                            <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> ডার্ক মোড অন/অফ</button>
                            <button onclick="confirmLogout()" class="logout-item"><i class="fas fa-sign-out-alt"></i>
                                লগআউট করুন</button>
                        </div>
                    </div>
                </div>
            </header>
            <div class="container">
                <div class="card global-progress" id="student-global-progress">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="font-size:16px"><i class="fas fa-chart-line"></i> সিলেবাস অগ্রগতি </h3>
                        <h3 id="global-perc-text" style="color:var(--primary); font-size:18px">0%</h3>
                    </div>
                    <div class="progress-container">
                        <div id="global-progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Admin Panel (Centered at the Top) -->
                <div id="teacher-panel" class="hidden">
                    <div class="admin-section">
                        <div class="admin-action-grid">
                            <!-- Inactivity Card -->
                            <div class="admin-action-card" onclick="showPage('inactivity-page'); loadStudents();">
                                <i class="fas fa-bell admin-action-icon" style="color: var(--warning)"></i>
                                <span class="admin-action-text">Inactivity Warn System</span>
                                <div class="admin-action-count">New</div>
                            </div>

                            <!-- Attendance Card -->
                            <div class="admin-action-card" onclick="showPage('attendance-page'); loadProAttendance();">
                                <i class="fas fa-clipboard-check admin-action-icon" style="color: var(--success)"></i>
                                <span class="admin-action-text">Student Attendance</span>
                                <div class="admin-action-count" style="background:var(--success); color:white">Pro</div>
                            </div>

                            <!-- Payment Card -->
                            <div class="admin-action-card" onclick="showPage('batch-payment-page'); loadPaymentData();">
                                <i class="fas fa-wallet admin-action-icon" style="color: #6366f1"></i>
                                <span class="admin-action-text">Batch Payment Mgmt</span>
                                <div class="admin-action-count" style="background:#6366f1; color:white">Fin</div>
                            </div>

                            <!-- Student Management Card -->
                            <div class="admin-action-card"
                                onclick="showPage('student-management-page'); loadStudentManagement();">
                                <i class="fas fa-users-cog admin-action-icon" style="color: #d946ef"></i>
                                <span class="admin-action-text">Student Management</span>
                                <div class="admin-action-count" style="background:#d946ef; color:white">New</div>
                            </div>

                            <!-- Activity Monitor Card -->
                            <div class="admin-action-card"
                                onclick="showPage('activity-monitor-page'); loadActivityMonitor();">
                                <i class="fas fa-user-clock admin-action-icon" style="color: #f59e0b"></i>
                                <span class="admin-action-text">Activity Monitor</span>
                                <div class="admin-action-count" style="background:#f59e0b; color:white">Live</div>
                            </div>
                        </div>
                    </div>


                </div>


                <div class="dashboard-grid">
                    <div class="left-panel">
                        <div class="card" id="student-tracker-card">
                            <h3 style="margin-bottom:15px; font-size:16px">📘 ট্র্যাকার বোর্ড</h3>
                            <div class="subjects-grid" id="subject-btns"></div>
                            <div id="syllabus-container" class="syllabus-area hidden">
                                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                                <div id="paper-tabs" class="paper-tabs"></div>
                                <div id="chapter-section">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <h4 id="active-title" style="font-size:14px">বিষয় নির্বাচন করুন</h4>
                                            <span id="paper-perc-text"
                                                style="font-size: 12px; font-weight: bold; color: var(--primary); background: var(--bg); padding: 2px 8px; border-radius: 6px;">0%</span>
                                        </div>
                                        <div style="display:flex; gap:5px">
                                            <button onclick="bulkCheck(true)"
                                                style="font-size:10px; padding:4px 8px; background:var(--success); color:white">সব
                                                শেষ</button>
                                            <button onclick="bulkCheck(false)"
                                                style="font-size:10px; padding:4px 8px; background:var(--text-muted); color:white">সব
                                                মুছুন</button>
                                        </div>
                                    </div>
                                    <div class="progress-container" style="height:8px; margin-bottom:15px;">
                                        <div id="paper-progress-fill" class="progress-fill" style="width:0%"></div>
                                    </div>
                                    <ul id="chapter-list" class="chapter-list"></ul>
                                </div>
                            </div>
                        </div>
                        <div id="study-mode-container" class="card hidden">
                            <h3 style="margin-bottom:20px; font-size:16px"><i class="fas fa-graduation-cap"></i> স্টাডি
                                মোড - আমার প্রোফাইল</h3>
                            <div id="study-timer-view" class="hidden">
                                <button onclick="exitStudyTimer()" class="btn-primary"
                                    style="margin-bottom: 20px; background: var(--primary); color: white; width: auto; padding: 10px 25px;"><i
                                        class="fas fa-arrow-left"></i> ফিরে যান</button>
                                <h2 id="timer-subject-name">পদার্থবিজ্ঞান</h2>
                                <div class="timer-circle-container" id="timer-container">
                                    <svg class="timer-svg" viewBox="0 0 300 300">
                                        <circle class="timer-bg" cx="150" cy="150" r="135"></circle>
                                        <circle id="timer-progress-bar" class="timer-progress" cx="150" cy="150"
                                            r="135">
                                        </circle>
                                    </svg>
                                    <div class="timer-center" onclick="toggleTimer()">
                                        <h1 id="timer-digital">00:00:00</h1>
                                        <span id="timer-status-text">START</span>
                                    </div>
                                </div>
                                <div class="timer-controls">
                                    <div class="alarm-input-group">
                                        <span>এলার্ম (মিনিট)</span>
                                        <input type="number" id="alarm-minutes" placeholder="0" min="1">
                                    </div>
                                    <button id="timer-main-btn" onclick="toggleTimer()" class="btn-primary"
                                        style="font-size: 1.1rem; padding: 15px;"><i class="fas fa-play"></i> স্টার্ট
                                        করুন</button>
                                </div>
                            </div>
                            <div id="study-main-content">
                                <div id="study-profile-grid" class="profile-boxes-grid"></div>
                                <div id="study-subjects-section" class="study-subject-container hidden">
                                    <h4
                                        style="margin-bottom:15px; font-size:14px; color:var(--text-muted); text-align:center;">
                                        আপনার প্রগ্রেস দেখতে সাবজেক্ট নির্বাচন করুন</h4>
                                    <div class="study-subject-grid">
                                        <div class="study-sub-box" onclick="enterStudySession('পদার্থবিজ্ঞান')">
                                            পদার্থবিজ্ঞান</div>
                                        <div class="study-sub-box" onclick="enterStudySession('রসায়ন')">রসায়ন</div>
                                        <div class="study-sub-box" onclick="enterStudySession('জীববিজ্ঞান')">জীববিজ্ঞান
                                        </div>
                                        <div class="study-sub-box" onclick="enterStudySession('উচ্চতর গণিত')">উচ্চতর
                                            গণিত</div>
                                        <div class="study-sub-box" onclick="enterStudySession('বাংলা')">বাংলা</div>
                                        <div class="study-sub-box" onclick="enterStudySession('ইংরেজি')">ইংরেজি</div>
                                        <div class="study-sub-box" onclick="enterStudySession('ICT')">ICT</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="right-panel">
                        <div class="card" id="leaderboard-card">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h4 style="font-size:15px; white-space: nowrap;">🏆 লিডারবোর্ড</h4>
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="leaderboard-search" oninput="renderLeaderboard()"
                                        placeholder="নাম খুঁজুন...">
                                </div>
                            </div>
                            <div class="time-filter-container" id="time-filter-container">
                                <button class="time-filter-btn active" onclick="setLeaderboardFilter('24h', this)">24
                                    Hours</button>
                                <button class="time-filter-btn" onclick="setLeaderboardFilter('7d', this)">7
                                    Days</button>
                                <button class="time-filter-btn" onclick="setLeaderboardFilter('1m', this)">1
                                    Month</button>
                                <button class="time-filter-btn"
                                    onclick="setLeaderboardFilter('lifetime', this)">Lifetime</button>
                            </div>
                            <div id="leaderboard-list"></div>
                        </div>


                    </div>
                </div>
            </div>
        </div>

        <!-- Student Activity Monitor Page -->
        <div id="activity-monitor-page" class="hidden">
            <div class="container" style="max-width: 1250px; padding: 10px;">
                <button onclick="showPage('dashboard-page')" class="btn-primary"
                    style="margin-bottom: 20px; width: auto; padding: 10px 20px; background: var(--primary); border:none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);">
                    <i class="fas fa-arrow-left"></i> ড্যাশবোর্ডে ফিরে যান
                </button>

                <div class="monitor-layout">
                    <!-- Sidebar: Student List -->
                    <div class="monitor-sidebar card">
                        <h4><i class="fas fa-users"></i> শিক্ষার্থীদের তালিকা</h4>
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="monitor-search" oninput="renderMonitorStudentList()"
                                placeholder="নাম বা আইডি খুঁজুন...">
                        </div>
                        <div id="monitor-student-list" class="monitor-list-container">
                            <!-- Students will be rendered here -->
                        </div>
                    </div>

                    <!-- Main Content: Activity Details -->
                    <div id="monitor-details" class="monitor-main card">
                        <div id="monitor-placeholder"
                            style="text-align: center; padding: 60px 20px; color: var(--text-muted); height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <i class="fas fa-user-clock"
                                style="font-size: 5rem; margin-bottom: 25px; opacity: 0.2; color: var(--primary);"></i>
                            <h3 style="color: var(--text-main);">প্রোফাইল নির্বাচন করুন</h3>
                            <p style="max-width: 300px; margin-top: 10px;">শিক্ষার্থীদের বিস্তারিত কার্যক্রম এবং
                                প্রগ্রেস দেখতে বাম পাশের তালিকা থেকে একজনকে নির্বাচন করুন।</p>
                        </div>
                        <div id="monitor-content" class="hidden">
                            <!-- Detailed activity content will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* Batch Payment Specific Styles */
            .payment-container {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .payment-header-v2 {
                background: var(--primary);
                color: white;
                padding: 30px 25px;
                border-radius: 20px;
                margin-bottom: 25px;
                box-shadow: 0 10px 25px rgba(37, 99, 235, 0.2);
            }

            .payment-header-content h1 {
                font-size: 1.8rem;
                margin-bottom: 5px;
            }

            .payment-tools-section {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                background: var(--card-bg);
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 25px;
                gap: 15px;
                flex-wrap: wrap;
                border: 1px solid var(--border);
            }

            .selector-group {
                display: flex;
                gap: 15px;
                flex: 1;
            }

            .tool-item {
                display: flex;
                flex-direction: column;
                gap: 8px;
                flex: 1;
                min-width: 150px;
            }

            .tool-item label {
                font-size: 0.85rem;
                font-weight: 700;
                color: var(--text-muted);
            }

            .tool-item select {
                padding: 10px;
                border-radius: 10px;
                border: 2px solid var(--border);
                background: var(--bg);
                color: var(--text-main);
                font-weight: 600;
                outline: none;
            }

            .action-group {
                display: flex;
                gap: 10px;
            }

            .tool-btn {
                padding: 10px 20px;
                border-radius: 10px;
                border: none;
                font-weight: 700;
                cursor: pointer;
                transition: 0.3s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .btn-refresh {
                background: var(--bg);
                color: var(--primary);
                border: 2px solid var(--primary);
            }

            .btn-bulk {
                background: var(--warning);
                color: white;
            }

            .payment-stats-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-bottom: 25px;
            }

            .p-stat-card {
                padding: 20px;
                border-radius: 15px;
                background: var(--card-bg);
                display: flex;
                flex-direction: column;
                align-items: center;
                border: 2px solid transparent;
            }

            .p-stat-card.total {
                border-color: var(--primary);
            }

            .p-stat-card.paid {
                border-color: var(--success);
            }

            .p-stat-card.due {
                border-color: var(--danger);
            }

            .p-stat-label {
                font-size: 0.8rem;
                font-weight: 700;
                color: var(--text-muted);
                text-transform: uppercase;
            }

            .p-stat-value {
                font-size: 1.8rem;
                font-weight: 800;
            }

            .payment-folders {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .pay-folder {
                background: var(--card-bg);
                border-radius: 20px;
                border: 1px solid var(--border);
                overflow: hidden;
            }

            .pay-folder-header {
                padding: 15px 20px;
                background: rgba(0, 0, 0, 0.02);
                border-bottom: 1px solid var(--border);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 700;
            }

            .pay-folder.due .pay-folder-header {
                color: var(--danger);
            }

            .pay-folder.paid .pay-folder-header {
                color: var(--success);
            }

            .search-mini input {
                padding: 6px 12px;
                border-radius: 8px;
                border: 1px solid var(--border);
                background: rgba(255, 255, 255, 0.05);
                font-size: 0.8rem;
                width: 130px;
                color: white;
                /* Default for dark mode */
                outline: none;
                transition: 0.3s;
            }

            .search-mini input:focus {
                border-color: var(--primary);
                background: rgba(255, 255, 255, 0.1);
            }

            /* Light mode override if applicable */
            [data-theme='light'] .search-mini input {
                color: var(--primary);
                background: var(--bg);
            }

            .pay-folder-list {
                height: 400px;
                overflow-y: auto;
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .pay-student-card {
                background: var(--bg);
                padding: 12px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: 0.3s;
                border: 1px solid transparent;
            }

            .pay-student-card:hover {
                transform: translateX(5px);
                border-color: var(--primary);
            }

            .pay-avatar {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                border: 2px solid white;
                object-fit: cover;
            }

            .pay-info {
                flex: 1;
            }

            .pay-name {
                font-weight: 700;
                font-size: 0.9rem;
                color: var(--text-main);
            }

            .pay-meta {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            .pay-actions {
                display: flex;
                gap: 5px;
            }

            .pay-btn-small {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: 0.2s;
            }

            .pay-btn-paid {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success);
            }

            .pay-btn-due {
                background: rgba(244, 63, 94, 0.1);
                color: var(--danger);
            }

            .pay-btn-remind {
                background: rgba(245, 158, 11, 0.1);
                color: var(--warning);
            }

            .pay-btn-small:hover {
                transform: scale(1.1);
                filter: brightness(0.9);
            }

            @media (max-width: 900px) {
                .payment-folders {
                    grid-template-columns: 1fr;
                }

                .payment-stats-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* --- Live Attendance Styles --- */
            @keyframes pulse-red {
                0% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                }

                70% {
                    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                }
            }

            .btn-live-active {
                background: linear-gradient(135deg, #ef4444, #b91c1c) !important;
                color: white !important;
                border: none !important;
                animation: pulse-red 2s infinite;
            }

            /* --- Leaderboard Popup Mobile Fixes --- */
            @media (max-width: 600px) {
                .summary-modal-content {
                    width: 95% !important;
                    max-width: 95% !important;
                    padding: 20px 10px !important;
                    max-height: 85vh !important;
                }

                .summary-mode-btns {
                    flex-direction: column !important;
                    gap: 10px !important;
                }

                .summary-mode-btn {
                    width: 100% !important;
                    padding: 12px !important;
                    font-size: 0.9rem !important;
                }

                .time-stats-grid {
                    display: grid !important;
                    grid-template-columns: 1fr 1fr !important;
                    gap: 10px !important;
                }

                .stat-box {
                    padding: 10px !important;
                    min-height: 80px !important;
                    display: flex !important;
                    flex-direction: column !important;
                    justify-content: center !important;
                }

                .stat-value {
                    font-size: 1.1rem !important;
                }

                .stat-label {
                    font-size: 0.7rem !important;
                }

                .subject-time-item {
                    font-size: 0.85rem !important;
                    padding: 8px !important;
                }

                .summary-item h5 {
                    font-size: 0.9rem !important;
                }

                .chapter-detail-box {
                    font-size: 0.8rem !important;
                }
            }

            .monitor-layout {
                display: flex;
                gap: 20px;
                height: calc(100vh - 160px);
                min-height: 500px;
            }

            .monitor-sidebar {
                width: 350px;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                padding: 15px !important;
            }

            .monitor-sidebar h4 {
                margin-bottom: 15px;
                font-size: 1.1rem;
                color: var(--primary);
            }

            .monitor-sidebar .search-container {
                width: 100%;
                margin-bottom: 20px;
                position: relative;
                flex: none;
                /* Fix: Prevent search bar from expanding and creating a gap */
                margin-left: 0;
                /* Fix: Remove inherited margin from global search-container */
            }

            .monitor-sidebar .search-container i {
                position: absolute;
                left: 15px;
                /* Perfect left spacing */
                top: 50%;
                transform: translateY(-50%);
                color: var(--primary);
                /* Use primary color for the icon */
                font-size: 14px;
                pointer-events: none;
            }

            .monitor-sidebar .search-container input {
                width: 100%;
                padding: 12px 15px 12px 42px;
                /* Increased left padding for the icon */
                border-radius: 12px;
                border: 1.5px solid var(--border);
                background: rgba(255, 255, 255, 0.03);
                color: var(--text-main);
                font-family: inherit;
                font-size: 14px;
                transition: all 0.3s ease;
                outline: none;
            }

            .monitor-sidebar .search-container input:focus {
                border-color: var(--primary);
                background: rgba(255, 255, 255, 0.05);
                box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            }

            .monitor-list-container {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .monitor-list-container::-webkit-scrollbar {
                width: 5px;
            }

            .monitor-list-container::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 10px;
            }

            .monitor-filters {
                display: flex;
                background: var(--card-bg);
                padding: 6px;
                border-radius: 14px;
                border: 1px solid var(--border);
                gap: 5px;
                margin-bottom: 25px;
                width: fit-content;
                flex-shrink: 0;
            }

            .time-filter-btn {
                background: transparent;
                border: none;
                color: var(--text-muted);
                padding: 8px 18px;
                border-radius: 10px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                white-space: nowrap;
            }

            .time-filter-btn.active {
                background: var(--primary);
                color: white;
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            }

            .monitor-main {
                flex: 1;
                padding: 25px !important;
                overflow-y: auto;
                position: relative;
                max-height: 100%;
                /* Fix: Constrain to layout height */
                display: flex;
                flex-direction: column;
            }

            .monitor-student-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                border-radius: 12px;
                background: var(--bg);
                border: 1px solid var(--border);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .monitor-student-item:hover {
                border-color: var(--primary);
                transform: translateX(5px);
                background: rgba(37, 99, 235, 0.05);
            }

            .monitor-student-item.active {
                background: rgba(37, 99, 235, 0.1);
                border-color: var(--primary);
                box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1);
            }

            @media (max-width: 900px) {
                .monitor-layout {
                    flex-direction: column;
                    height: auto;
                }

                .monitor-sidebar {
                    width: 100%;
                    height: 400px;
                }

                .monitor-main {
                    height: auto;
                    min-height: 500px;
                }
            }
        </style>
        <div id="inactivity-page" class="hidden">
            <div class="inactivity-container">
                <button onclick="showPage('dashboard-page')" class="btn-primary"
                    style="margin-bottom: 20px; width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> ড্যাশবোর্ডে ফিরে যান
                </button>

                <!-- Header -->
                <div class="inactivity-header">
                    <h1>
                        <i class="fas fa-bell"></i>
                        অনিয়মিততা সতর্কতা সিস্টেম
                    </h1>
                    <p>যারা নির্দিষ্ট দিনের মধ্যে লগইন করেননি তাদের ট্র্যাক করুন এবং রিমাইন্ডার পাঠান</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card total">
                        <i class="fas fa-users stat-icon"></i>
                        <div class="stat-value" id="totalInactive">0</div>
                        <div class="stat-label">মোট অফলাইন</div>
                    </div>
                    <div class="stat-card warning">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <div class="stat-value" id="warningCount">0</div>
                        <div class="stat-label">সতর্কতা (১-২ দিন)</div>
                    </div>
                    <div class="stat-card danger">
                        <i class="fas fa-exclamation-circle stat-icon"></i>
                        <div class="stat-value" id="dangerCount">0</div>
                        <div class="stat-label">বিপদ (৩-৫ দিন)</div>
                    </div>
                    <div class="stat-card critical">
                        <i class="fas fa-skull-crossbones stat-icon"></i>
                        <div class="stat-value" id="criticalCount">0</div>
                        <div class="stat-label">গুরুতর (৬+ দিন)</div>
                    </div>
                </div>

                <!-- Configuration Panel -->
                <div class="config-panel">
                    <h3>
                        <i class="fas fa-cog"></i>
                        কনফিগারেশন
                    </h3>
                    <div class="config-content">
                        <div class="day-selector">
                            <label for="dayThreshold">দিনের সংখ্যা সেট করুন:</label>
                            <select id="dayThreshold" onchange="updateThreshold()">
                                <option value="1">১ দিন</option>
                                <option value="2">২ দিন</option>
                                <option value="3" selected>৩ দিন</option>
                                <option value="5">৫ দিন</option>
                                <option value="7">৭ দিন</option>
                            </select>
                        </div>
                        <button class="save-config-btn" onclick="saveConfig()">
                            <i class="fas fa-save"></i>
                            সেভ করুন
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterStudents('all')">সব</button>
                        <button class="filter-btn" onclick="filterStudents('warning')">সতর্কতা</button>
                        <button class="filter-btn" onclick="filterStudents('danger')">বিপদ</button>
                        <button class="filter-btn" onclick="filterStudents('critical')">গুরুতর</button>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="শিক্ষার্থী খুঁজুন..." oninput="searchStudents(this.value)">
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-bulk-reminder" onclick="showBulkReminderModal()">
                            <i class="fas fa-paper-plane"></i>
                            বাল্ক রিমাইন্ডার
                        </button>
                        <!-- <button class="action-btn btn-export" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            এক্সপোর্ট
                        </button> -->
                    </div>
                </div>

                <!-- Students Grid -->
                <div id="studentsGrid" class="students-grid"></div>

                <!-- Loading State -->
                <div id="inactivityLoadingState" class="loading-state hidden">
                    <div class="loader" style="margin: 0 auto;"></div>
                    <p style="text-align:center; margin-top:10px">ডেটা লোড হচ্ছে...</p>
                </div>
            </div>
        </div>

        <!-- Reminder Modal -->
        <div id="reminderModal" class="modal">
            <div class="modal-content">
                <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:15px">
                    <h3>
                        <i class="fas fa-paper-plane"></i>
                        রিমাইন্ডার পাঠান
                    </h3>
                    <button class="modal-close" onclick="closeReminderModal()">&times;</button>
                </div>

                <div class="template-section">
                    <h4 style="margin-bottom:10px">টেমপ্লেট নির্বাচন করুন:</h4>
                    <div class="template-grid">
                        <button class="template-btn" onclick="selectTemplate(1)">
                            <i class="fas fa-comment-dots"></i> কেমন আছ? দীর্ঘ সময় দেখা হচ্ছে না। পড়াশোনায় ঠিক আছ?
                        </button>
                        <button class="template-btn" onclick="selectTemplate(2)">
                            <i class="fas fa-chart-line"></i> তোমার প্রগ্রেস আমরা মিস করছি। দ্রুত ফিরে আসো!
                        </button>
                        <button class="template-btn" onclick="selectTemplate(3)">
                            <i class="fas fa-exclamation-triangle"></i> অনিয়মিততার কারণ জানাও। আমরা সাহায্য করতে পারি।
                        </button>
                    </div>
                </div>

                <div class="custom-message" style="margin-bottom:15px">
                    <textarea id="customMessage" placeholder="কাস্টম মেসেজ লিখুন..."
                        style="width:100%; padding:10px; border:2px solid var(--primary); border-radius:10px; min-height:80px"></textarea>
                </div>

                <div class="modal-actions" style="display:flex; gap:10px">
                    <button class="modal-btn btn-cancel" onclick="closeReminderModal()"
                        style="background: #e2e8f0; color: #475569;">
                        <i class="fas fa-times"></i> বন্ধ করুন
                    </button>
                    <button class="modal-btn btn-send" onclick="sendReminder()"
                        style="background: var(--success); color: white;">
                        <i class="fas fa-paper-plane"></i> পাঠান
                    </button>
                </div>
            </div>
        </div>



        <!-- Toast Notification (Reusing existing styling but ensuring structure) -->
        <!-- Professional Attendance Page -->
        <div id="attendance-page" class="hidden">
            <div class="pro-att-container">
                <button onclick="showPage('dashboard-page')" class="btn-primary"
                    style="margin-bottom: 20px; width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> ড্যাশবোর্ডে ফিরে যান
                </button>

                <!-- Header -->
                <div class="pro-att-header">
                    <h1><i class="fas fa-clipboard-check"></i> শিক্ষার্থীদের অ্যাটেনডেন্স</h1>
                    <p>লিডারবোর্ডে থাকা সকল শিক্ষার্থীর অ্যাটেনডেন্স নিন এবং পরিচালনা করুন</p>
                </div>

                <!-- Selector -->
                <div class="pro-att-selector-section" style="justify-content: space-between;">
                    <div class="pro-att-date-selector" style="flex: 0 0 auto; min-width: 250px;">
                        <label>📅 তারিখ নির্বাচন করুন</label>
                        <input type="date" id="proAttDate" onchange="loadProAttendance()">
                    </div>
                    <!-- Class Selector Removed -->
                    <div class="pro-att-action-buttons" style="flex: 1; justify-content: flex-end;">
                        <button class="pro-att-btn pro-att-btn-refresh" onclick="loadProAttendance()">
                            <i class="fas fa-sync-alt"></i> রিফ্রেশ
                        </button>
                        <button class="pro-att-btn pro-att-btn-report" onclick="toggleReportBreakdown()">
                            <i class="fas fa-chart-line"></i> রিপোর্ট
                        </button>
                        <button class="pro-att-btn" style="background:var(--danger); color:white"
                            onclick="resetProAttendance(event)">
                            <i class="fas fa-trash-alt"></i> রিসেট
                        </button>
                        <button id="btn-live-attendance" onclick="toggleLiveAttendance()" class="pro-att-btn"
                            title="Live Attendance"
                            style="background:var(--bg); color:var(--text-muted); border:1px solid var(--border); display:flex; align-items:center; gap:8px;">
                            <i class="fas fa-wifi"></i> Live
                        </button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="pro-att-stats-grid">
                    <div class="pro-att-stat-card total">
                        <i class="fas fa-users pro-att-stat-icon"></i>
                        <div class="pro-att-stat-value" id="proTotalStudents">0</div>
                        <div class="stat-label">মোট শিক্ষার্থী</div>
                    </div>
                    <div class="pro-att-stat-card present" style="cursor:pointer"
                        onclick="toggleGenderBreakdown('present')">
                        <i class="fas fa-user-check pro-att-stat-icon"></i>
                        <div class="pro-att-stat-value" id="proPresentStudents">0</div>
                        <div class="stat-label">উপস্থিত <i class="fas fa-chevron-down"
                                style="font-size:0.8em; opacity:0.5; margin-left:5px"></i></div>
                    </div>
                    <div class="pro-att-stat-card absent" style="cursor:pointer"
                        onclick="toggleGenderBreakdown('absent')">
                        <i class="fas fa-user-times pro-att-stat-icon"></i>
                        <div class="pro-att-stat-value" id="proAbsentStudents">0</div>
                        <div class="stat-label">অনুপস্থিত <i class="fas fa-chevron-down"
                                style="font-size:0.8em; opacity:0.5; margin-left:5px"></i></div>
                    </div>
                    <div class="pro-att-stat-card percentage" style="cursor:pointer" onclick="togglePercentBreakdown()">
                        <i class="fas fa-percentage pro-att-stat-icon"></i>
                        <div class="pro-att-stat-value" id="proAttPercent">0%</div>
                        <div class="stat-label">অ্যাটেনডেন্স হার <i class="fas fa-chevron-down"
                                style="font-size:0.8em; opacity:0.5; margin-left:5px"></i></div>
                    </div>
                </div>

                <!-- Overall Report Breakdown Section -->
                <div id="proAttReportBreakdown" class="pro-att-breakdown hidden"
                    style="border:none; background:transparent; box-shadow:none; padding:0; margin-bottom: 25px;">
                    <!-- Hero Section for Total Classes (Centered) -->
                    <!-- Hero Section for Total Classes (Single Line Massive) -->
                    <div class="report-hero-section">
                        <div class="hero-stat-value">
                            <span class="label-text">সর্বমোট ক্লাস হয়েছে</span>
                            <span class="value-text"><span id="totalClassesHeld">0</span> টি</span>
                            <span class="mini-sub"></span>
                        </div>

                        <!-- Professional Morphing Search -->
                        <div class="report-search-wrapper">
                            <div class="search-container-v2" id="reportSearchContainer"
                                onclick="toggleReportSearch(event)">
                                <input type="text" class="search-input-v2" id="reportSearchInput"
                                    placeholder="শিক্ষার্থীর নাম খুঁজুন..." onkeyup="filterReportStudents(this.value)">
                                <button class="search-btn-v2">
                                    <i class="fas fa-search" id="reportSearchIcon"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="reportBreakdownContent" class="report-grid">
                        <!-- Premium student report cards will be loaded here -->
                        <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                            <div class="loader"></div>
                            <p style="margin-top:15px; color:var(--text-muted); font-weight: 500;">রিপোর্ট তৈরি হচ্ছে...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Percentage Breakdown Section -->
                <div id="proAttPercentBreakdown" class="pro-att-breakdown hidden" style="border-color: var(--warning);">
                    <div class="breakdown-header">
                        <h4>জেন্ডার ভিত্তিক উপস্থিতির হার (%)</h4>
                    </div>
                    <div class="percent-grid">
                        <!-- Male Stats -->
                        <div class="percent-card male">
                            <div class="percent-card-header"><i class="fas fa-male"></i> ছেলে (ছাত্র)</div>
                            <div class="percent-item">
                                <span>উপস্থিত:</span>
                                <div class="percent-bar-bg">
                                    <div id="barMalePresent" class="percent-bar present" style="width: 0%;"></div>
                                </div>
                                <span id="txtMalePresent" class="percent-val">0%</span>
                            </div>
                            <div class="percent-item">
                                <span>অনুপস্থিত:</span>
                                <div class="percent-bar-bg">
                                    <div id="barMaleAbsent" class="percent-bar absent" style="width: 0%;"></div>
                                </div>
                                <span id="txtMaleAbsent" class="percent-val">0%</span>
                            </div>
                        </div>
                        <!-- Female Stats -->
                        <div class="percent-card female">
                            <div class="percent-card-header"><i class="fas fa-female"></i> মেয়ে (ছাত্রী)</div>
                            <div class="percent-item">
                                <span>উপস্থিত:</span>
                                <div class="percent-bar-bg">
                                    <div id="barFemalePresent" class="percent-bar present" style="width: 0%;"></div>
                                </div>
                                <span id="txtFemalePresent" class="percent-val">0%</span>
                            </div>
                            <div class="percent-item">
                                <span>অনুপস্থিত:</span>
                                <div class="percent-bar-bg">
                                    <div id="barFemaleAbsent" class="percent-bar absent" style="width: 0%;"></div>
                                </div>
                                <span id="txtFemaleAbsent" class="percent-val">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Breakdown Section -->
                <div id="proAttDetailedBreakdown" class="pro-att-breakdown hidden">
                    <div class="breakdown-header">
                        <h4 id="breakdownTitle">উপস্থিতির বিস্তারিত তথ্য</h4>
                        <div class="breakdown-tabs">
                            <button class="breakdown-tab active" id="tabMale" onclick="switchGenderTab('m')">
                                <i class="fas fa-male"></i> ছেলে (<span id="countMale">0</span>)
                            </button>
                            <button class="breakdown-tab" id="tabFemale" onclick="switchGenderTab('f')">
                                <i class="fas fa-female"></i> মেয়ে (<span id="countFemale">0</span>)
                            </button>
                        </div>
                    </div>
                    <div id="breakdownContent" class="breakdown-content">
                        <!-- Student profiles will be loaded here -->
                    </div>
                </div>

                <!-- Folders -->
                <div class="pro-att-folders-container">
                    <!-- Present -->
                    <div class="pro-att-folder-card present">
                        <div class="pro-att-folder-header">
                            <div class="pro-att-folder-title">
                                <i class="fas fa-folder-open"></i> উপস্থিত
                                <span class="folder-count" id="proPresentCount">0 জন</span>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center">
                                <input type="text" id="searchPresent" placeholder="নাম খুঁজুন..."
                                    class="folder-search hidden" oninput="filterFolder('present', this.value)">
                                <button class="folder-icon-btn" onclick="toggleSearch('present')"><i
                                        class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="pro-att-folder-content" id="proPresentFolder"></div>
                    </div>
                    <!-- Absent -->
                    <div class="pro-att-folder-card absent">
                        <div class="pro-att-folder-header">
                            <div class="pro-att-folder-title">
                                <i class="fas fa-folder"></i> অনুপস্থিত
                                <span class="folder-count" id="proAbsentCount">0 জন</span>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center">
                                <input type="text" id="searchAbsent" placeholder="নাম খুঁজুন..."
                                    class="folder-search hidden" oninput="filterFolder('absent', this.value)">
                                <button class="folder-icon-btn" onclick="toggleSearch('absent')"><i
                                        class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="pro-att-folder-content" id="proAbsentFolder"></div>
                    </div>
                </div>

                <!-- Bottom Actions -->
                <div class="pro-att-bottom-actions">
                    <button class="btn-primary" onclick="saveProAttendance(event)"
                        style="background: linear-gradient(135deg, var(--success), #16a34a); border:none; padding: 12px 25px; width: 100%;">
                        <i class="fas fa-check-circle"></i> অ্যাটেনডেন্স সাবমিট
                    </button>
                </div>
            </div>

        </div>

        <div id="toast" class="toast">
            <i class="fas fa-check-circle toast-icon"></i>
            <span class="toast-message"></span>
        </div>

        <div id="banned-screen" class="banned-screen hidden">
            <i class="fas fa-user-slash" style="font-size: 4rem; color: var(--danger);"></i>
            <h1 style="margin-top:20px; font-size:22px">অ্যাকাউন্ট স্থগিত!</h1>
            <p style="margin-top: 10px; color: #94a3b8;">আপনার একাউন্টটি এডমিন কর্তৃক ব্যান করা হয়েছে।</p>
            <button class="btn-primary" onclick="handleLogout()" style="width:160px; margin-top:20px">লগআউট</button>
        </div>
        <div id="device-blocked-screen" class="banned-screen hidden">
            <i class="fas fa-ban" style="font-size: 4rem; color: var(--danger);"></i>
            <h1 style="margin-top:20px; font-size:22px">অ্যাক্সেস ডিনাইড!</h1>
            <p style="margin-top: 10px; color: #94a3b8; text-align: center; padding: 0 20px;">আপনার ডিভাইসটি এই
                ওয়েবসাইট থেকে চিরতরে ব্লক করা হয়েছে।</p>
        </div>
        <!-- Student Management Page -->
        <div id="student-management-page" class="hidden">
            <div class="container" style="max-width: 1200px; margin-top: 20px;">
                <button onclick="showPage('dashboard-page')" class="btn-primary"
                    style="margin-bottom: 20px; width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> ড্যাশবোর্ডে ফিরে যান
                </button>

                <div class="card" style="border: none; background: var(--card-bg);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px;">
                        <div>
                            <h2 style="font-size: 24px; margin-bottom: 5px;"><i class="fas fa-users-cog"
                                    style="color: #d946ef;"></i> স্টুডেন্ট ম্যানেজমেন্ট</h2>
                            <p style="color: var(--text-muted);">সকল শিক্ষার্থীর তালিকা ও অ্যাকশন</p>
                        </div>
                        <div style="display: flex; gap: 15px; grid-gap: 15px; flex-wrap: wrap;">
                            <div class="stat-box"
                                style="background: rgba(var(--primary-rgb), 0.1); padding: 10px 20px; border-radius: 10px; border: 1px solid var(--primary);">
                                <span style="font-size: 12px; color: var(--text-muted); display: block;">মোট
                                    শিক্ষার্থী</span>
                                <span id="sm-total-count"
                                    style="font-size: 20px; font-weight: bold; color: var(--primary);">0</span>
                            </div>
                            <div class="stat-box"
                                style="background: rgba(239, 68, 68, 0.1); padding: 10px 20px; border-radius: 10px; border: 1px solid var(--danger);">
                                <span style="font-size: 12px; color: var(--text-muted); display: block;">ব্যান করা
                                    হয়েছে</span>
                                <span id="sm-banned-count"
                                    style="font-size: 20px; font-weight: bold; color: var(--danger);">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="sm-search" placeholder="নাম বা আইডি দিয়ে খুঁজুন..."
                            style="padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); flex: 1; min-width: 250px;"
                            oninput="renderStudentMgmtList()">

                        <select id="sm-filter" onchange="renderStudentMgmtList()"
                            style="padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main);">
                            <option value="all">সব শিক্ষার্থী</option>
                            <option value="active">Active</option>
                            <option value="banned">Banned</option>
                        </select>
                    </div>

                    <!-- List Container -->
                    <div id="student-management-list"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <!-- Cards will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBX6ptP9fHhK-mbJ129bU4xCuojS048QM8",
            authDomain: "study-trucker-592dd.firebaseapp.com",
            databaseURL: "https://study-trucker-592dd-default-rtdb.firebaseio.com",
            projectId: "study-trucker-592dd",
            storageBucket: "study-trucker-592dd.firebasestorage.app",
            messagingSenderId: "212811401880",
            appId: "1:212811401880:web:f1abaf879c4a49f0385eed",
            measurementId: "G-GFK0WVQGZM"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const syllabusData = {
            "পদার্থবিজ্ঞান": {
                "1st Paper": ["ভৌত জগৎ ও পরিমাপ", "ভেক্টর", "গতিবিদ্যা", "নিউটনিয়ান বলবিদ্যা", "কাজ শক্তি ও ক্ষমতা", "মহাকর্ষ ও অভিকর্ষ", "পদার্থের গাঠনিক ধর্ম", "পর্যায়বৃত্ত গতি", "তরঙ্গ", "আদর্শ গ্যাস ও গ্যাসের গতিতত্ব"],
                "2nd Paper": ["তাপ গতিবিদ্যা", "স্থির তড়িৎ", "চল তড়িৎ", "তড়িৎ প্রবাহের চৌম্বক ক্রিয়া ও চুম্বকত্ব", "তড়িৎ চৌম্বকীয় আবেশ", "জ্যামিতিক আলোকবিজ্ঞান", "ভৌতআলোক বিজ্ঞান", "আধুনিক পদার্থবিজ্ঞানের সূচনা", "পরমাণুর মডেল", "সেমিকন্ডাক্টর ও ইলেক্ট্রনিক্স", "জ্যোতির্বিজ্ঞান"]
            },
            "রসায়ন": {
                "1st Paper": ["ল্যাবরেটরির নিরাপদ ব্যবহার", "গুণগত রসায়ন", "মৌলের পর্যাবৃত্তধর্ম ও রাসায়নিক বন্ধন", "রাসায়নিক পরিবর্তন", "কর্মমুখী রসায়ন"],
                "2nd Paper": ["পরিবেশ রসায়ন", "জৈব রসায়ন", "পরিমাণগত রসায়ন", "তড়িৎ রসায়ন", "অর্থনৈতিক রসায়ন"]
            },
            "জীববিজ্ঞান": {
                "1st Paper": ["কোষ ও এর গঠন", "কোষ বিভাজন", "কোষ রসায়ন", "অনুজীব", "শৈবাল ও ছত্রাক", "ব্রায়োফাইটা ও টেরিডোফাইটা", "নগ্নবীজী ও আবৃতবীজী উদ্ভিদ", "টিস্যু ও টিস্যু তন্ত্র", "উদ্ভিদ শরীরতত্ত্ব", "উদ্ভিদ প্রজনন", "জীব প্রযুক্তি", "জীবের পরিবেশ বিস্তার ও সংরক্ষণ"],
                "2nd Paper": ["প্রাণীর বিভিন্নতা ও শ্রেণীবিন্যাস", "প্রাণীর পরিচিতি", "মানব শরীর তত্ত্ব : পরিপাক ও শ্বসন", "মানব শরীর তত্ত্ব : রক্ত সঞ্চালন", "মানব শরীর তত্ত্ব : শ্বাসক্রিয়া ও শোষণ", "বজ্র ও নিষ্কাশন", "মানব শরীর তত্ত্ব : চলন ও অঙ্গ চালনা", "সমন্বয় ও নিয়ন্ত্রণ", "মানব জীবনের ধারাবাহিকতা", "মানবদেহের প্রতিরক্ষা", "জিনতত্ত্ব ও বিবর্তন", "প্রাণীর আচরণ"]
            },
            "উচ্চতর গণিত": {
                "1st Paper": ["ম্যাট্রিক্স ও নির্ণায়ক", "ভেক্টর", "সরলরেখা", "বৃত্ত", "বিন্যাস ও সমাবেশ", "ত্রিকোনমিত্রিক অনুপাত", "সংযুক্ত কোণের ত্রিকোনমিত্রিক অনুপাত", "ফাংশন", "অন্টারীকরণ", "যোগজীকরণ"],
                "2nd Paper": ["বাস্তব সংখ্যা ও অসমতা", "যোগাশ্রয়ী প্রোগ্রাম", "জটিল সংখ্যা", "বহুপদী সমীকরণ", "দ্বিপদী বিস্তৃতি", "কনিক", "বিপরীত ত্রিকোনমিতিক ফাংশন ও ত্রিকোনমিতিক সমীকরণ", "স্থিতিবিদ্যা", "সমতলে বস্তুকণার গতি", "বিস্তার পরিমাপ ও সম্ভাব্যতা"]
            }
        };
        let allUsers = {};
        let globalAttendanceData = {};
        let globalPaymentData = {};
        let currentUser = null;
        let selectedSub = "";
        let selectedPaper = "";
        let activeSummaryUid = null;
        let openedDetails = new Set();
        let subjectStates = JSON.parse(localStorage.getItem('subjectStates')) || {};
        let isStudyMode = false;
        let timerInterval = null;
        let studySeconds = 0;
        let isTimerRunning = false;
        let targetAlarmSeconds = 0;
        let isDangerAlertActive = false;
        let currentLeaderboardFilter = '24h';
        let currentSummaryMode = 'study';
        let currentSubjectTimeFilter = 'lifetime';
        let selectedResetDates = []; // For attendance calendar reset
        let currentResetMonth = new Date().getMonth();
        let currentResetYear = new Date().getFullYear();

        // Helper function to get today's start time (12:00 AM)
        function getTodayStartTime() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            return todayStart.getTime();
        }

        // Helper function to get time filter start time
        function getTimeFilterStartTime(filterType) {
            const now = new Date();
            let startTime;

            switch (filterType) {
                case '24h':
                    // From today 12:00 AM
                    startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                    break;
                case '7d':
                    // From 7 days ago 12:00 AM
                    startTime = new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000);
                    startTime.setHours(0, 0, 0, 0);
                    break;
                case '1m':
                    // From 30 days ago 12:00 AM
                    startTime = new Date(now.getTime() - 29 * 24 * 60 * 60 * 1000);
                    startTime.setHours(0, 0, 0, 0);
                    break;
                case 'lifetime':
                default:
                    return 0;
            }

            return startTime.getTime();
        }

        // FIXED: Calculate study time - use studyLogs for time filters, fallback to studyTime
        function calculateStudyTime(user, subject, filterType = 'lifetime') {
            if (!user) return 0;

            let totalTime = 0;
            const startTime = getTimeFilterStartTime(filterType);

            // First try to calculate from studyLogs (new system with timestamps)
            if (user.studyLogs && Object.keys(user.studyLogs).length > 0) {
                Object.keys(user.studyLogs).forEach(logKey => {
                    const log = user.studyLogs[logKey];

                    if (filterType === 'lifetime') {
                        // For lifetime, use all logs
                        if (subject) {
                            if (log.subject === subject) {
                                totalTime += log.duration || 0;
                            }
                        } else {
                            totalTime += log.duration || 0;
                        }
                    } else {
                        // For time filters, check if log is within range
                        if (log.timestamp >= startTime) {
                            if (subject) {
                                if (log.subject === subject) {
                                    totalTime += log.duration || 0;
                                }
                            } else {
                                totalTime += log.duration || 0;
                            }
                        }
                    }
                });
            }

            // Fallback: If no studyLogs or total is 0 and filter is lifetime, use old studyTime
            // This ensures old data is preserved and shown
            if (totalTime === 0 && filterType === 'lifetime') {
                if (user.studyTime) {
                    if (subject) {
                        totalTime = user.studyTime[subject] || 0;
                    } else {
                        Object.keys(user.studyTime).forEach(sub => {
                            totalTime += user.studyTime[sub] || 0;
                        });
                    }
                }
            }

            return totalTime;
        }

        // NEW: Update admin dashboard statistics (Disabled)
        function updateAdminDashboard() {
            // Function disabled as admin UI elements were removed
            if (!currentUser || currentUser.role !== 'teacher') return;
        }

        // Convert digit to Bengali
        function convertToBengaliDigit(num) {
            const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            return num.toString().split('').map(d => bengaliDigits[parseInt(d)] || d).join('');
        }

        function formatDetailedTimeAgo(timestamp) {
            if (!timestamp) return 'তথ্য নেই';
            const diff = Date.now() - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return 'এইমাত্র (Active Now)';

            let parts = [];
            if (days > 0) parts.push(`${convertToBengaliDigit(days)} দিন`);
            if (hours % 24 > 0) parts.push(`${convertToBengaliDigit(hours % 24)} ঘণ্টা`);
            if (minutes % 60 > 0) parts.push(`${convertToBengaliDigit(minutes % 60)} মিনিট`);

            if (parts.length === 0) return '১ মিনিটের কম সময় আগে';
            return parts.join(' ') + ' আগে';
        }

        db.ref('users').on('value', (snapshot) => {
            try {
                allUsers = snapshot.val() || {};

                if (document.getElementById('student-management-page') && !document.getElementById('student-management-page').classList.contains('hidden')) {
                    loadStudentManagement();
                }

                if (currentUser) currentUser = allUsers[currentUser.id] || currentUser;
                if (currentUser && currentUser.role === 'teacher') {
                    const pendingReqs = Object.values(allUsers).filter(u => u.role === 'student' && u.isApproved === false);
                    const dot = document.getElementById('notif-dot');
                    if (dot) {
                        if (pendingReqs.length > 0) dot.style.display = 'block'; else dot.style.display = 'none';
                    }
                    if (typeof renderApprovalList === 'function') renderApprovalList(pendingReqs);
                    if (typeof updateAdminDashboard === 'function') updateAdminDashboard();
                }

                if (typeof renderLeaderboard === 'function') renderLeaderboard();
                if (typeof updateGlobalUI === 'function') updateGlobalUI();
                if (typeof renderSubjectBtns === 'function') renderSubjectBtns();

                if (isStudyMode && typeof renderStudyModeProfiles === 'function') renderStudyModeProfiles();
                if (activeSummaryUid && typeof viewSummary === 'function') viewSummary(activeSummaryUid);
                if (isAttViewOpen && typeof loadAttendanceData === 'function') loadAttendanceData();

                if (document.getElementById('activity-monitor-page') && !document.getElementById('activity-monitor-page').classList.contains('hidden')) {
                    if (typeof renderMonitorStudentList === 'function') renderMonitorStudentList();
                }
            } catch (error) {
                console.error("Real-time update error:", error);
            }
        });

        // NEW: Global listeners for performance (Caching)
        db.ref('attendance').on('value', snapshot => {
            globalAttendanceData = snapshot.val() || {};
        });

        const initSpeedCache = () => {
            const now = new Date();
            const year = now.getFullYear();
            const monthIdx = (now.getMonth() + 1).toString().padStart(2, '0');
            db.ref(`payments/${monthIdx}_${year}`).on('value', snapshot => {
                globalPaymentData = snapshot.val() || {};
            });
        };
        initSpeedCache();


        const finalizePage = () => {
            const app = document.getElementById('app');
            const loader = document.getElementById('page-loader');
            setTimeout(() => {
                app.classList.add('visible');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.visibility = 'hidden', 600);
            }, 1000);
        };
        const showLoginModal = () => { document.getElementById("loginModal").style.display = "flex"; };
        document.getElementById("loginForm").onsubmit = function (e) {
            e.preventDefault();
            const u = document.getElementById("username").value;
            const p = document.getElementById("password").value;
            if (u === "PC Master Academy" && p === "PVSL1.0") {
                localStorage.setItem("master_auth", "true");
                document.getElementById("loginModal").style.display = "none";
            } else { alert("ভুল তথ্য!"); }
        };
        function showPage(pageId) {
            document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
            const target = document.getElementById(pageId);
            if (target) target.classList.remove('hidden');

            // Instant status update on page navigation
            if (currentUser && currentUser.role !== 'teacher') {
                db.ref('users/' + currentUser.id + '/lastSeen').set(Date.now());
            }
        }
        function toggleMenu() {
            if (isTimerRunning) return alert("পড়া চলাকালীন মেনু ওপেন করা যাবে না। দয়া করে টাইমার স্টপ করুন।");
            document.getElementById("dropdown-menu").classList.toggle("show");
        }
        window.onclick = function (event) {
            if (!event.target.matches('.menu-trigger') && !event.target.closest('.menu-trigger')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                }
            }
        }
        function toggleStudyMode() {
            if (isTimerRunning) return alert("পড়া চলাকালীন স্টাডি মোড বন্ধ করা যাবে না। দয়া করে টাইমার স্টপ করুন।");
            if (currentUser && currentUser.role !== 'student') return alert("স্টাডি মোড শুধুমাত্র স্টুডেন্টদের জন্য উপলব্ধ।");
            isStudyMode = !isStudyMode;
            localStorage.setItem('study_mode_persistent', isStudyMode);
            const trackerCard = document.getElementById('student-tracker-card');
            const studyCard = document.getElementById('study-mode-container');
            const globalProgress = document.querySelector('.global-progress');
            const timeFilterContainer = document.getElementById('time-filter-container');
            if (isStudyMode) {
                trackerCard.classList.add('hidden');
                globalProgress.classList.add('hidden');
                studyCard.classList.remove('hidden');
                timeFilterContainer.style.display = 'flex';
                renderStudyModeProfiles();
            } else {
                trackerCard.classList.remove('hidden');
                globalProgress.classList.remove('hidden');
                studyCard.classList.add('hidden');
                timeFilterContainer.style.display = 'none';
                document.getElementById('study-subjects-section').classList.add('hidden');
            }
            renderLeaderboard();
            const dropdown = document.getElementById("dropdown-menu");
            if (dropdown.classList.contains('show')) dropdown.classList.remove('show');
        }
        function renderStudyModeProfiles() {
            const grid = document.getElementById('study-profile-grid');
            grid.innerHTML = "";
            if (!currentUser) return;
            const u = currentUser;
            const avatar = u.img || (u.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
            const card = document.createElement('div');
            card.className = "profile-card";
            card.onclick = () => {
                if (isTimerRunning) return;
                const subSection = document.getElementById('study-subjects-section');
                subSection.classList.toggle('hidden');
            };
            card.innerHTML = `
            <img src="${avatar}" alt="${u.name}">
            <h4>${u.name}</h4>
            <span style="font-size:11px; font-weight:700; color:var(--primary)">${u.progress}% সম্পন্ন হয়েছে</span>
            <p style="font-size:10px; color:var(--text-muted)">সাবজেক্ট লিস্ট দেখতে এখানে ক্লিক করুন</p>
        `;
            grid.appendChild(card);
        }
        function enterStudySession(subject) {
            document.getElementById('study-main-content').classList.add('hidden');
            document.getElementById('study-timer-view').classList.remove('hidden');
            document.getElementById('timer-subject-name').innerText = subject;
            localStorage.setItem('active_study_subject', subject);
            resetStudyTimerUI();

            // NEW: Track active session in Firebase for absolute real-time admin sync
            if (currentUser) {
                db.ref('users/' + currentUser.id).update({
                    activeSession: {
                        subject: subject,
                        startTime: Date.now()
                    }
                });
            }

            const savedStartTime = localStorage.getItem('timer_start_timestamp');
            if (savedStartTime) startTimerProcess(parseInt(savedStartTime));
            renderLeaderboard();
        }
        function exitStudyTimer() {
            if (isTimerRunning) return alert("ঘড়ি বন্ধ না করে আপনি এই সাবজেক্ট থেকে বের হতে পারবেন না!");
            document.getElementById('study-timer-view').classList.add('hidden');
            document.getElementById('study-main-content').classList.remove('hidden');
            localStorage.removeItem('active_study_subject');
            localStorage.removeItem('timer_start_timestamp');
            localStorage.removeItem('timer_target_alarm');
            stopDangerAlert();
            renderLeaderboard();
        }
        function resetStudyTimerUI() {
            studySeconds = 0; updateTimerDisplay();
            document.getElementById('timer-status-text').innerText = "START";
            document.getElementById('timer-main-btn').innerHTML = '<i class="fas fa-play"></i> স্টার্ট করুন';
            document.getElementById('timer-main-btn').style.background = "var(--primary)";
            document.getElementById('timer-progress-bar').style.strokeDashoffset = "848";
        }
        function updateTimerDisplay() {
            const hrs = Math.floor(studySeconds / 3600).toString().padStart(2, '0');
            const mins = Math.floor((studySeconds % 3600) / 60).toString().padStart(2, '0');
            const secs = (studySeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-digital').innerText = `${hrs}:${mins}:${secs}`;
        }

        // Helper: Convert digits to Bengali
        function convertToBengaliDigit(number) {
            const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            return number.toString().split('').map(digit => {
                return !isNaN(parseInt(digit)) ? bengaliDigits[parseInt(digit)] : digit;
            }).join('');
        }

        function handleLogin() {
            if (localStorage.getItem('device_blocked')) return showPage('device-blocked-screen');

            const loginEmail = document.getElementById('login-email').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value.trim();

            const emailKey = loginEmail.replace(/\./g, '_');

            if (loginEmail === "teacher20189@gmail.com" && pass === "teacher20189@gmail.com") {
                currentUser = { id: emailKey, name: "Teacher", role: 'teacher', gender: 'male', progress: 0, isApproved: true };
                localStorage.setItem('hsc_uid', emailKey);
                initDashboard();
                return;
            }

            db.ref('users/' + emailKey).once('value', snapshot => {
                const user = snapshot.val();
                if (user && user.pass === pass) {
                    if (user.isBanned) return showPage('banned-screen');
                    if (user.role === 'student' && user.isApproved === false) return showPage('waiting-room-screen');
                    currentUser = user;
                    localStorage.setItem('hsc_uid', emailKey);
                    // Update lastLogin and lastSeen time instantly
                    db.ref('users/' + emailKey).update({
                        lastLogin: Date.now(),
                        lastSeen: Date.now()
                    });
                    initDashboard();
                } else {
                    alert("ভুল পাসওযর্ড!");
                }
            });
        }

        // Helper function to save study time to Firebase (cumulative)
        function saveStudyTimeToFirebase(subject, seconds) {
            if (!currentUser || seconds <= 0) return;
            const userRef = db.ref('users/' + currentUser.id + '/studyTime/' + subject);
            userRef.transaction(currentTime => {
                return (currentTime || 0) + seconds;
            });
        }

        // NEW: Save study session log to Firebase (with timestamp for filtering)
        function saveStudySessionLog(subject, duration, startTime) {
            if (!currentUser || duration <= 0) return;

            const logData = {
                subject: subject,
                duration: duration,
                timestamp: startTime,
                endTime: Date.now()
            };

            const userLogsRef = db.ref('users/' + currentUser.id + '/studyLogs');
            const newLogKey = userLogsRef.push().key;
            userLogsRef.child(newLogKey).set(logData);
        }

        function toggleTimer() {
            if (!isTimerRunning) {
                const alarmMins = parseInt(document.getElementById('alarm-minutes').value) || 0;
                targetAlarmSeconds = alarmMins * 60;
                const startTimestamp = Date.now() - (studySeconds * 1000);
                localStorage.setItem('timer_start_timestamp', startTimestamp);
                localStorage.setItem('timer_target_alarm', targetAlarmSeconds);
                startTimerProcess(startTimestamp);
            } else {
                const currentSubject = localStorage.getItem('active_study_subject');
                if (currentSubject && studySeconds > 0) {
                    // Save to cumulative studyTime (preserves old data)
                    saveStudyTimeToFirebase(currentSubject, studySeconds);

                    // Save session log (new system for time filters)
                    const startTime = parseInt(localStorage.getItem('timer_start_timestamp')) || (Date.now() - studySeconds * 1000);
                    saveStudySessionLog(currentSubject, studySeconds, startTime);
                }

                // NEW: Clear active session in Firebase
                if (currentUser) {
                    db.ref('users/' + currentUser.id + '/activeSession').remove();
                }

                clearInterval(timerInterval); isTimerRunning = false;
                localStorage.removeItem('timer_start_timestamp');
                localStorage.removeItem('timer_target_alarm');
                document.getElementById('timer-status-text').innerText = "START";
                document.getElementById('timer-main-btn').innerHTML = '<i class="fas fa-play"></i> স্টার্ট করুন';
                document.getElementById('timer-main-btn').style.background = "var(--primary)";
                stopDangerAlert();

                studySeconds = 0;
                updateTimerDisplay();
                document.getElementById('timer-progress-bar').style.strokeDashoffset = "848";

                renderLeaderboard();
            }
        }
        function startTimerProcess(startTime) {
            if (timerInterval) clearInterval(timerInterval);
            isTimerRunning = true;
            document.getElementById('timer-status-text').innerText = "STOP";
            document.getElementById('timer-main-btn').innerHTML = '<i class="fas fa-stop"></i> স্টপ করুন';
            document.getElementById('timer-main-btn').style.background = "var(--danger)";
            timerInterval = setInterval(() => {
                studySeconds = Math.floor((Date.now() - startTime) / 1000);

                // 2-Hour Limit Check
                if (studySeconds >= 7200) {
                    toggleTimer();
                    alert("টানা ২ ঘণ্টা সম্পন্ন হয়েছে! টাইমার স্বয়ংক্রিয়ভাবে বন্ধ করা হলো। আবার পড়তে চাইলে নতুন করে শুরু করুন।");
                    return;
                }

                updateTimerDisplay();

                // LIVE UPDATE
                renderLeaderboard();

                if (document.getElementById('summaryModal').style.display === 'flex') {
                    updateSummaryLiveTime();
                }

                if (targetAlarmSeconds > 0) {
                    let offset = 848 - (studySeconds / targetAlarmSeconds) * 848;
                    if (offset < 0) offset = 0;
                    document.getElementById('timer-progress-bar').style.strokeDashoffset = offset;
                    if (studySeconds >= targetAlarmSeconds && !isDangerAlertActive) triggerDangerAlert();
                }
            }, 1000);
        }
        function triggerDangerAlert() {
            isDangerAlertActive = true;
            document.getElementById('study-timer-view').classList.add('danger-mode');
            document.getElementById('danger-overlay').style.display = 'flex';
        }
        function stopDangerAlert() {
            isDangerAlertActive = false;
            document.getElementById('study-timer-view').classList.remove('danger-mode');
            document.getElementById('danger-overlay').style.display = 'none';
        }
        function handleRegister() {
            if (localStorage.getItem('device_blocked')) return showPage('device-blocked-screen');
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value.trim().toLowerCase().replace(/\./g, '_');
            const pass = document.getElementById('reg-pass').value;
            const role = document.getElementById('reg-role').value;
            const gender = document.getElementById('reg-gender').value || 'male';
            const img = gender === 'female' ? "https://cdn-icons-png.flaticon.com/512/6997/6997662.png" : "https://cdn-icons-png.flaticon.com/512/4140/4140037.png";
            if (!name || !email || !pass) return alert("সব তথ্য দিন!");
            db.ref('users/' + email).once('value', snapshot => {
                if (snapshot.exists()) return alert("ইমেইলটি নিবন্ধিত!");
                const userData = { id: email, name, pass, role, gender, img, progress: 0, trackerData: {}, isBanned: false, isApproved: false, lastSeen: Date.now(), studyTime: {}, studyLogs: {} };
                db.ref('users/' + email).set(userData).then(() => {
                    alert("রেজিস্ট্রেশন সফল! অ্যাডমিন অনুমোদন দিলেই আপনি লগইন করতে পারবেন।"); showPage('login-page');
                });
            });
        }

        function handleLogout() { localStorage.removeItem('hsc_uid'); localStorage.removeItem('master_auth'); localStorage.removeItem('active_study_subject'); localStorage.removeItem('timer_start_timestamp'); location.reload(); }
        function confirmLogout() {
            if (isTimerRunning) return alert("পড়া চলাকালীন লগআউট করা যাবে না।");
            document.getElementById('logoutModal').style.display = 'flex';
        }
        function closeLogoutModal() { document.getElementById('logoutModal').style.display = 'none'; }
        function openProfileModal() {
            if (isTimerRunning) return alert("পড়া চলাকালীন প্রোফাইল এডিট করা যাবে না।");
            if (!currentUser) return;
            document.getElementById('edit-name').value = currentUser.name || "";
            document.getElementById('edit-email').value = currentUser.id.replace(/_/g, '.') || "";
            document.getElementById('edit-pass').value = currentUser.pass || "";
            document.getElementById('edit-gender').value = currentUser.gender || "male";
            document.getElementById('profile-preview').src = currentUser.img || (currentUser.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
            document.getElementById('profileModal').style.display = 'flex'; toggleMenu();
        }
        function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }
        function handleUpdateProfile() {
            const newName = document.getElementById('edit-name').value;
            const newPass = document.getElementById('edit-pass').value;
            const newGender = document.getElementById('edit-gender').value;
            if (!newName || !newPass) return alert("Please enter name and password!");
            let finalImg = currentUser.img;
            if (newGender !== currentUser.gender) finalImg = newGender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png';
            const updates = { name: newName, pass: newPass, gender: newGender, img: finalImg };
            db.ref('users/' + currentUser.id).update(updates).then(() => {
                alert("Profile updated successfully!"); closeProfileModal(); initDashboard();
            }).catch(err => alert("Error: " + err.message));
        }
        function initDashboard() {
            showPage('dashboard-page');
            if (currentUser) {
                const welcomeBox = document.getElementById('welcome-text');
                if (welcomeBox) welcomeBox.innerHTML = `<img src="${currentUser.img}" alt="Profile" style="width:35px; height:35px; border-radius:50%; object-fit:cover;"><span style="font-weight:600; font-size:15px;">${currentUser.name}</span>`;
                // Fix: Check for both 'teacher' and 'admin' roles
                if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
                    if (document.getElementById('student-tracker-card')) document.getElementById('student-tracker-card').classList.add('hidden');
                    if (document.getElementById('teacher-panel')) document.getElementById('teacher-panel').classList.remove('hidden');
                    if (document.getElementById('student-global-progress')) document.getElementById('student-global-progress').classList.add('hidden');
                    if (document.getElementById('leaderboard-card')) document.getElementById('leaderboard-card').classList.add('hidden');
                    if (document.getElementById('admin-summary-controls')) document.getElementById('admin-summary-controls').classList.add('hidden');
                    if (document.getElementById('notif-btn')) document.getElementById('notif-btn').classList.remove('hidden');
                    updateAdminDashboard();
                } else {
                    if (document.getElementById('student-tracker-card')) document.getElementById('student-tracker-card').classList.remove('hidden');
                    if (document.getElementById('teacher-panel')) document.getElementById('teacher-panel').classList.add('hidden');
                    if (document.getElementById('student-global-progress')) document.getElementById('student-global-progress').classList.remove('hidden');
                    if (document.getElementById('leaderboard-card')) document.getElementById('leaderboard-card').classList.remove('hidden');
                    if (document.getElementById('admin-summary-controls')) document.getElementById('admin-summary-controls').classList.add('hidden');
                    if (document.getElementById('notif-btn')) document.getElementById('notif-btn').classList.add('hidden');
                    if (localStorage.getItem('study_mode_persistent') === 'true') {
                        isStudyMode = false; toggleStudyMode();
                        const savedSubject = localStorage.getItem('active_study_subject');
                        if (savedSubject) enterStudySession(savedSubject);
                    }
                }
            }
            renderSubjectBtns(); updateGlobalUI();
            setInterval(() => { if (currentUser && currentUser.role !== 'teacher') db.ref('users/' + currentUser.id + '/lastSeen').set(Date.now()); }, 1000);
        }
        function openApprovalModal() { document.getElementById('approvalModal').style.display = 'flex'; }
        function closeApprovalModal() { document.getElementById('approvalModal').style.display = 'none'; }
        function renderApprovalList(reqs) {
            const list = document.getElementById('approval-list'); list.innerHTML = "";
            if (reqs.length === 0) { list.innerHTML = "<p style='padding:20px; color:var(--text-muted); font-size:14px;'>কোনো নতুন রিকোয়েস্ট নেই।</p>"; return; }
            reqs.forEach(user => {
                const item = document.createElement('div'); item.className = "approval-item";
                item.innerHTML = `<div class="approval-info"><h4>${user.name}</h4><p>${user.id.replace(/_/g, '.')}</p></div><div class="approval-btns"><button class="btn-approve-small" onclick="approveUser('${user.id}')">Approve</button><button class="btn-del-small" onclick="confirmDelete('${user.id}')">Delete</button></div>`;
                list.appendChild(item);
            });
        }
        function approveUser(uid) { db.ref('users/' + uid).update({ isApproved: true }).then(() => alert("অ্যাকাউন্টটি সফলভাবে অ্যাপ্রুভ করা হয়েছে।")); }
        function closeAdminConfirm() { document.getElementById('adminConfirmModal').style.display = 'none'; }
        function confirmBan(uid) {
            const user = allUsers[uid]; const modal = document.getElementById('adminConfirmModal');
            const icon = document.getElementById('confirm-icon'); const msg = document.getElementById('confirm-msg');
            const yesBtn = document.getElementById('confirm-yes-btn');
            icon.className = "fas fa-user-slash"; icon.style.color = "var(--warning)";
            msg.innerText = user.isBanned ? `আপনি কি ${user.name}-এর ব্যান তুলে নিতে চান?` : `আপনি কি ${user.name}-কে ব্যান করতে চান? সে আর ওয়েবসাইট অ্যাক্সেস করতে পারবে না।`;
            yesBtn.onclick = () => { db.ref('users/' + uid).update({ isBanned: !user.isBanned }); closeAdminConfirm(); closeSummary(); };
            modal.style.display = "flex";
        }
        function confirmDelete(uid) {
            const user = allUsers[uid]; const modal = document.getElementById('adminConfirmModal');
            const icon = document.getElementById('confirm-icon'); const msg = document.getElementById('confirm-msg');
            const yesBtn = document.getElementById('confirm-yes-btn');
            icon.className = "fas fa-trash-alt"; icon.style.color = "var(--danger)";
            msg.innerText = `আপনি কি ${user.name}-কে ওয়েবসাইট থেকে ডিলিট করে দিতে চান? এই ইউজার এই ডিভাইস থেকে আর কখনোই ঢুকতে পারবে না।`;
            yesBtn.onclick = () => { db.ref('users/' + uid).remove().then(() => { alert("ইউজার সফলভাবে ডিলিট করা হয়েছে।"); closeAdminConfirm(); closeSummary(); closeApprovalModal(); }); };
            modal.style.display = "flex";
        }
        function renderSubjectBtns() {
            const container = document.getElementById('subject-btns'); if (!container) return; container.innerHTML = "";
            Object.keys(syllabusData).forEach(sub => {
                const perc = calculateSubjectProgress(sub, currentUser);
                const btn = document.createElement('div'); btn.className = `subject-btn ${selectedSub === sub ? 'active' : ''}`;
                btn.innerHTML = `<div style="font-weight:bold; font-size:15px; margin-bottom:2px;">${perc.toFixed(0)}%</div><span style="font-size:12px">${sub}</span><div class="prog-mini-bar" style="width: ${perc}%"></div>`;
                btn.onclick = () => selectSubject(sub); container.appendChild(btn);
            });
        }
        function selectSubject(sub) {
            if (isTimerRunning) return alert("টাইমার বন্ধ না করে আপনি সাবজেক্ট পরিবর্তন করতে পারবেন না।");
            selectedSub = sub; document.getElementById('syllabus-container').classList.remove('hidden');
            renderSubjectBtns(); selectedPaper = subjectStates[sub] || "";
            const paperTabs = document.getElementById('paper-tabs'); paperTabs.innerHTML = "";
            Object.keys(syllabusData[sub]).forEach(paper => {
                const tab = document.createElement('div'); tab.className = `tab ${selectedPaper === paper ? 'active' : ''}`;
                tab.innerText = `${paper} (${syllabusData[sub][paper].length}টি অধ্যায়)`;
                tab.onclick = () => selectPaper(paper);
                paperTabs.appendChild(tab);
            });
            if (!selectedPaper || !syllabusData[sub][selectedPaper]) selectPaper(Object.keys(syllabusData[sub])[0]); else renderChapters();
        }
        function selectPaper(paper) {
            selectedPaper = paper; subjectStates[selectedSub] = paper;
            localStorage.setItem('subjectStates', JSON.stringify(subjectStates));
            document.querySelectorAll('.tab').forEach(t => { t.innerText.includes(paper) ? t.classList.add('active') : t.classList.remove('active'); });
            setTimeout(() => { renderChapters(); }, 10);
        }
        function renderChapters() {
            const list = document.getElementById('chapter-list'); list.innerHTML = "";
            document.getElementById('active-title').innerText = `${selectedSub} - ${selectedPaper}`;
            const chapters = syllabusData[selectedSub][selectedPaper];
            const subList = ["পদার্থবিজ্ঞান", "রসায়ন", "জীববিজ্ঞান"];
            const isSpecialSub = subList.includes(selectedSub);
            chapters.forEach((ch, i) => {
                const key = `${selectedSub}-${selectedPaper}`;
                const data = (currentUser.trackerData && currentUser.trackerData[key] && currentUser.trackerData[key][i]) || { done: false, parts: { k: false, kh: false, g: false, gh: false } };
                const li = document.createElement('li');
                let html = `<div style="display:flex; align-items:center; gap:8px; flex:1;"><input type="checkbox" class="main-ch-check" ${data.done ? 'checked' : ''} onchange="toggleChapter(${i}, this.checked)"><span style="font-weight:500;">${ch}</span></div>`;
                if (isSpecialSub) html += `<div class="sub-check-group"><div class="sub-box ${data.parts?.k ? 'checked' : ''}" onclick="toggleSubPart(${i}, 'k', this)">ক</div><div class="sub-box ${data.parts?.kh ? 'checked' : ''}" onclick="toggleSubPart(${i}, 'kh', this)">খ</div><div class="sub-box ${data.parts?.g ? 'checked' : ''}" onclick="toggleSubPart(${i}, 'g', this)">গ</div><div class="sub-box ${data.parts?.gh ? 'checked' : ''}" onclick="toggleSubPart(${i}, 'gh', this)">ঘ</div></div>`;
                li.innerHTML = html; list.appendChild(li);
            });
            updatePaperUI();
        }
        function toggleSubPart(index, part, element) {
            element.classList.toggle('checked'); const key = `${selectedSub}-${selectedPaper}`;
            if (!currentUser.trackerData) currentUser.trackerData = {};
            if (!currentUser.trackerData[key]) currentUser.trackerData[key] = {};
            if (!currentUser.trackerData[key][index]) currentUser.trackerData[key][index] = { done: false, parts: { k: false, kh: false, g: false, gh: false } };
            const currentParts = currentUser.trackerData[key][index].parts || { k: false, kh: false, g: false, gh: false };
            currentParts[part] = !currentParts[part]; currentUser.trackerData[key][index].parts = currentParts;
            currentUser.trackerData[key][index].done = currentParts.k && currentParts.kh && currentParts.g && currentParts.gh;
            updateGlobalUI(); db.ref('users/' + currentUser.id).update(currentUser).then(() => renderChapters());
        }
        function toggleChapter(index, isDone) {
            const key = `${selectedSub}-${selectedPaper}`;
            if (!currentUser.trackerData) currentUser.trackerData = {};
            if (!currentUser.trackerData[key]) currentUser.trackerData[key] = {};
            if (!currentUser.trackerData[key][index]) currentUser.trackerData[key][index] = { done: false, parts: { k: false, kh: false, g: false, gh: false } };
            currentUser.trackerData[key][index].done = isDone;
            if (isDone) currentUser.trackerData[key][index].parts = { k: true, kh: true, g: true, gh: true };
            updateGlobalUI(); db.ref('users/' + currentUser.id).update(currentUser).then(() => renderChapters());
        }
        function bulkCheck(status) {
            const chapters = syllabusData[selectedSub][selectedPaper]; const key = `${selectedSub}-${selectedPaper}`;
            if (!currentUser.trackerData) currentUser.trackerData = {};
            if (!currentUser.trackerData[key]) currentUser.trackerData[key] = {};
            chapters.forEach((_, i) => { currentUser.trackerData[key][i] = { done: status, parts: { k: status, kh: status, g: status, gh: status } }; });
            updateGlobalUI(); db.ref('users/' + currentUser.id).update(currentUser).then(() => renderChapters());
        }
        function updatePaperUI() {
            const perc = calculatePaperPercentage(selectedSub, selectedPaper, currentUser);
            const fill = document.getElementById('paper-progress-fill'); if (fill) fill.style.width = perc + "%";
            const percText = document.getElementById('paper-perc-text'); if (percText) percText.innerText = (perc % 1 === 0 ? perc.toFixed(0) : perc.toFixed(1)) + "%";
        }
        function calculatePaperPercentage(sub, paper, user) {
            const chapters = syllabusData[sub][paper]; const key = `${sub}-${paper}`;
            const subList = ["পদার্থবিজ্ঞান", "রসায়ন", "জীববিজ্ঞান"];
            let score = 0;
            chapters.forEach((_, i) => {
                const data = (user.trackerData && user.trackerData[key] && user.trackerData[key][i]);
                if (data) {
                    if (subList.includes(sub)) {
                        const parts = data.parts || { k: false, kh: false, g: false, gh: false };
                        if (parts.k) score += 0.25; if (parts.kh) score += 0.25; if (parts.g) score += 0.25; if (parts.gh) score += 0.25;
                    } else if (data.done) score += 1;
                }
            });
            return (score / chapters.length) * 100 || 0;
        }
        function calculateSubjectProgress(sub, user) {
            let totalPerc = 0; const papers = Object.keys(syllabusData[sub]);
            papers.forEach(p => totalPerc += calculatePaperPercentage(sub, p, user));
            return totalPerc / papers.length || 0;
        }
        function updateGlobalUI() {
            if (!currentUser) return;
            let totalScore = 0; const subs = Object.keys(syllabusData);
            subs.forEach(s => totalScore += calculateSubjectProgress(s, currentUser));
            const avgRaw = totalScore / subs.length; currentUser.progress = parseFloat(avgRaw.toFixed(2));
            const globalText = document.getElementById('global-perc-text'); if (globalText) globalText.innerText = (avgRaw % 1 === 0 ? avgRaw.toFixed(0) : avgRaw.toFixed(1)) + "%";
            const globalFill = document.getElementById('global-progress-fill'); if (globalFill) globalFill.style.width = avgRaw + "%";
            const miniBars = document.querySelectorAll('.prog-mini-bar');
            Object.keys(syllabusData).forEach((sub, idx) => {
                const subPerc = calculateSubjectProgress(sub, currentUser); if (miniBars[idx]) miniBars[idx].style.width = subPerc + "%";
            });
        }

        function calculateTotalStudyTime(user) {
            if (!user || !user.studyTime) return 0;
            let totalTime = 0;
            Object.keys(user.studyTime).forEach(subject => {
                totalTime += user.studyTime[subject] || 0;
            });
            return totalTime;
        }

        function setLeaderboardFilter(filterType, btnElement) {
            currentLeaderboardFilter = filterType;
            document.querySelectorAll('.time-filter-btn').forEach(btn => btn.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');

            renderLeaderboard();
        }

        function formatTime(totalSeconds) {
            if (!totalSeconds) return "00:00:00";
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list'); if (!list) return;
            const searchTerm = document.getElementById('leaderboard-search').value.toLowerCase();
            list.innerHTML = ""; const userArray = Object.values(allUsers);

            const activeSubject = localStorage.getItem('active_study_subject');
            const showStudyTime = isStudyMode;

            const sorted = userArray.filter(u => u.role === 'student' && u.name.toLowerCase().includes(searchTerm) && u.isApproved !== false);

            if (showStudyTime) {
                sorted.sort((a, b) => {
                    let timeA, timeB;

                    if (activeSubject) {
                        timeA = calculateStudyTime(a, activeSubject, currentLeaderboardFilter);
                        timeB = calculateStudyTime(b, activeSubject, currentLeaderboardFilter);
                    } else {
                        timeA = calculateStudyTime(a, null, currentLeaderboardFilter);
                        timeB = calculateStudyTime(b, null, currentLeaderboardFilter);
                    }

                    // Add current session time for current user if timer is running
                    if (currentUser && a.id === currentUser.id && isTimerRunning) {
                        if (!activeSubject || activeSubject === localStorage.getItem('active_study_subject')) {
                            timeA += studySeconds;
                        }
                    }

                    return timeB - timeA;
                });
            } else {
                sorted.sort((a, b) => b.progress - a.progress);
            }

            if (sorted.length === 0) { list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:14px;">কোনো স্টুডেন্ট পাওয়া যায়নি!</div>`; return; }
            sorted.forEach((u, idx) => {
                const isOnline = (Date.now() - u.lastSeen) < 12000;
                const avatar = u.img || (u.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');

                let displayValue = "";
                let valueStyle = "";

                if (showStudyTime) {
                    let timeSec = 0;

                    if (activeSubject) {
                        timeSec = calculateStudyTime(u, activeSubject, currentLeaderboardFilter);
                        if (currentUser && u.id === currentUser.id && isTimerRunning && activeSubject === localStorage.getItem('active_study_subject')) {
                            timeSec += studySeconds;
                        }
                    } else {
                        timeSec = calculateStudyTime(u, null, currentLeaderboardFilter);
                        if (currentUser && u.id === currentUser.id && isTimerRunning) {
                            timeSec += studySeconds;
                        }
                    }
                    displayValue = formatTime(timeSec);
                    valueStyle = "font-weight:bold; color:var(--primary); font-size:14px";
                } else {
                    displayValue = `${u.progress}%`;
                    valueStyle = "font-weight:bold; color:var(--primary); font-size:14px";
                }

                const div = document.createElement('div'); div.className = "leader-row"; div.onclick = () => viewSummary(u.id);
                div.innerHTML = `<div class="leader-info"><span style="font-weight:bold; width:18px; font-size:12px">${idx + 1}.</span><img src="${avatar}" class="leader-img" style="width:35px; height:35px; border-radius:50%; object-fit:cover;"><div><div style="font-size:13px; font-weight:600">${u.name} ${currentUser && u.id === currentUser.id ? '(You)' : ''}</div><div style="font-size:9px; display:flex; align-items:center; gap:4px"><span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? 'Active' : 'Offline'}</div></div></div><div style="text-align:right"><div style="${valueStyle}">${displayValue}</div>${u.isBanned ? '<span style="color:var(--danger); font-size:9px; font-weight:bold;">BANNED</span>' : ''}</div>`;
                list.appendChild(div);
            });
        }

        function switchSummaryMode(mode) {
            currentSummaryMode = mode;
            document.getElementById('btn-mode-study-time').classList.toggle('active', mode === 'study');
            document.getElementById('btn-mode-subject-time').classList.toggle('active', mode === 'subject');

            document.getElementById('view-study-time').classList.toggle('active', mode === 'study');
            document.getElementById('view-subject-time').classList.toggle('active', mode === 'subject');

            if (activeSummaryUid) viewSummary(activeSummaryUid);
        }

        function filterSubjectTime(filterType, element) {
            currentSubjectTimeFilter = filterType;
            document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('active'));
            if (element) element.classList.add('active');

            if (activeSummaryUid) viewSummary(activeSummaryUid);
        }

        function getLiveStudyTime(user, subjectName) {
            if (currentUser && user.id === currentUser.id && isTimerRunning) {
                const activeSubject = localStorage.getItem('active_study_subject');
                if (!subjectName || activeSubject === subjectName) {
                    return studySeconds;
                }
            }
            return 0;
        }

        function viewSummary(uid) {
            activeSummaryUid = uid; const user = allUsers[uid]; if (!user) return;
            const modal = document.getElementById('summaryModal'); const header = document.getElementById('summary-header');
            const body = document.getElementById('summary-body');

            // UI Update is instant
            modal.style.display = 'flex';

            if (currentUser && currentUser.role === 'teacher') {
                document.getElementById('summary-ban-btn').innerText = user.isBanned ? 'ব্যান তুলুন' : 'ব্যান করুন';
                document.getElementById('summary-ban-btn').onclick = (e) => { e.stopPropagation(); confirmBan(uid); };
                document.getElementById('summary-del-btn').onclick = (e) => { e.stopPropagation(); confirmDelete(uid); };
            }
            const avatar = user.img || (user.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');

            // --- USE PRE-CACHED DATA FOR INSTANT LOADING ---
            const now = new Date();
            const year = now.getFullYear();
            const monthIdx = now.getMonth();
            const monthNames = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
            const currentMonthName = monthNames[monthIdx];
            const monthStr = (monthIdx + 1).toString().padStart(2, '0');

            // Calculate Attendance from cached globalAttendanceData
            let totalClasses = 0;
            let presentCount = 0;
            Object.keys(globalAttendanceData).forEach(date => {
                if (date.startsWith(`${year}-${monthStr}`)) {
                    totalClasses++;
                    if (globalAttendanceData[date][uid]) presentCount++;
                }
            });
            let absentCount = Math.max(0, totalClasses - presentCount);

            // Fetch Payment from cached globalPaymentData
            const payData = globalPaymentData[uid] || { status: 'due', amount: 1000 };
            const paymentStatusText = payData.status === 'paid' ? `<span style="color:var(--success)">পেইড (${convertToBengaliDigit(payData.amount)} টাকা)</span>` : `<span style="color:var(--danger)">বাকি (${convertToBengaliDigit(payData.amount)} টাকা)</span>`;

            // Last Active & Entry
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('bn-BD', { hour12: true, day: 'numeric', month: 'short', year: 'numeric' }) : 'তথ্য নেই';
            const lastActiveText = formatDetailedTimeAgo(user.lastSeen);

            header.innerHTML = `
                <div style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                        <img src="${avatar}" style="width:65px; height:65px; border-radius:50%; border:3px solid var(--primary); object-fit:cover; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div>
                            <h3 style="color:var(--text-main); font-size:20px; margin-bottom: 2px; font-weight:700;">${user.name}</h3>
                            <p style="font-size:13px; color:var(--text-muted);">সার্বিক অগ্রগতি: <b style="color:var(--primary); font-size:15px;">${user.progress}%</b></p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-top: 10px;">
                        <!-- Month Card -->
                        <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; font-weight:700;">মাসের নাম</div>
                            <div style="font-size: 15px; font-weight: 700; color: var(--primary);">${currentMonthName}</div>
                        </div>
                        
                        <!-- Attendance Grid Card -->
                        <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); grid-column: span 2; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                            <div style="flex: 1; text-align: center; border-right: 1px solid var(--border);">
                                <div style="font-size: 9px; color: var(--text-muted); font-weight:600;">মোট ক্লাস</div>
                                <div style="font-size: 15px; font-weight: 700;">${convertToBengaliDigit(totalClasses)}</div>
                            </div>
                            <div style="flex: 1; text-align: center; border-right: 1px solid var(--border);">
                                <div style="font-size: 9px; color: var(--success); font-weight:600;">উপস্থিত</div>
                                <div style="font-size: 15px; font-weight: 700; color: var(--success);">${convertToBengaliDigit(presentCount)}</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 9px; color: var(--danger); font-weight:600;">অনুপস্থিত</div>
                                <div style="font-size: 15px; font-weight: 700; color: var(--danger);">${convertToBengaliDigit(absentCount)}</div>
                            </div>
                        </div>

                        <!-- Payment Card -->
                        <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); grid-column: 1 / -1; display:flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                             <div>
                                <div style="font-size: 10px; color: var(--text-muted); font-weight:700;">পেমেন্ট স্ট্যাটাস (${currentMonthName})</div>
                                <div style="font-size: 14px; font-weight: 700;">${paymentStatusText}</div>
                             </div>
                             <i class="fas fa-money-bill-wave" style="font-size: 18px; opacity: 0.15; color: var(--primary);"></i>
                        </div>

                        <!-- Time Tracker Card -->
                        <div style="background: var(--bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); grid-column: 1 / -1; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                            <div style="display: flex; gap: 12px; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                                <i class="fas fa-sign-in-alt" style="margin-top: 3px; color: var(--primary); font-size:14px;"></i>
                                <div>
                                    <div style="font-size: 10px; color: var(--text-muted); font-weight:700;">ওয়েবসাইটে শেষ প্রবেশ</div>
                                    <div style="font-size: 13px; font-weight: 600;">${lastLogin}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <i class="fas fa-clock" style="margin-top: 3px; color: var(--success); font-size:14px;"></i>
                                <div>
                                    <div style="font-size: 10px; color: var(--text-muted); font-weight:700;">লাস্ট একটিভ</div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--success);">${lastActiveText}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Render stats based on time filter - using calculateStudyTime
            let time24h = calculateStudyTime(user, null, '24h') + getLiveStudyTime(user);
            let time7d = calculateStudyTime(user, null, '7d') + getLiveStudyTime(user);
            let time1m = calculateStudyTime(user, null, '1m') + getLiveStudyTime(user);
            let timeLifetime = calculateStudyTime(user, null, 'lifetime') + getLiveStudyTime(user);

            document.getElementById('stat-24h').innerText = formatTime(time24h);
            document.getElementById('stat-7d').innerText = formatTime(time7d);
            document.getElementById('stat-1m').innerText = formatTime(time1m);
            document.getElementById('stat-lifetime').innerText = formatTime(timeLifetime);

            const subjectListDiv = document.getElementById('subject-time-list');
            subjectListDiv.innerHTML = "";

            const allSubjects = ["পদার্থবিজ্ঞান", "রসায়ন", "জীববিজ্ঞান", "উচ্চতর গণিত", "বাংলা", "ইংরেজি", "ICT"];

            allSubjects.forEach(sub => {
                let subTime = calculateStudyTime(user, sub, currentSubjectTimeFilter);
                subTime += getLiveStudyTime(user, sub);

                const item = document.createElement('div');
                item.className = "subject-time-item";
                item.innerHTML = `
                <span class="subject-name">${sub}</span>
                <span class="subject-time-val">${formatTime(subTime)}</span>
            `;
                subjectListDiv.appendChild(item);
            });

            body.innerHTML = "";
            Object.keys(syllabusData).forEach(sub => {
                Object.keys(syllabusData[sub]).forEach(paper => {
                    const perc = calculatePaperPercentage(sub, paper, user); const item = document.createElement('div');
                    item.className = "summary-item"; const safeKey = `${sub.replace(/\s+/g, '')}-${paper.replace(/\s+/g, '')}`;
                    let detailsHtml = ""; const key = `${sub}-${paper}`; const chapters = syllabusData[sub][paper];
                    const subList = ["পদার্থবিজ্ঞান", "রসায়ন", "জীববিজ্ঞান"];
                    chapters.forEach((ch, idx) => {
                        const chData = (user.trackerData && user.trackerData[key] && user.trackerData[key][idx]);
                        let icon = chData?.done ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : '<i class="far fa-circle" style="color:#cbd5e1"></i>';
                        let partsBoxes = "";
                        if (subList.includes(sub)) {
                            const p = chData?.parts || { k: false, kh: false, g: false, gh: false };
                            partsBoxes = `<div class="mini-check-group"><div class="mini-box ${p.k ? 'active' : ''}">ক</div><div class="mini-box ${p.kh ? 'active' : ''}">খ</div><div class="mini-box ${p.g ? 'active' : ''}">গ</div><div class="mini-box ${p.gh ? 'active' : ''}">ঘ</div></div>`;
                        }
                        detailsHtml += `<div class="detail-row"><span class="ch-name-small">${icon} ${ch}</span>${partsBoxes}</div>`;
                    });
                    const isOpened = openedDetails.has(safeKey);
                    item.innerHTML = `<h5>${sub} (${paper})</h5><div class="progress-container" style="height:6px; margin-bottom:5px;"><div class="progress-fill" style="width:${perc}%"></div></div><div style="display:flex; justify-content:space-between; font-size:11px;"><span>সম্পন্ন: ${perc.toFixed(1)}%</span><span>${chapters.length} অধ্যায় <i class="fas ${isOpened ? 'fa-chevron-up' : 'fa-chevron-down'}"></i></span></div><div class="chapter-detail-box" id="detail-${safeKey}" style="display: ${isOpened ? 'block' : 'none'}">${detailsHtml}</div>`;
                    item.onclick = (e) => {
                        const detailBox = item.querySelector('.chapter-detail-box'); const isVisible = detailBox.style.display === "block";
                        detailBox.style.display = isVisible ? "none" : "block";
                        const icon = item.querySelector('.fa-chevron-down') || item.querySelector('.fa-chevron-up');
                        isVisible ? (openedDetails.delete(safeKey), icon.className = "fas fa-chevron-down") : (openedDetails.add(safeKey), icon.className = "fas fa-chevron-up");
                    };
                    body.appendChild(item);
                });
            });
            modal.style.display = "flex";
        }

        function updateSummaryLiveTime() {
            if (!activeSummaryUid || activeSummaryUid !== currentUser.id || !currentUser) return;
            if (document.getElementById('summaryModal').style.display !== 'flex') return;

            // Update stats based on filter - using calculateStudyTime
            let time24h = calculateStudyTime(currentUser, null, '24h') + studySeconds;
            let time7d = calculateStudyTime(currentUser, null, '7d') + studySeconds;
            let time1m = calculateStudyTime(currentUser, null, '1m') + studySeconds;
            let timeLifetime = calculateStudyTime(currentUser, null, 'lifetime') + studySeconds;

            document.getElementById('stat-24h').innerText = formatTime(time24h);
            document.getElementById('stat-7d').innerText = formatTime(time7d);
            document.getElementById('stat-1m').innerText = formatTime(time1m);
            document.getElementById('stat-lifetime').innerText = formatTime(timeLifetime);

            const listItems = document.querySelectorAll('.subject-time-item');
            const allSubjects = ["পদার্থবিজ্ঞান", "রসায়ন", "জীববিজ্ঞান", "উচ্চতর গণিত", "বাংলা", "ইংরেজি", "ICT"];

            listItems.forEach((item, index) => {
                if (allSubjects[index]) {
                    const sub = allSubjects[index];
                    let subTime = calculateStudyTime(currentUser, sub, currentSubjectTimeFilter);

                    const activeSubject = localStorage.getItem('active_study_subject');
                    if (activeSubject === sub) {
                        subTime += studySeconds;
                    }

                    const valSpan = item.querySelector('.subject-time-val');
                    if (valSpan) valSpan.innerText = formatTime(subTime);
                }
            });
        }

        function closeSummary() { document.getElementById('summaryModal').style.display = 'none'; activeSummaryUid = null; openedDetails.clear(); }
        function toggleDarkMode() {
            document.body.classList.toggle('dark'); document.documentElement.classList.toggle('dark');
            localStorage.setItem('dark_mode', document.body.classList.contains('dark'));
        }
        (function instantLoad() {
            if (localStorage.getItem('device_blocked')) return showPage('device-blocked-screen');
            if (localStorage.getItem('dark_mode') === 'true') { document.body.classList.add('dark'); document.documentElement.classList.add('dark'); }
            const savedUid = localStorage.getItem('hsc_uid');
            if (savedUid) {
                if (savedUid === "teacher20189@gmail_com") {
                    currentUser = { id: savedUid, name: "Teacher", role: 'teacher', gender: 'male', progress: 0, isApproved: true };
                    initDashboard(); finalizePage(); return;
                }
                db.ref('users/' + savedUid).once('value', snapshot => {
                    currentUser = snapshot.val();
                    if (currentUser) { if (currentUser.isBanned) showPage('banned-screen'); else if (currentUser.role === 'student' && currentUser.isApproved === false) showPage('waiting-room-screen'); else initDashboard(); }
                    else { localStorage.removeItem('hsc_uid'); showPage('login-page'); }
                    finalizePage();
                });
            } else { showPage('login-page'); if (!localStorage.getItem("master_auth")) showLoginModal(); finalizePage(); }
        })();



        function toggleStudentAttendance(uid, element) {
            // Toggle state
            if (attendanceData[uid]) {
                attendanceData[uid] = false;
                element.classList.remove('present');
                const icon = element.querySelector('.fa-check-circle');
                if (icon) icon.remove();
            } else {
                attendanceData[uid] = true;
                element.classList.add('present');
                element.innerHTML += '<i class="fas fa-check-circle" style="position:absolute; top:5px; right:5px; color:white; font-size:12px;"></i>';
            }
        }

        function saveAttendance() {
            const dateInput = document.getElementById('att-date-picker').value;
            if (!dateInput) return alert("তারিখ নির্বাচন করুন!");

            db.ref('attendance/' + dateInput).set(attendanceData)
                .then(() => {
                    alert(`✅ ${dateInput} তারিখের অ্যাটেন্ডেন্স সফলভাবে সেভ করা হয়েছে!`);
                })
                .catch(err => alert("Error: " + err.message));
        }

        /* --- INACTIVITY WARN SYSTEM LOGIC --- */
        let inactivityFilter = 'all';
        let inactivitySearch = '';
        let inactivityDayThreshold = 3;
        let selectedStudentId = null;

        // Load Students for Inactivity Panel
        function loadStudents() {
            const loadingState = document.getElementById('inactivityLoadingState');
            const studentsGrid = document.getElementById('studentsGrid');

            if (loadingState) loadingState.classList.remove('hidden');
            if (studentsGrid) studentsGrid.innerHTML = '';

            // Artificial delay to show loading state (optional, can be removed)
            setTimeout(() => {
                updateInactivityStats();
                renderInactivityStudents();
                if (loadingState) loadingState.classList.add('hidden');
            }, 500);
        }

        // Update Stats
        function updateInactivityStats() {
            const students = Object.values(allUsers).filter(u => u.role === 'student' && !u.isBanned && u.isApproved !== false);

            const warning = students.filter(s => getInactiveDays(s.lastSeen || 0) >= 1 && getInactiveDays(s.lastSeen || 0) <= 2).length;
            const danger = students.filter(s => getInactiveDays(s.lastSeen || 0) >= 3 && getInactiveDays(s.lastSeen || 0) <= 5).length;
            const critical = students.filter(s => getInactiveDays(s.lastSeen || 0) >= 6).length;

            document.getElementById('totalInactive').textContent = students.length; // Total students tracked
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('dangerCount').textContent = danger;
            document.getElementById('criticalCount').textContent = critical;
        }

        // Get Inactive Days
        function getInactiveDays(lastSeen) {
            if (!lastSeen) return 999; // Treat undefined as very long time
            const now = Date.now();
            const diff = now - lastSeen;
            return Math.floor(diff / (86400000));
        }

        // Get Severity Level
        function getSeverityLevel(days) {
            if (days >= 1 && days <= 2) return 'warning';
            if (days >= 3 && days <= 5) return 'danger';
            if (days >= 6) return 'critical';
            return 'normal';
        }

        // Format Inactivity Time
        function formatInactivityTime(days) {
            if (days >= 999) return 'কখনও না';
            if (days === 0) return 'আজ';
            if (days === 1) return '১ দিন';
            if (days < 7) return `${days} দিন`;
            const weeks = Math.floor(days / 7);
            const remainingDays = days % 7;
            if (remainingDays === 0) return `${weeks} সপ্তাহ`;
            return `${weeks} সপ্তাহ ${remainingDays} দিন`;
        }

        // Render Students
        function renderInactivityStudents() {
            const grid = document.getElementById('studentsGrid');
            if (!grid) return;

            const filteredStudents = filterAndSearchInactivityStudents();

            if (filteredStudents.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-check-circle"></i>
                        <h3>সব শিক্ষার্থী একটিভ!</h3>
                        <p>কোনো শিক্ষার্থী এই ফিল্টার অনুযায়ী অফলাইন নেই।</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredStudents.map(student => {
                const days = getInactiveDays(student.lastSeen || 0);
                const severity = getSeverityLevel(days);
                const progressPercent = Math.min((days / inactivityDayThreshold) * 100, 100);

                const avatar = student.img || (student.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');

                return `
                    <div class="student-card ${severity}">
                        <div class="student-info">
                            <img src="${avatar}" alt="${student.name}" class="student-avatar">
                            <div class="student-details">
                                <div class="student-name">${student.name}</div>
                                <div class="student-email">${student.id.replace(/_/g, '.')}</div>
                            </div>
                        </div>

                        <div class="student-stats">
                            <div class="stat-row">
                                <span class="stat-label">সর্বশেষ দেখা:</span>
                                <span class="stat-value">${formatInactivityTime(days)} আগে</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">প্রগ্রেস:</span>
                                <span class="stat-value">${student.progress || 0}%</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">স্ট্যাটাস:</span>
                                <span class="stat-value ${severity}-text">
                                    ${severity === 'warning' ? 'সতর্কতা' :
                        severity === 'danger' ? 'বিপদ' :
                            severity === 'critical' ? 'গুরুতর' : 'স্বাভাবিক'}
                                </span>
                            </div>
                        </div>

                        <div class="progress-wrapper">
                            <div class="progress-label">
                                <span>ঝুঁকি মাত্রা</span>
                                <span>${Math.round(progressPercent)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <div class="card-actions">
                            <button class="card-action-btn btn-email" title="ইমেইল পাঠান" onclick="window.open('mailto:${student.id.replace(/_/g, '.')}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="card-action-btn btn-reminder" title="রিমাইন্ডার পাঠান" onclick="openReminderModal('${student.id}')">
                                <i class="fas fa-bell"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter and Search Logic
        function filterAndSearchInactivityStudents() {
            const students = Object.values(allUsers).filter(u => u.role === 'student' && !u.isBanned && u.isApproved !== false);

            return students.filter(student => {
                const days = getInactiveDays(student.lastSeen || 0);
                const severity = getSeverityLevel(days);

                // Filter by Category
                if (inactivityFilter !== 'all' && severity !== inactivityFilter) return false;

                // Filter by Search
                if (inactivitySearch) {
                    const searchLower = inactivitySearch.toLowerCase();
                    const email = student.id.replace(/_/g, '.');
                    return student.name.toLowerCase().includes(searchLower) ||
                        email.toLowerCase().includes(searchLower);
                }

                return true;
            });
        }

        // Filter Button Handler
        function filterStudents(filter) {
            inactivityFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === (
                    filter === 'all' ? 'সব' :
                        filter === 'warning' ? 'সতর্কতা' :
                            filter === 'danger' ? 'বিপদ' : 'গুরুতর'
                ));
            });
            // Manual active class handling fallback if text doesn't match exactly
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const index = ['all', 'warning', 'danger', 'critical'].indexOf(filter);
            if (index >= 0) {
                document.querySelectorAll('.filter-btn')[index].classList.add('active');
            }

            renderInactivityStudents();
        }

        // Search Handler
        function searchStudents(value) {
            inactivitySearch = value;
            renderInactivityStudents();
        }

        // Update Threshold
        function updateThreshold() {
            inactivityDayThreshold = parseInt(document.getElementById('dayThreshold').value);
            renderInactivityStudents(); // Re-calculate risk percentage
        }

        function saveConfig() {
            alert('কনফিগারেশন সেভ করা হয়েছে!');
            // Here you could save to localStorage or Firebase if needed
        }

        // Modal Functions
        function openReminderModal(studentId) {
            selectedStudentId = studentId;
            document.getElementById('reminderModal').style.display = 'flex';
        }

        function showBulkReminderModal() {
            selectedStudentId = 'bulk'; // Flag for bulk
            document.getElementById('reminderModal').style.display = 'flex';
        }

        function closeReminderModal() {
            document.getElementById('reminderModal').style.display = 'none';
            selectedStudentId = null;
            document.getElementById('customMessage').value = '';
            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
        }

        function selectTemplate(id) {
            const templates = {
                1: "কেমন আছ? দীর্ঘ সময় দেখা হচ্ছে না। পড়াশোনায় ঠিক আছ? আমাদের জানাও যদি কোনো সাহায্য লাগে।",
                2: "তোমার প্রগ্রেস আমরা মিস করছি। দ্রুত ফিরে আসো এবং পড়াশোনা চালিয়ে যাও!",
                3: "আমরা লক্ষ্য করেছি তুমি কিছুদিন যাবত অনিয়মিত। কোনো সমস্যা হলে আমাদের জানাতে পারো।"
            };

            document.getElementById('customMessage').value = templates[id];

            document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
            // This assumes the buttons are in order, or we can add IDs to them. 
            // Simple toggle for visual feedback
        }

        function sendReminder() {
            const message = document.getElementById('customMessage').value;
            if (!message) return alert('অনুগ্রহ করে একটি মেসেজ লিখুন বা টেমপ্লেট নির্বাচন করুন।');

            showToast('রিমাইন্ডার সফলভাবে পাঠানো হয়েছে!', 'success');
            closeReminderModal();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgSpan = toast.querySelector('.toast-message');
            const icon = toast.querySelector('.toast-icon');

            msgSpan.textContent = message;
            toast.className = `toast ${type} show`;

            if (type === 'success') {
                icon.className = 'fas fa-check-circle toast-icon';
            } else if (type === 'error' || type === 'danger') {
                icon.className = 'fas fa-exclamation-circle toast-icon';
                if (type === 'danger') toast.classList.add('error');
            } else {
                icon.className = 'fas fa-info-circle toast-icon';
            }

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        /* --- PROFESSIONAL ATTENDANCE DASHBOARD LOGIC --- */
        let proAttData = {};
        let genderCounts = { present: { m: 0, f: 0 }, absent: { m: 0, f: 0 } };

        let proAttRealtimeListener = null;

        function loadProAttendance() {
            const dateInput = document.getElementById('proAttDate');
            if (!dateInput.value) {
                dateInput.valueAsDate = new Date();
            }
            const dateVal = dateInput.value;
            const today = new Date().toLocaleDateString('en-CA');

            document.getElementById('proPresentFolder').innerHTML = '<div class="loader"></div>';
            document.getElementById('proAbsentFolder').innerHTML = '<div class="loader"></div>';

            // Real-time Update for Today
            if (proAttRealtimeListener) db.ref('attendance').off('value', proAttRealtimeListener); // Detach previous generic listener if any (logic fix needed below)

            // Better approach: explicit detaching needs correct path. 
            // Since we change dateVal, we should detach based on stored ref or just use .once() for past dates?
            // For simplicity and "Start Session" feature being mostly for TODAY, we can use .on() if date is today, or just use .on() always for the selected date.

            // Detach previous listener on the specific path if we stored it? 
            // Trying a simple global variable approach for the single active listener
            if (window.currentProAttRef) {
                window.currentProAttRef.off('value');
            }

            const attRef = db.ref('attendance/' + dateVal);
            window.currentProAttRef = attRef;

            attRef.on('value', snapshot => {
                proAttData = snapshot.val() || {};
                renderProAttendance();
            });
        }

        function renderProAttendance() {
            const presentList = document.getElementById('proPresentFolder');
            const absentList = document.getElementById('proAbsentFolder');

            presentList.innerHTML = '';
            absentList.innerHTML = '';

            // Reset Gender Counts
            genderCounts = { present: { m: 0, f: 0 }, absent: { m: 0, f: 0 } };

            const students = Object.values(allUsers).filter(u => u.role === 'student' && !u.isBanned && u.isApproved !== false);

            let presentCount = 0;
            let absentCount = 0;

            students.forEach(student => {
                const isPresent = proAttData[student.id] === true;
                const avatar = student.img || (student.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
                const genderKey = student.gender === 'female' ? 'f' : 'm';

                // Count Gender
                if (isPresent) {
                    genderCounts.present[genderKey]++;
                    presentCount++;
                } else {
                    genderCounts.absent[genderKey]++;
                    absentCount++;
                }

                const card = document.createElement('div');
                card.className = 'pro-att-student-card';
                card.dataset.name = student.name.toLowerCase(); // For search
                card.innerHTML = `
                    <img src="${avatar}" class="student-avatar" style="width:40px;height:40px;border-radius:50%">
                    <div class="student-info" style="flex:1">
                        <div class="student-name" style="font-weight:bold">${student.name}</div>
                        <div class="student-email" style="font-size:11px;color:#64748b">${student.id.replace(/_/g, '.')}</div>
                    </div>
                    <div class="folder-student-actions">
                        ${isPresent ?
                        `<button class="pro-att-btn" style="padding:5px 10px; background:var(--danger); color:white; font-size:10px;" onclick="toggleProAtt('${student.id}', false)">Marks Absent</button>` :
                        `<button class="pro-att-btn" style="padding:5px 10px; background:var(--success); color:white; font-size:10px;" onclick="toggleProAtt('${student.id}', true)">Mark Present</button>`
                    }
                    </div>
                `;

                if (isPresent) {
                    presentList.appendChild(card);
                } else {
                    absentList.appendChild(card);
                }
            });

            // Update Stats
            document.getElementById('proTotalStudents').innerText = students.length;
            document.getElementById('proPresentStudents').innerText = presentCount;
            document.getElementById('proAbsentStudents').innerText = absentCount;
            document.getElementById('proPresentCount').innerText = presentCount + ' জন';
            document.getElementById('proAbsentCount').innerText = absentCount + ' জন';

            const percent = students.length > 0 ? Math.round((presentCount / students.length) * 100) : 0;
            document.getElementById('proAttPercent').innerText = percent + "%";

            // Re-apply search if active
            const pSearch = document.getElementById('searchPresent').value;
            const aSearch = document.getElementById('searchAbsent').value;
            if (pSearch) filterFolder('present', pSearch);
            if (aSearch) filterFolder('absent', aSearch);

            // Update Breakdown if visible
            const breakdown = document.getElementById('proAttDetailedBreakdown');
            const percentBreakdown = document.getElementById('proAttPercentBreakdown');
            const reportBreakdown = document.getElementById('proAttReportBreakdown');

            if (!breakdown.classList.contains('hidden')) renderBreakdown();
            if (!percentBreakdown.classList.contains('hidden')) renderPercentBreakdown();
            if (!reportBreakdown.classList.contains('hidden')) renderReportBreakdown();
        }

        function toggleProAtt(uid, status) {
            proAttData[uid] = status;
            renderProAttendance();
        }

        function saveProAttendance(event) {
            const dateVal = document.getElementById('proAttDate').value;
            const btn = (event && event.currentTarget) ? event.currentTarget : document.querySelector('.pro-att-bottom-actions .btn-primary');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> সেভ হচ্ছে...';
            btn.disabled = true;

            db.ref('attendance/' + dateVal).set(proAttData)
                .then(() => {
                    showToast('অ্যাটেনডেন্স সফলভাবে সংরক্ষণ করা হয়েছে!', 'success');

                    // If report is visible, refresh it
                    const reportBreakdown = document.getElementById('proAttReportBreakdown');
                    if (!reportBreakdown.classList.contains('hidden')) {
                        renderReportBreakdown();
                    }
                })
                .catch(err => {
                    showToast('ত্রুটি: ' + err.message, 'danger');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        /* --- NEW FEATURES LOGIC --- */
        let currentBreakdownType = 'present';
        let currentBreakdownGender = 'm';

        function toggleGenderBreakdown(type) {
            const container = document.getElementById('proAttDetailedBreakdown');
            const percContainer = document.getElementById('proAttPercentBreakdown');
            const reportContainer = document.getElementById('proAttReportBreakdown');
            const cards = document.querySelectorAll('.pro-att-stat-card');

            // Hide other breakdowns
            percContainer.classList.add('hidden');
            reportContainer.classList.add('hidden');
            document.querySelector('.pro-att-stat-card.percentage').style.border = '';

            // Remove active style from all others
            cards.forEach(c => c.style.border = '');

            if (currentBreakdownType === type && !container.classList.contains('hidden')) {
                container.classList.add('hidden');
            } else {
                currentBreakdownType = type;
                container.classList.remove('hidden');

                // Add active border to current card
                const activeCard = document.querySelector(`.pro-att-stat-card.${type}`);
                if (activeCard) activeCard.style.border = '2px dashed var(--primary)';

                document.getElementById('breakdownTitle').innerText = (type === 'present' ? 'উপস্থিত' : 'অনুপস্থিত') + ' শিক্ষার্থীদের বিস্তারিত তথ্য';
                renderBreakdown();
            }
        }

        function switchGenderTab(gender) {
            currentBreakdownGender = gender;
            document.getElementById('tabMale').classList.toggle('active', gender === 'm');
            document.getElementById('tabFemale').classList.toggle('active', gender === 'f');
            renderBreakdown();
        }

        function renderBreakdown() {
            const content = document.getElementById('breakdownContent');
            const counts = { m: 0, f: 0 };

            // Calculate current counts for the selected type
            const students = Object.values(allUsers).filter(u => u.role === 'student' && !u.isBanned && u.isApproved !== false);
            const filteredForType = students.filter(s => {
                const isPresent = proAttData[s.id] === true;
                return currentBreakdownType === 'present' ? isPresent : !isPresent;
            });

            filteredForType.forEach(s => {
                const g = s.gender === 'female' ? 'f' : 'm';
                counts[g]++;
            });

            // Update Tab Counts
            document.getElementById('countMale').innerText = counts.m;
            document.getElementById('countFemale').innerText = counts.f;

            // Render List for Selected Gender
            const list = filteredForType.filter(s => {
                const g = s.gender === 'female' ? 'f' : 'm';
                return g === currentBreakdownGender;
            });

            content.innerHTML = '';
            if (list.length === 0) {
                content.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--text-muted);">এই ক্যাটাগরিতে কোনো শিক্ষার্থী নেই।</div>`;
            } else {
                list.forEach(student => {
                    const avatar = student.img || (student.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
                    const card = document.createElement('div');
                    card.className = 'breakdown-student-card';
                    card.innerHTML = `
                        <img src="${avatar}">
                        <div class="breakdown-student-info">
                            <h5>${student.name}</h5>
                            <p>${student.id.replace(/_/g, '.')}</p>
                        </div>
                    `;
                    content.appendChild(card);
                });
            }
        }

        function renderPercentBreakdown() {
            const total = genderCounts.present.m + genderCounts.present.f + genderCounts.absent.m + genderCounts.absent.f;
            const maleTotal = genderCounts.present.m + genderCounts.absent.m;
            const femaleTotal = genderCounts.present.f + genderCounts.absent.f;

            const mPresentPerc = maleTotal > 0 ? Math.round((genderCounts.present.m / maleTotal) * 100) : 0;
            const mAbsentPerc = maleTotal > 0 ? (100 - mPresentPerc) : 0;
            const fPresentPerc = femaleTotal > 0 ? Math.round((genderCounts.present.f / femaleTotal) * 100) : 0;
            const fAbsentPerc = femaleTotal > 0 ? (100 - fPresentPerc) : 0;

            // Update Bars
            document.getElementById('barMalePresent').style.width = mPresentPerc + '%';
            document.getElementById('barMaleAbsent').style.width = mAbsentPerc + '%';
            document.getElementById('barFemalePresent').style.width = fPresentPerc + '%';
            document.getElementById('barFemaleAbsent').style.width = fAbsentPerc + '%';

            // Update Text
            document.getElementById('txtMalePresent').innerText = mPresentPerc + '%';
            document.getElementById('txtMaleAbsent').innerText = mAbsentPerc + '%';
            document.getElementById('txtFemalePresent').innerText = fPresentPerc + '%';
            document.getElementById('txtFemaleAbsent').innerText = fAbsentPerc + '%';
        }

        function resetProAttendance(event) {
            openResetModal();
        }

        /* --- BATCH PAYMENT MANAGEMENT LOGIC --- */
        let currentPaymentData = {};
        let paymentSearchQueries = { paid: '', due: '' };

        function loadPaymentData() {
            const month = document.getElementById('payMonthSelector').value;
            const batch = 'all';
            const year = new Date().getFullYear();
            const path = `payments/${month}_${year}`;

            // Set initial counts to loading
            document.getElementById('payTotalCount').innerText = '...';
            document.getElementById('payPaidCount').innerText = '...';
            document.getElementById('payDueCount').innerText = '...';

            db.ref(path).once('value', snapshot => {
                currentPaymentData = snapshot.val() || {};
                renderPaymentLists(batch);
            });
        }

        function renderPaymentLists(batchFilter) {
            const paidList = document.getElementById('payPaidList');
            const dueList = document.getElementById('payDueList');

            paidList.innerHTML = '';
            dueList.innerHTML = '';

            const students = Object.values(allUsers).filter(u =>
                u.role === 'student' &&
                !u.isBanned &&
                u.isApproved !== false &&
                (batchFilter === 'all' || u.batch === batchFilter)
            );

            let paidCount = 0;
            let dueCount = 0;

            students.forEach(student => {
                const status = currentPaymentData[student.id] || { status: 'due' };
                const isPaid = status.status === 'paid';

                const avatar = student.img || (student.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
                const card = document.createElement('div');
                card.className = 'pay-student-card';
                card.dataset.name = student.name.toLowerCase();
                card.dataset.id = student.id.toLowerCase();

                let metaInfo = isPaid
                    ? `<div class="pay-meta">৳${(status.amount || 1000).toLocaleString()} • ${status.date || ''}</div>`
                    : `<div class="pay-meta" style="color:var(--danger)">৳${(status.amount || 1000).toLocaleString()} • পেমেন্ট বাকি</div>`;

                card.innerHTML = `
                        <img src="${avatar}" class="pay-avatar">
                        <div class="pay-info">
                            <div class="pay-name">${student.name}</div>
                            ${metaInfo}
                        </div>
                        <div class="pay-actions">
                            ${isPaid
                        ? `<button class="pay-btn-small pay-btn-due" onclick="markPaymentStatus('${student.id}', 'due')" title="ডিউ মার্ক করুন"><i class="fas fa-times"></i></button>`
                        : `<button class="pay-btn-small pay-btn-paid" onclick="markPaymentStatus('${student.id}', 'paid')" title="পেইড মার্ক করুন"><i class="fas fa-check"></i></button>
                                   <button class="pay-btn-small pay-btn-remind" onclick="sendReminder('${student.id}')" title="রিমাইন্ডার"><i class="fas fa-bell"></i></button>`
                    }
                        </div>
                    `;

                if (isPaid) {
                    paidList.appendChild(card);
                    paidCount++;
                } else {
                    dueList.appendChild(card);
                    dueCount++;
                }
            });

            document.getElementById('payTotalCount').innerText = convertToBengaliDigit(students.length);
            document.getElementById('payPaidCount').innerText = convertToBengaliDigit(paidCount);
            document.getElementById('payDueCount').innerText = convertToBengaliDigit(dueCount);

            // Re-apply searches if any
            filterPaymentList('paid', paymentSearchQueries.paid);
            filterPaymentList('due', paymentSearchQueries.due);
        }

        function markPaymentStatus(uid, status) {
            const month = document.getElementById('payMonthSelector').value;
            const year = new Date().getFullYear();
            const path = `payments/${month}_${year}/${uid}`;

            const student = allUsers[uid];
            const amount = 1000; // Default or could be dynamic
            const dateStr = new Date().toLocaleDateString('bn-BD', { day: '2-digit', month: 'long' });

            const data = status === 'paid'
                ? { status: 'paid', amount: amount, date: dateStr, timestamp: Date.now() }
                : { status: 'due', amount: amount, timestamp: Date.now() };

            db.ref(path).set(data).then(() => {
                showToast(`${student.name}-কে ${status === 'paid' ? 'পেইড' : 'ডিউ'} মার্ক করা হয়েছে!`, status === 'paid' ? 'success' : 'info');
                loadPaymentData(); // Refresh
            });
        }

        function filterPaymentList(type, query) {
            paymentSearchQueries[type] = query.toLowerCase().trim();
            const list = document.getElementById(type === 'paid' ? 'payPaidList' : 'payDueList');
            const cards = list.querySelectorAll('.pay-student-card');

            cards.forEach(card => {
                const name = card.dataset.name;
                const id = card.dataset.id;
                if (name.includes(paymentSearchQueries[type]) || id.includes(paymentSearchQueries[type])) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function sendReminder(uid) {
            const student = allUsers[uid];
            showToast(`${student.name}-কে ইমেইল রিমাইন্ডার পাঠানো হচ্ছে...`, 'info');
            setTimeout(() => {
                showToast(`${student.name}-কে রিমাইন্ডার পাঠানো হয়েছে!`, 'success');
            }, 1500);
        }

        function sendBulkReminder() {
            const dueCount = parseInt(document.getElementById('payDueCount').innerText) || 0;
            if (dueCount === 0) return showToast('কোনো ডিউ শিক্ষার্থী নেই!', 'info');

            showToast('সব ডিউ শিক্ষার্থীদের রিমাইন্ডার পাঠানো হচ্ছে...', 'info');
            setTimeout(() => {
                showToast('সবাইকে সফলভাবে রিমাইন্ডার পাঠানো হয়েছে!', 'success');
            }, 2000);
        }

        let availableAttendanceDates = [];

        function changeResetMonth(delta) {
            currentResetMonth += delta;
            if (currentResetMonth > 11) {
                currentResetMonth = 0;
                currentResetYear++;
            } else if (currentResetMonth < 0) {
                currentResetMonth = 11;
                currentResetYear--;
            }
            renderResetCalendar();
        }

        function closeResetModal() {
            document.getElementById('attendanceResetModal').style.display = 'none';
        }

        function openResetModal() {
            const now = new Date();
            currentResetMonth = now.getMonth();
            currentResetYear = now.getFullYear();
            selectedResetDates = [];

            // Fetch available dates from DB to highlight
            db.ref('attendance').once('value').then(snapshot => {
                const data = snapshot.val() || {};
                availableAttendanceDates = Object.keys(data);
                document.getElementById('attendanceResetModal').style.display = 'flex';
                renderResetCalendar();
            });
        }

        function selectAllDates() {
            const daysInMonth = new Date(currentResetYear, currentResetMonth + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentResetYear}-${(currentResetMonth + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                if (!selectedResetDates.includes(dateStr)) {
                    selectedResetDates.push(dateStr);
                }
            }
            renderResetCalendar();
        }

        function renderResetCalendar() {
            const grid = document.getElementById('resetCalendarGrid');
            const monthYearText = document.getElementById('calendarMonthYear');
            const months = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];

            monthYearText.innerText = `${months[currentResetMonth]} ${convertToBengaliDigit(currentResetYear)}`;

            grid.innerHTML = '';
            const days = ['রবি', 'সোম', 'মঙ্গল', 'বুধ', 'বৃহঃ', 'শুক্র', 'শনি'];
            days.forEach(d => {
                const el = document.createElement('div');
                el.className = 'calendar-day-header';
                el.innerText = d;
                el.style.fontWeight = '500';
                grid.appendChild(el);
            });

            const firstDay = new Date(currentResetYear, currentResetMonth, 1).getDay();
            const daysInMonth = new Date(currentResetYear, currentResetMonth + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const el = document.createElement('div');
                el.className = 'calendar-date empty';
                grid.appendChild(el);
            }

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentResetYear}-${(currentResetMonth + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                const el = document.createElement('div');
                el.className = 'calendar-date';
                if (dateStr === todayStr) el.classList.add('today');
                if (selectedResetDates.includes(dateStr)) el.classList.add('selected');
                if (availableAttendanceDates.includes(dateStr)) el.classList.add('has-data');

                el.innerText = convertToBengaliDigit(d);
                el.onclick = () => toggleResetDate(dateStr);
                grid.appendChild(el);
            }

            updateSelectedCount();
        }

        function toggleResetDate(dateStr) {
            const idx = selectedResetDates.indexOf(dateStr);
            if (idx > -1) {
                selectedResetDates.splice(idx, 1);
            } else {
                selectedResetDates.push(dateStr);
            }
            renderResetCalendar();
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selectedDatesCount');
            const btn = document.getElementById('btnConfirmDelete');
            if (selectedResetDates.length === 0) {
                countEl.innerText = 'কোনো তারিখ সিলেক্ট করা হয়নি';
                countEl.style.color = 'var(--text-muted)';
                btn.disabled = true;
            } else {
                countEl.innerText = `${convertToBengaliDigit(selectedResetDates.length)} টি তারিখ সিলেক্ট করা হয়েছে`;
                countEl.style.color = 'var(--danger)';
                btn.disabled = false;
            }
        }

        async function lifetimeReset() {
            const conf1 = window.confirm("সাবধান! আপনি কি লাইফটাইম সমস্ত অ্যাটেন্ডেন্স হিস্ট্রি মুছে ফেলে সবকিছু 'শুন্য' (০) করতে চান?");
            if (!conf1) return;

            const conf2 = window.confirm("আপনি কি নিশ্চিত? এটি আর ফিরিয়ে আনা সম্ভব নয়। সকল ডাটা চিরতরে মুছে যাবে।");
            if (!conf2) return;

            try {
                await db.ref('attendance').remove();
                proAttData = {};
                renderProAttendance();
                showToast("সমস্ত ইতিহাস সফলভাবে রিসেট করা হয়েছে", "success");
                closeResetModal();
                renderReportBreakdown();
            } catch (err) {
                showToast("সম্পূর্ণ রিসেট ব্যর্থ: " + err.message, "danger");
            }
        }

        async function processBatchDelete() {
            if (selectedResetDates.length === 0) return;

            const confirmFinal = window.confirm(`আপনি কি নিশ্চিত যে আপনি এই ${convertToBengaliDigit(selectedResetDates.length)} দিনের সকল ডাটা মুছে ফেলতে চান? এটি আর ফিরিয়ে আনা সম্ভব নয়।`);
            if (!confirmFinal) return;

            const btn = document.getElementById('btnConfirmDelete');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ডিলিট হচ্ছে...';
            btn.disabled = true;

            try {
                const currentSelectedDate = document.getElementById('proAttDate').value;
                const isTodayDeleted = selectedResetDates.includes(currentSelectedDate);

                const deletions = selectedResetDates.map(date => db.ref('attendance/' + date).remove());
                await Promise.all(deletions);

                showToast(`${convertToBengaliDigit(selectedResetDates.length)} দিনের ডাটা মুছে ফেলা হয়েছে`, 'success');

                if (isTodayDeleted) {
                    proAttData = {};
                    renderProAttendance();
                }

                selectedResetDates = [];
                closeResetModal();
                renderReportBreakdown();
            } catch (err) {
                showToast("রিসেট ব্যর্থ: " + err.message, "danger");
            } finally {
                btn.innerHTML = originalText;
            }
        }

        function toggleSearch(type) {
            const input = document.getElementById(type === 'present' ? 'searchPresent' : 'searchAbsent');
            input.classList.toggle('hidden');
            if (!input.classList.contains('hidden')) input.focus();
        }

        function filterFolder(type, query) {
            const container = document.getElementById(type === 'present' ? 'proPresentFolder' : 'proAbsentFolder');
            const cards = container.getElementsByClassName('pro-att-student-card');
            const q = query.toLowerCase();

            Array.from(cards).forEach(card => {
                const name = card.dataset.name ? card.dataset.name.toLowerCase() : "";
                card.style.display = name.includes(q) ? 'flex' : 'none';
            });
        }

        // Keep showGenderStats as a simple wrapper or remove if browser says it's unused
        function showGenderStats(type) { toggleGenderBreakdown(type); }

        function togglePercentBreakdown() {
            const container = document.getElementById('proAttPercentBreakdown');
            const percCard = document.querySelector('.pro-att-stat-card.percentage');
            const detailedContainer = document.getElementById('proAttDetailedBreakdown');
            const reportContainer = document.getElementById('proAttReportBreakdown');

            // Hide other breakdowns
            detailedContainer.classList.add('hidden');
            reportContainer.classList.add('hidden');

            if (!container.classList.contains('hidden')) {
                container.classList.add('hidden');
                percCard.style.border = '';
            } else {
                container.classList.remove('hidden');
                percCard.style.border = '2px dashed var(--warning)';
                renderPercentBreakdown();
            }
        }

        function toggleReportSearch(event) {
            // If event exists and clicking the input while active, don't close
            if (event && event.target.id === 'reportSearchInput') return;

            const container = document.getElementById('reportSearchContainer');
            const input = document.getElementById('reportSearchInput');
            const icon = document.getElementById('reportSearchIcon');

            const isOpening = !container.classList.contains('active');
            container.classList.toggle('active');

            if (isOpening) {
                setTimeout(() => input.focus(), 300);
                icon.className = 'fas fa-arrow-right';
            } else {
                input.value = '';
                filterReportStudents('');
                icon.className = 'fas fa-search';
            }
        }

        function filterReportStudents(query) {
            const cards = document.querySelectorAll('.report-student-card');
            const q = query.toLowerCase().trim();

            cards.forEach(card => {
                const name = card.querySelector('h5').innerText.toLowerCase();
                const id = card.querySelector('p').innerText.toLowerCase();

                if (name.includes(q) || id.includes(q)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function toggleReportBreakdown() {
            const reportContainer = document.getElementById('proAttReportBreakdown');
            const detailedContainer = document.getElementById('proAttDetailedBreakdown');
            const percentContainer = document.getElementById('proAttPercentBreakdown');
            const statsCards = document.querySelectorAll('.pro-att-stat-card');

            // Close others
            detailedContainer.classList.add('hidden');
            percentContainer.classList.add('hidden');

            if (!reportContainer.classList.contains('hidden')) {
                reportContainer.classList.add('hidden');
            } else {
                reportContainer.classList.remove('hidden');
                renderReportBreakdown();
            }
        }

        async function renderReportBreakdown() {
            const content = document.getElementById('reportBreakdownContent');
            content.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><div class="loader"></div><p style="margin-top:10px; color:var(--text-muted)">রিপোর্ট তৈরি হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...</p></div>';

            try {
                const snapshot = await db.ref('attendance').once('value');
                const allAttendance = snapshot.val() || {};
                const currentSelectedDate = document.getElementById('proAttDate').value;

                // Use local proAttData for the currently selected date to ensure "LIVE" update feeel
                allAttendance[currentSelectedDate] = proAttData;

                const dates = Object.keys(allAttendance).filter(d => {
                    // Regex for YYYY-MM-DD
                    const isDate = /^\d{4}-\d{2}-\d{2}$/.test(d);
                    const hasData = allAttendance[d] && typeof allAttendance[d] === 'object' && Object.keys(allAttendance[d]).length > 0;
                    return isDate && hasData;
                });
                const totalClasses = dates.length;

                document.getElementById('totalClassesHeld').innerText = convertToBengaliDigit(totalClasses);

                const students = Object.values(allUsers).filter(u => u.role === 'student' && !u.isBanned && u.isApproved !== false);

                const stats = {};
                students.forEach(s => {
                    stats[s.id] = { present: 0, absent: 0 };
                });

                dates.forEach(date => {
                    const dayData = allAttendance[date];
                    students.forEach(s => {
                        if (dayData[s.id] === true) {
                            stats[s.id].present++;
                        } else {
                            stats[s.id].absent++;
                        }
                    });
                });

                content.innerHTML = '';
                if (students.length === 0) {
                    content.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">কোনো শিক্ষার্থী খুঁজে পাওয়া যায়নি।</div>';
                    return;
                }

                students.forEach(student => {
                    const sData = stats[student.id];
                    const presentPerc = totalClasses > 0 ? Math.round((sData.present / totalClasses) * 100) : 0;
                    const absentPerc = totalClasses > 0 ? (100 - presentPerc) : 0;
                    const avatar = student.img || (student.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');

                    const card = document.createElement('div');
                    card.className = 'report-student-card';
                    card.innerHTML = `
                        <div class="report-card-top">
                            <img src="${avatar}">
                            <div class="report-card-name">
                                <h5>${student.name}</h5>
                                <p>${student.id.replace(/_/g, '.')}</p>
                            </div>
                        </div>
                        <div class="report-card-stats-v2">
                            <div class="stat-item-v2 present">
                                <span class="label">উপস্থিত</span>
                                <span class="value">${convertToBengaliDigit(sData.present)}</span>
                            </div>
                            <div class="stat-item-v2 absent">
                                <span class="label">অনুপস্থিত</span>
                                <span class="value">${convertToBengaliDigit(sData.absent)}</span>
                            </div>
                        </div>
                        <div class="report-card-progress-v2">
                            <div class="progress-header-v2">
                                <span class="progress-title-v2">উপস্থিত: ${convertToBengaliDigit(presentPerc)}% | অনুপস্থিত: ${convertToBengaliDigit(absentPerc)}%</span>
                                <span class="progress-percent-v2">${convertToBengaliDigit(presentPerc)}%</span>
                            </div>
                            <div class="progress-track-v2">
                                <div class="progress-fill-v2 present" style="width: ${presentPerc}%"></div>
                                <div class="progress-fill-v2 absent" style="width: ${absentPerc}%"></div>
                            </div>
                        </div>
                        <div class="growth-indicator">
                            <i class="fas fa-chart-line"></i>
                            <span>${presentPerc >= 80 ? 'অসাধারণ প্রগ্রেস!' : presentPerc >= 50 ? 'ভালো প্রগ্রেস, চালিয়ে যাও।' : 'মনোযোগ বাড়ানো প্রয়োজন।'}</span>
                        </div>
                    `;
                    content.appendChild(card);
                });

            } catch (error) {
                console.error("Report generation failed:", error);
                content.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--danger); padding: 20px;">রিপোর্ট লোড করতে ব্যর্থ হয়েছে।</div>';
            }
        }

        // History and Report modal functions removed

        function exportProAttendance() { alert('Exporting data as CSV...'); }

        document.addEventListener('contextmenu', event => event.preventDefault());

        /* --- LIVE ATTENDANCE SYSTEM --- */
        let isLiveAttendanceActive = false;
        let liveSessionData = null;

        function toggleLiveAttendance() {
            const btn = document.getElementById('btn-live-attendance');
            let dateVal = document.getElementById('proAttDate').value; // Use selected date
            if (!dateVal) {
                dateVal = new Date().toLocaleDateString('en-CA');
                document.getElementById('proAttDate').value = dateVal;
            }
            const today = dateVal;

            if (isLiveAttendanceActive) {
                // Stop Session
                if (confirm("Live Attendance বন্ধ করতে চান?")) {
                    db.ref('system_config/attendance_session').set({
                        isActive: false,
                        date: today,
                        timestamp: Date.now()
                    });
                    showToast("Live Attendance বন্ধ করা হয়েছে!", "info");
                }
            } else {
                // Start Session
                if (confirm("আজকের ক্লাসের লাইভ অ্যাটেন্ডেন্স শুরু করতে চান?")) {
                    db.ref('system_config/attendance_session').set({
                        isActive: true,
                        date: today,
                        startTime: Date.now()
                    });
                    showToast("Live Attendance শুরু হয়েছে!", "success");
                }
            }
        }

        // Listen for Session State
        if (typeof db !== 'undefined') {
            db.ref('system_config/attendance_session').on('value', snapshot => {
                const data = snapshot.val();
                liveSessionData = data;
                const btn = document.getElementById('btn-live-attendance');

                if (data && data.isActive) {
                    isLiveAttendanceActive = true;
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-broadcast-tower"></i> Live Now';
                        btn.classList.add('btn-live-active');
                    }
                    const kBtn = document.getElementById('btn-student-attendance');
                    if (kBtn) {
                        kBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> লাইভ অ্যাটেন্ডেন্স দিন';
                        kBtn.style.color = "var(--danger)";
                        kBtn.style.fontWeight = "bold";
                        kBtn.classList.add('pulse-animation');
                    }
                } else {
                    isLiveAttendanceActive = false;
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-wifi"></i> Live';
                        btn.classList.remove('btn-live-active');
                    }
                    const kBtn = document.getElementById('btn-student-attendance');
                    if (kBtn) {
                        kBtn.innerHTML = '<i class="fas fa-user-check"></i> অ্যাটেন্ডেন্স দিন';
                        kBtn.style.color = "";
                        kBtn.style.fontWeight = "";
                        kBtn.classList.remove('pulse-animation');
                    }
                }
            });
        }

        function checkAttendanceSession() {
            const modal = document.getElementById('selfAttendanceModal');
            const dateEl = document.getElementById('att-session-date');

            if (isLiveAttendanceActive && liveSessionData) {
                const sessionDate = liveSessionData.date;
                // Check if already submitted
                if (currentUser) {
                    db.ref(`attendance/${sessionDate}/${currentUser.id}`).once('value', snapshot => {
                        if (snapshot.exists() && snapshot.val() === true) {
                            showToast("আপনি ইতিমধ্যে আজকের অ্যাটেন্ডেন্স দিয়েছেন!", "success");
                        } else {
                            dateEl.innerText = `তারিখ: ${sessionDate}`;
                            modal.style.display = 'flex';
                        }
                    });
                }
            } else {
                showToast("বর্তমানে কোনো লাইভ অ্যাটেন্ডেন্স সেশন চালু নেই।", "warning");
            }
        }

        function closeSelfAttendance() {
            document.getElementById('selfAttendanceModal').style.display = 'none';
        }

        /* --- Student Activity Monitor Logic --- */
        let selectedMonitorUid = null;
        let monitorFilterDays = 1;

        function loadActivityMonitor() {
            if (!currentUser) return;

            // ROLE-BASED LOGIC
            const sidebar = document.querySelector('.monitor-sidebar');
            const mainContent = document.querySelector('.monitor-main');
            const placeholder = document.getElementById('monitor-placeholder');
            const statsGrid = document.querySelector('.monitor-main .monitor-filters + div'); // The stats grid

            if (currentUser.role === 'student') {
                // Hide sidebar for students
                if (sidebar) sidebar.style.display = 'none';
                if (mainContent) mainContent.style.width = '100%';

                // Auto-load student's own data
                viewStudentActivity(currentUser.id);
            } else {
                // Show everything for admin/teacher
                if (sidebar) sidebar.style.display = 'flex';
                if (mainContent) mainContent.style.width = '';

                renderMonitorStudentList();
                placeholder.classList.remove('hidden');
                document.getElementById('monitor-content').classList.add('hidden');
            }
        }

        function renderMonitorStudentList() {
            const list = document.getElementById('monitor-student-list');
            const search = document.getElementById('monitor-search').value.toLowerCase().trim();
            list.innerHTML = '';

            const students = Object.values(allUsers).filter(u =>
                u.role === 'student' &&
                (u.name.toLowerCase().includes(search) || u.id.replace(/_/g, '.').includes(search))
            );

            if (students.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">কোনো শিক্ষার্থী পাওয়া যায়নি</div>';
                return;
            }

            students.forEach(u => {
                const avatar = u.img || (u.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
                const isOnline = (Date.now() - (u.lastSeen || 0)) < 12000;
                const isActive = isOnline;

                const div = document.createElement('div');
                div.className = `monitor-student-item ${selectedMonitorUid === u.id ? 'active' : ''}`;
                div.onclick = () => viewStudentActivity(u.id);
                div.innerHTML = `
                    <div style="position: relative;">
                        <img src="${avatar}" style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid ${isActive ? 'var(--success)' : 'transparent'};">
                        <span style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${isActive ? 'var(--success)' : '#94a3b8'}; border: 2px solid var(--card-bg);"></span>
                    </div>
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main);">${u.name}</div>
                        <div style="font-size: 11px; color: ${isActive ? 'var(--success)' : 'var(--text-muted)'}; font-weight: 500;">
                            ${isActive ? '<i class="fas fa-circle" style="font-size: 8px;"></i> Active Now' : '<i class="far fa-clock"></i> Offline'}
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        let monitorRealtimeRef = null;

        async function viewStudentActivity(uid) {
            selectedMonitorUid = uid;
            renderMonitorStudentList(); // Refresh selection UI in sidebar

            const initialStudent = allUsers[uid];
            if (!initialStudent) return;

            document.getElementById('monitor-placeholder').classList.add('hidden');
            const content = document.getElementById('monitor-content');
            content.classList.remove('hidden');

            // Show loader initially
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; padding: 100px 0;">
                    <div class="loader"></div>
                    <p style="color: var(--text-muted);">লোড হচ্ছে...</p>
                </div>
            `;

            // Clean up previous listener
            if (monitorRealtimeRef) monitorRealtimeRef.off();

            try {
                // High-performance single listener for everything related to this student
                monitorRealtimeRef = db.ref(`users/${uid}`);
                monitorRealtimeRef.on('value', snapshot => {
                    const updatedStudent = snapshot.val();
                    if (selectedMonitorUid === uid && updatedStudent) {
                        const logs = updatedStudent.studyLogs || {};
                        renderActivityDetails(updatedStudent, logs);
                    }
                });
            } catch (err) {
                content.innerHTML = `<div style="color: var(--danger); text-align: center; padding: 20px;">ত্রুটি: ${err.message}</div>`;
            }
        }

        function setMonitorFilter(days) {
            monitorFilterDays = days;
            const uid = selectedMonitorUid;
            if (uid) viewStudentActivity(uid);
        }

        function getRelativeTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return "এইমাত্র";
            if (minutes < 60) return convertToBengaliDigit(minutes) + " মিনিট আগে";
            if (hours < 24) return convertToBengaliDigit(hours) + " ঘণ্টা আগে";
            return convertToBengaliDigit(days) + " দিন আগে";
        }

        const subjectThemes = {
            "পদার্থবিজ্ঞান": { icon: "fas fa-atom", color: "#6366f1" },
            "রসায়ন": { icon: "fas fa-flask", color: "#10b981" },
            "জীববিজ্ঞান": { icon: "fas fa-dna", color: "#f43f5e" },
            "উচ্চতর গণিত": { icon: "fas fa-calculator", color: "#8b5cf6" },
            "বাংলা": { icon: "fas fa-pen-nib", color: "#f59e0b" },
            "ইংরেজি": { icon: "fas fa-font", color: "#0ea5e9" },
            "ICT": { icon: "fas fa-laptop-code", color: "#ec4899" }
        };

        function renderActivityDetails(student, logs) {
            const content = document.getElementById('monitor-content');
            const avatar = student.img || (student.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');

            const formatDate = (ts, includeTime = true) => {
                if (!ts) return null;
                const date = new Date(ts);
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                if (includeTime) { options.hour = '2-digit'; options.minute = '2-digit'; }
                return date.toLocaleString('bn-BD', options);
            };

            const lastLoginStr = formatDate(student.lastLogin) || 'শিক্ষার্থী এখনো যুক্ত হননি';
            const lastActiveStr = formatDate(student.lastSeen) || 'অজানা';
            const isActive = (Date.now() - (student.lastSeen || 0)) < 12000;

            const filterTime = Date.now() - (monitorFilterDays * 24 * 60 * 60 * 1000);
            const rawLogs = Object.values(logs);
            let filteredLogs = rawLogs.filter(log => log.timestamp >= filterTime).sort((a, b) => b.timestamp - a.timestamp);

            let totalStudyTime = 0;
            const subjectStats = { "পদার্থবিজ্ঞান": 0, "রসায়ন": 0, "জীববিজ্ঞান": 0, "উচ্চতর গণিত": 0, "বাংলা": 0, "ইংরেজি": 0, "ICT": 0 };

            // Process existing logs
            filteredLogs.forEach(log => {
                const duration = log.duration || 0;
                totalStudyTime += duration;
                if (log.subject && subjectStats.hasOwnProperty(log.subject)) {
                    subjectStats[log.subject] += duration;
                }
            });

            // NEW: Handle Live Session (Active right now)
            let liveSessionHtml = '';
            if (student.activeSession && student.activeSession.startTime) {
                const liveDuration = Math.floor((Date.now() - student.activeSession.startTime) / 1000);
                if (liveDuration > 0) {
                    totalStudyTime += liveDuration;
                    if (subjectStats.hasOwnProperty(student.activeSession.subject)) {
                        subjectStats[student.activeSession.subject] += liveDuration;
                    }

                    const theme = subjectThemes[student.activeSession.subject] || { icon: "fas fa-book", color: "var(--primary)" };
                    const startTimeStr = new Date(student.activeSession.startTime).toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });

                    liveSessionHtml = `
                        <div class="monitor-timeline-item" style="background: rgba(34, 197, 94, 0.05); padding: 18px; border-radius: 18px; border: 1px dashed var(--success); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: 4px; background: var(--success);"></div>
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div style="background: ${theme.color}20; color: ${theme.color}; width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                                    <i class="${theme.icon}"></i>
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="font-weight: 700; color: var(--text-main); font-size: 16px;">${student.activeSession.subject}</div>
                                        <span class="pulse-status" style="background: var(--success); color: white; font-size: 9px; padding: 2px 8px; border-radius: 20px; font-weight: 800;">LIVE NOW</span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span><i class="far fa-clock" style="margin-right: 4px;"></i> ${startTimeStr} - চলমান</span>
                                        <span style="color: ${theme.color}; font-weight: 600;">• আজ</span>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--success); font-family: 'Poppins'; font-weight: 800; font-size: 18px;">${formatTime(liveDuration)}</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">এইমাত্র শুরু হয়েছে</div>
                            </div>
                        </div>
                    `;
                }
            }

            const sortedSubjects = Object.entries(subjectStats).sort((a, b) => b[1] - a[1]);

            content.innerHTML = `
                <div style="padding-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 30px; flex-wrap: wrap;">
                        <div style="position: relative;">
                            <img src="${avatar}" style="width: 85px; height: 85px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover;">
                            <span style="position: absolute; bottom: 5px; right: 5px; width: 18px; height: 18px; border-radius: 50%; background: ${isActive ? 'var(--success)' : '#94a3b8'}; border: 3px solid var(--card-bg);"></span>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 5px;">
                                <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-main);">${student.name}</h2>
                                ${isActive ? '<span class="pulse-status" style="background: var(--success); color: white; font-size: 9px; padding: 2px 8px; border-radius: 20px; font-weight: 800;">LIVE</span>' : ''}
                            </div>
                            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;"><i class="fas fa-envelope"></i> ${student.id.replace(/_/g, '.')}</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    <i class="fas fa-sign-in-alt" style="color: var(--primary); width: 14px;"></i> শেষ লগইন: <span style="color: var(--text-main); font-weight: 600;">${lastLoginStr}</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted);">
                                    <i class="fas fa-history" style="color: var(--warning); width: 14px;"></i> শেষ এক্টিভ: <span style="color: var(--text-main); font-weight: 600;">${lastActiveStr}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-filters">
                        <button class="time-filter-btn ${monitorFilterDays === 1 ? 'active' : ''}" onclick="setMonitorFilter(1)">২৪ ঘণ্টা</button>
                        <button class="time-filter-btn ${monitorFilterDays === 7 ? 'active' : ''}" onclick="setMonitorFilter(7)">৭ দিন</button>
                        <button class="time-filter-btn ${monitorFilterDays === 15 ? 'active' : ''}" onclick="setMonitorFilter(15)">১৫ দিন</button>
                        <button class="time-filter-btn ${monitorFilterDays === 30 ? 'active' : ''}" onclick="setMonitorFilter(30)">১ মাস</button>
                        <button class="time-filter-btn ${monitorFilterDays === 365 ? 'active' : ''}" onclick="setMonitorFilter(365)">লাইফটাইম</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="card" style="background: var(--bg); border: 1px solid var(--border); padding: 20px; border-radius: 18px; display: flex; align-items: center; gap: 18px;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(37, 99, 235, 0.1); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.3rem;"><i class="fas fa-hourglass-start"></i></div>
                            <div>
                                <p style="color: var(--text-muted); font-size: 12px; margin: 0;">মোট পড়াশোনা (${monitorFilterDays === 1 ? '২৪ ঘণ্টা' : monitorFilterDays + ' দিন'})</p>
                                <h2 style="margin: 3px 0 0 0; font-size: 1.4rem; color: var(--primary); font-family: 'Poppins';">${formatTime(totalStudyTime)}</h2>
                            </div>
                        </div>
                        <div class="card" style="background: var(--bg); border: 1px solid var(--border); padding: 20px; border-radius: 18px; display: flex; align-items: center; gap: 18px;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(34, 197, 94, 0.1); display: flex; align-items: center; justify-content: center; color: var(--success); font-size: 1.3rem;"><i class="fas fa-chart-line"></i></div>
                            <div>
                                <p style="color: var(--text-muted); font-size: 12px; margin: 0;">সিলেবাস অগ্রগতি</p>
                                <h2 style="margin: 3px 0 0 0; font-size: 1.4rem; color: var(--success); font-family: 'Poppins';">${student.progress || 0}%</h2>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="background: var(--bg); border: 1px solid var(--border); padding: 25px; border-radius: 20px; margin-bottom: 30px;">
                        <h4 style="margin: 0 0 20px 0; font-size: 1.1rem; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-chart-bar" style="color: var(--primary);"></i> বিষয় ভিত্তিক এনালাইসিস (Subject Analysis)
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 18px;">
                            ${sortedSubjects.map(([sub, time]) => {
                const percentage = totalStudyTime > 0 ? Math.round((time / totalStudyTime) * 100) : 0;
                const theme = subjectThemes[sub] || { icon: "fas fa-book", color: "var(--primary)" };
                return `
                                    <div style="width: 100%;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: center;">
                                            <span style="font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 10px;">
                                                <i class="${theme.icon}" style="color: ${theme.color}; width: 20px; text-align: center;"></i> ${sub}
                                            </span>
                                            <span style="color: var(--text-muted); font-size: 12px;">
                                                <b style="color: ${theme.color}; font-size: 14px;">${formatTime(time)}</b> (${percentage}%)
                                            </span>
                                        </div>
                                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${percentage}%; height: 100%; background: ${theme.color}; border-radius: 10px;"></div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-history" style="color: var(--primary);"></i> এক্টিভিটি টাইমলাইন (Timeline)
                        </h4>
                        <span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">সাফল্য: ${filteredLogs.length + (liveSessionHtml ? 1 : 0)} টি সেশন</span>
                    </div>
                    
                    <div id="activity-timeline" style="display: flex; flex-direction: column; gap: 15px;">
                        ${liveSessionHtml}
                        ${filteredLogs.length > 0 ? filteredLogs.map(log => {
                const theme = subjectThemes[log.subject] || { icon: "fas fa-book", color: "var(--primary)" };
                const logDate = new Date(log.timestamp);
                const timeStr = logDate.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
                const endStr = log.endTime ? new Date(log.endTime).toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' }) : 'চলমান';

                return `
                                <div class="monitor-timeline-item" style="background: var(--bg); padding: 18px; border-radius: 18px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 20px;">
                                        <div style="background: ${theme.color}20; color: ${theme.color}; width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                                            <i class="${theme.icon}"></i>
                                        </div>
                                        <div>
                                            <div style="font-weight: 700; color: var(--text-main); font-size: 16px;">${log.subject}</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                <span><i class="far fa-clock" style="margin-right: 4px;"></i> ${timeStr} - ${endStr}</span>
                                                <span style="color: ${theme.color}; font-weight: 600;">• ${logDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: var(--text-main); font-family: 'Poppins'; font-weight: 700; font-size: 16px;">${formatTime(log.duration || 0)}</div>
                                        <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">${getRelativeTime(log.timestamp)}</div>
                                    </div>
                                </div>
                            `;
            }).join('') : (liveSessionHtml ? '' : `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted); background: rgba(255,255,255,0.02); border-radius: 20px; border: 1px dashed var(--border);">
                                এই ফিল্টারে কোনো এক্টিভিটি পাওয়া যায়নি।
                            </div>
                        `)}
                    </div>
                </div>
            `;
        }

        function loadStudentManagement() {
            renderStudentMgmtList();
            updateSmStats();
        }

        function updateSmStats() {
            const students = Object.values(allUsers).filter(u => u.role === 'student');
            const total = students.length;
            const banned = students.filter(u => u.isBanned).length;

            document.getElementById('sm-total-count').innerText = convertToBengaliDigit(total);
            document.getElementById('sm-banned-count').innerText = convertToBengaliDigit(banned);
        }

        function renderStudentMgmtList() {
            const list = document.getElementById('student-management-list');
            const search = document.getElementById('sm-search').value.toLowerCase().trim();
            currentSmFilter = document.getElementById('sm-filter').value;

            list.innerHTML = '';

            const students = Object.values(allUsers).filter(u => {
                if (u.role !== 'student') return false;

                // Filter
                if (currentSmFilter === 'active' && u.isBanned) return false;
                if (currentSmFilter === 'banned' && !u.isBanned) return false;

                // Search
                return u.name.toLowerCase().includes(search) || u.id.replace(/_/g, '.').includes(search);
            });

            if (students.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">কোনো শিক্ষার্থী খুঁজে পাওয়া যায়নি</div>';
                return;
            }

            students.forEach(u => {
                const avatar = u.img || (u.gender === 'female' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png');
                const isBanned = u.isBanned || false;
                const card = document.createElement('div');
                card.style.cssText = `
                    background: var(--bg);
                    border-radius: 12px;
                    padding: 15px;
                    border: 1px solid var(--border);
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    transition: 0.3s;
                `;

                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="${avatar}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid ${isBanned ? 'var(--danger)' : 'var(--primary)'};">
                        <div style="flex: 1; overflow: hidden;">
                            <h4 style="font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main);">${u.name}</h4>
                            <p style="font-size: 12px; color: var(--text-muted);">${u.id.replace(/_/g, '.')}</p>
                        </div>
                        ${isBanned ? '<span style="font-size: 10px; background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px;">BANNED</span>' : ''}
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 5px;">
                        <button onclick="toggleStudentBan('${u.id}')" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid ${isBanned ? 'var(--success)' : 'var(--warning)'}; background: transparent; color: ${isBanned ? 'var(--success)' : 'var(--warning)'}; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fas ${isBanned ? 'fa-unlock' : 'fa-ban'}"></i> ${isBanned ? 'আনব্যান' : 'ব্যান'}
                        </button>
                        <button onclick="initiateDeleteUser('${u.id}')" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--danger); background: transparent; color: var(--danger); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fas fa-trash"></i> ডিলিট
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function toggleStudentBan(uid) {
            const user = allUsers[uid];
            if (!user) return;

            const newStatus = !user.isBanned;
            const action = newStatus ? "ব্যান" : "আনব্যান";

            // Using a simple custom confirmation could be better, but standard confirm is fast. 
            // User complained about "notification", so likely the result feedback.
            if (confirm(`আপনি কি নিশ্চিত যে আপনি ${user.name}-কে ${action} করতে চান?`)) {
                db.ref('users/' + uid).update({ isBanned: newStatus }).then(() => {
                    showToast(`${user.name}-কে সফলভাবে ${action} করা হয়েছে!`, newStatus ? 'error' : 'success');
                }).catch(err => {
                    showToast("ত্রুটি: " + err.message, "danger");
                });
            }
        }

        let userToDeleteId = null;

        function initiateDeleteUser(uid) {
            const user = allUsers[uid];
            if (!user) return;
            userToDeleteId = uid;
            document.getElementById('del-user-name').innerText = user.name;
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            userToDeleteId = null;
        }

        function confirmDeleteUser() {
            if (!userToDeleteId) return;

            const uid = userToDeleteId;
            const btn = document.querySelector('#deleteConfirmModal button:last-child');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ডিলিট হচ্ছে...';
            btn.disabled = true;

            // Delete from all locations
            const updates = {};
            updates['users/' + uid] = null;
            // Note: Ideally we should clean up attendance/tracker data too but that might be heavy.
            // For now, removing user access (users node) is primary.

            db.ref().update(updates).then(() => {
                showToast("ব্যবহারকারী সফলভাবে ডিলিট করা হয়েছে!", "success");
                closeDeleteModal();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                showToast("ডিলিট ব্যর্থ: " + err.message, "danger");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function submitSelfAttendance() {
            if (!currentUser || !liveSessionData) return;

            const sessionDate = liveSessionData.date;
            const path = `attendance/${sessionDate}/${currentUser.id}`;

            db.ref(path).set(true).then(() => {
                showToast("✅ আপনার উপস্থিতি সফলভাবে গ্রহণ করা হয়েছে!", "success");
                closeSelfAttendance();
            }).catch(err => {
                showToast("ত্রুটি: " + err.message, "danger");
            });
        }

        document.onkeydown = function (e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        };
    </script>


    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;">
            <div
                style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-trash-alt" style="font-size: 35px; color: var(--danger);"></i>
            </div>
            <h2 style="margin-bottom: 10px; color: var(--text-main);">আপনি কি নিশ্চিত?</h2>
            <p style="color: var(--text-muted); margin-bottom: 25px; font-size: 14px;">
                আপনি <span id="del-user-name" style="font-weight: bold; color: var(--text-main);">User Name</span>-কে
                ডিলিট করতে চাচ্ছেন।<br>
                এটি করলে তার সমস্ত ডাটা (প্রগ্রেস, লগ, অ্যাটেন্ডেন্স) চিরতরে মুছে যাবে এবং আর ফিরিয়ে আনা যাবে না।
            </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeDeleteModal()"
                    style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-main); cursor: pointer;">
                    বাতিল করুন
                </button>
                <button onclick="confirmDeleteUser()"
                    style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--danger); color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-trash"></i> ডিলিট করুন
                </button>
            </div>
        </div>
    </div>
</body>
</html>
